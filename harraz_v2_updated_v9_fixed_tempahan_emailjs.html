<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <title>e-PRIhatin PELAJAR</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      max-width: 100%;
    }

    /* iPhone Safe Area Support */
    .main-header {
      padding-top: max(1.2rem, env(safe-area-inset-top));
      padding-left: max(2rem, env(safe-area-inset-left));
      padding-right: max(2rem, env(safe-area-inset-right));
    }

    .main-footer {
      padding-bottom: max(2rem, env(safe-area-inset-bottom));
      padding-left: max(2rem, env(safe-area-inset-left));
      padding-right: max(2rem, env(safe-area-inset-right));
    }

    .chatbot-floating-btn {
      bottom: max(2rem, calc(env(safe-area-inset-bottom) + 1rem));
      right: max(2rem, calc(env(safe-area-inset-right) + 1rem));
    }

    .tutorial-floating-btn {
      bottom: max(6.8rem, calc(env(safe-area-inset-bottom) + 5.5rem));
      right: max(2rem, calc(env(safe-area-inset-right) + 1rem));
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ffd6e7 0%, #ffeef7 100%);
      transition: all 0.3s ease;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(255, 111, 163, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 158, 197, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(255, 214, 231, 0.2) 0%, transparent 50%);
      animation: backgroundFloat 20s ease-in-out infinite;
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 60% 30%, rgba(255, 111, 163, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 30% 70%, rgba(255, 158, 197, 0.1) 0%, transparent 40%);
      animation: backgroundFloat 15s ease-in-out infinite reverse;
      z-index: 0;
      pointer-events: none;
    }

    body.dark-mode {
      background: linear-gradient(135deg, #1a0a1f 0%, #2d1b3d 100%);
      color: #ffffff;
    }

    body.dark-mode::before {
      background: 
        radial-gradient(circle at 20% 50%, rgba(255, 111, 163, 0.25) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 158, 197, 0.25) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(255, 214, 231, 0.3) 0%, transparent 50%);
    }

    body.dark-mode::after {
      background: 
        radial-gradient(circle at 60% 30%, rgba(255, 111, 163, 0.2) 0%, transparent 40%),
        radial-gradient(circle at 30% 70%, rgba(255, 158, 197, 0.2) 0%, transparent 40%);
    }

    .app-wrapper {
      width: 100%;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .main-header {
      width: 100%;
      background: linear-gradient(135deg, #ffd6e7 0%, #ffeef7 100%);
      padding: 1.2rem 2rem;
      box-shadow: 0 4px 20px rgba(255, 111, 163, 0.15);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    body.dark-mode .main-header {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
      box-shadow: 0 4px 20px rgba(255, 111, 163, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .hamburger-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #ff6fa3;
      transition: all 0.3s ease;
      display: none;
    }

    .hamburger-btn:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 8px rgba(255, 111, 163, 0.6));
    }

    .sidebar-toggle-btn {
      position: fixed;
      left: 280px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.4);
      transition: all 0.3s ease;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-toggle-btn:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 111, 163, 0.6);
    }

    .sidebar-wrapper.collapsed ~ .sidebar-toggle-btn {
      left: 80px;
    }

    body.dark-mode .sidebar-toggle-btn {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.6);
    }

    .school-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(255, 111, 163, 0.3);
      animation: bounceIn 1s ease, float 3s ease-in-out infinite;
      transition: transform 0.3s ease;
    }

    .school-logo:hover {
      transform: scale(1.1) rotate(5deg);
      animation: float 3s ease-in-out infinite, glow 1.5s ease-in-out infinite;
    }

    .school-info h1 {
      font-size: 1.5rem;
      color: #ff6fa3;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }

    body.dark-mode .school-info h1 {
      color: #ffb3d9;
      text-shadow: 0 0 10px rgba(255, 111, 163, 0.5);
    }

    .datetime {
      font-size: 0.85rem;
      color: #666;
      font-weight: 400;
    }

    body.dark-mode .datetime {
      color: #ccc;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .lang-toggle, .theme-toggle {
      background: white;
      border: 2px solid #ff6fa3;
      color: #ff6fa3;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .lang-toggle:hover, .theme-toggle:hover {
      background: #ff6fa3;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 111, 163, 0.4);
    }

    body.dark-mode .lang-toggle, body.dark-mode .theme-toggle {
      background: #2d1b3d;
      border-color: #ffb3d9;
      color: #ffb3d9;
    }

    body.dark-mode .lang-toggle:hover, body.dark-mode .theme-toggle:hover {
      background: #ffb3d9;
      color: #1a0a1f;
    }

    .login-btn {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.3);
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 111, 163, 0.5);
    }

    /* Sidebar */
    .sidebar-wrapper {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 280px;
      background: white;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      z-index: 999;
      padding-top: 100px;
      overflow-y: auto;
    }

    body.dark-mode .sidebar-wrapper {
      background: #1a0a1f;
      box-shadow: 4px 0 20px rgba(255, 111, 163, 0.2);
    }

    .sidebar-wrapper.collapsed {
      width: 80px;
    }

    .sidebar-wrapper.mobile-hidden {
      transform: translateX(-100%);
    }

    .sidebar-nav {
      list-style: none;
      padding: 1rem 0;
    }

    .sidebar-item {
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
      font-weight: 500;
    }

    body.dark-mode .sidebar-item {
      color: #fff;
    }

    .sidebar-item:hover {
      background: linear-gradient(90deg, #ffd6e7 0%, transparent 100%);
      color: #ff6fa3;
      padding-left: 2rem;
    }

    body.dark-mode .sidebar-item:hover {
      background: linear-gradient(90deg, #2d1b3d 0%, transparent 100%);
      color: #ffb3d9;
      box-shadow: 0 0 15px rgba(255, 111, 163, 0.3);
    }

    .sidebar-item.active {
      background: linear-gradient(90deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      font-weight: 600;
    }

    .sidebar-icon {
      font-size: 1.5rem;
      min-width: 30px;
      text-align: center;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .sidebar-item:hover .sidebar-icon {
      animation: bounceIn 0.5s ease;
      transform: scale(1.3) rotate(360deg);
    }

    .sidebar-text {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .sidebar-wrapper.collapsed .sidebar-text {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }

    /* Main Content */
    .main-content-wrapper {
      width: calc(100% - 280px);
      margin-left: 280px;
      padding: 2rem;
      transition: all 0.3s ease;
      flex: 1;
      overflow-x: hidden;
    }

    .sidebar-wrapper.collapsed ~ .main-content-wrapper {
      width: calc(100% - 80px);
      margin-left: 80px;
    }

    .content-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 8px 30px rgba(255, 111, 163, 0.15);
      margin-bottom: 2rem;
      animation: slideUp 0.6s ease;
      max-width: 100%;
      overflow-x: hidden;
    }

    body.dark-mode .content-section {
      background: #2d1b3d;
      box-shadow: 0 8px 30px rgba(255, 111, 163, 0.3);
    }

    .content-section.hidden {
      display: none;
    }

    .section-title {
      font-size: 2rem;
      color: #ff6fa3;
      margin-bottom: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideInLeft 0.8s ease;
    }

    .section-title span:first-child {
      display: inline-block;
      animation: bounceIn 1s ease, heartbeat 2s ease-in-out infinite;
    }

    body.dark-mode .section-title {
      color: #ffb3d9;
      text-shadow: 0 0 10px rgba(255, 111, 163, 0.5);
    }

    /* Forms */
    .booking-form {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }

    body.dark-mode .form-label {
      color: #ffb3d9;
    }

    .form-input, .form-select, .form-textarea {
      padding: 0.8rem;
      border: 2px solid #ffd6e7;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
	  color: #333;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    body.dark-mode .form-input, 
    body.dark-mode .form-select, 
    body.dark-mode .form-textarea {
      background: #1a0a1f;
      border-color: #ff6fa3;
      color: white;
    }

    body.dark-mode .form-input::placeholder,
    body.dark-mode .form-select::placeholder,
    body.dark-mode .form-textarea::placeholder {
      color: #999;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #ff6fa3;
      box-shadow: 0 0 15px rgba(255, 111, 163, 0.3);
      transform: scale(1.02);
      animation: glow 2s ease-in-out infinite;
    }

    .form-input:hover, .form-select:hover, .form-textarea:hover {
      border-color: #ff9ec5;
      transform: translateY(-2px);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .submit-btn {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(255, 111, 163, 0.3);
      position: relative;
      overflow: hidden;
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .submit-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .submit-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 30px rgba(255, 111, 163, 0.5);
      animation: glow 1.5s ease-in-out infinite;
    }

    .submit-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* Touch feedback for iOS */
    @media (hover: none) and (pointer: coarse) {
      .submit-btn:active,
      .admin-btn:active,
      .lang-toggle:active,
      .theme-toggle:active,
      .login-btn:active,
      .hamburger-btn:active,
      .sidebar-item:active {
        opacity: 0.7;
        transform: scale(0.98);
      }

      .booking-card:active {
        transform: scale(0.99);
      }
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Bookings List */
    .bookings-list {
      display: grid;
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .booking-card {
      background: linear-gradient(135deg, #fff 0%, #ffeef7 100%);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.15);
      transition: all 0.3s ease;
      max-width: 100%;
      overflow-x: hidden;
      word-wrap: break-word;
      animation: slideInRight 0.6s ease;
      position: relative;
    }

    .booking-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 111, 163, 0.2), transparent);
      transition: left 0.5s;
    }

    .booking-card:hover::before {
      left: 100%;
    }

    body.dark-mode .booking-card {
      background: linear-gradient(135deg, #1a0a1f 0%, #2d1b3d 100%);
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.3);
    }

    .booking-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 12px 35px rgba(255, 111, 163, 0.4);
    }

    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .booking-ref {
      font-weight: 700;
      color: #ff6fa3;
      font-size: 1.1rem;
    }

    .booking-status {
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-completed {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-expired {
      background: #e2e3e5;
      color: #383d41;
    }

    .booking-details {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .detail-row {
      display: flex;
      gap: 0.5rem;
    }

    .detail-label {
      font-weight: 600;
      color: #666;
      min-width: 120px;
    }

    body.dark-mode .detail-label {
      color: #ccc;
    }

    .detail-value {
      color: #333;
    }

    body.dark-mode .detail-value {
      color: #fff;
    }

    /* Admin Panel */
    .admin-panel {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      box-shadow: 0 6px 20px rgba(255, 111, 163, 0.3);
    }

    .admin-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .admin-btn {
      background: white;
      color: #ff6fa3;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* Profile Section */
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
      max-width: 100%;
      overflow-x: hidden;
    }

    .profile-left, .profile-right {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .principal-card {
      background: linear-gradient(135deg, #ffd6e7 0%, #ffeef7 100%);
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      animation: slideInLeft 0.8s ease;
      transition: all 0.4s ease;
    }

    .principal-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 40px rgba(255, 111, 163, 0.3);
    }

    body.dark-mode .principal-card {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
    }

    .principal-photo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      box-shadow: 0 8px 25px rgba(255, 111, 163, 0.3);
      transition: all 0.4s ease;
      animation: bounceIn 1.2s ease;
      cursor: pointer;
    }

    .principal-photo:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 15px 40px rgba(255, 111, 163, 0.6);
      animation: glow 1.5s ease-in-out infinite;
    }

    .info-card {
      background: #f6f6f6;
      padding: 1.5rem;
      border-radius: 15px;
      transition: all 0.4s ease;
      animation: slideInRight 0.8s ease;
      position: relative;
      overflow: hidden;
    }

    .info-card::after {
      content: 'âœ¨';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      animation: sparkle 2s ease-in-out infinite;
    }

    .info-card:hover::after {
      opacity: 1;
    }

    .info-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 8px 25px rgba(255, 111, 163, 0.2);
      background: linear-gradient(135deg, #ffeef7 0%, #fff 100%);
    }

    body.dark-mode .info-card {
      background: #1a0a1f;
    }

    body.dark-mode .info-card:hover {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    body.dark-mode .info-row {
      border-bottom-color: #444;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    /* Footer */
    .main-footer {
      width: 100%;
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      margin-top: auto;
      box-shadow: 0 -4px 20px rgba(255, 111, 163, 0.2);
    }

    body.dark-mode .main-footer {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
      box-shadow: 0 -4px 20px rgba(255, 111, 163, 0.4);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 28px;
      padding: 28px;
      max-width: 760px;
      width: 92%;
      max-height: 88vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.30);
      animation: slideUp 0.3s ease;
    }

    /* Better scrolling for long topic lists */
    .topic-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 94%;
        padding: 20px;
        max-height: 90vh;
      }
      .topic-grid { grid-template-columns: 1fr; }
    }
body.dark-mode .modal-content {
      background: #2d1b3d;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #ff6fa3;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .close-btn:hover {
      color: #ff6fa3;
    }

    /* Loading State */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-20px);
      }
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      10%, 30%, 50%, 70%, 90% {
        transform: translateX(-5px);
      }
      20%, 40%, 60%, 80% {
        transform: translateX(5px);
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 111, 163, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 111, 163, 0.8), 0 0 30px rgba(255, 111, 163, 0.6);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes heartbeat {
      0%, 100% {
        transform: scale(1);
      }
      10%, 30% {
        transform: scale(1.1);
      }
      20%, 40% {
        transform: scale(1);
      }
    }

    @keyframes sparkle {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(0.8);
      }
    }

    @keyframes backgroundFloat {
      0%, 100% {
        transform: translate(0, 0) rotate(0deg);
      }
      25% {
        transform: translate(5%, 5%) rotate(5deg);
      }
      50% {
        transform: translate(0, 10%) rotate(10deg);
      }
      75% {
        transform: translate(-5%, 5%) rotate(5deg);
      }
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(0) translateX(0) scale(1);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100vh) translateX(50px) scale(0);
        opacity: 0;
      }
    }

    /* Particles Container */
    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .particle {
  position: absolute;
  /* saiz bubble besar & random (JS akan override width/height) */
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.35);
  box-shadow: 0 0 25px rgba(255, 255, 255, 0.55);
  animation: particleFloat linear infinite;
  pointer-events: none;
  mix-blend-mode: screen;
}

body.dark-mode .particle {
  background: rgba(255, 179, 217, 0.18);
  box-shadow: 0 0 28px rgba(255, 111, 163, 0.7);
}


    /* iOS Specific Fixes */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-overflow-scrolling: touch;
      }
      
      .form-input, .form-select, .form-textarea {
        font-size: 16px !important;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        border-radius: 12px;
      }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .profile-grid {
        grid-template-columns: 1fr;
      }
      
      .main-content-wrapper {
        width: calc(100% - 280px);
        padding: 1.5rem;
      }
      
      .sidebar-wrapper.collapsed ~ .main-content-wrapper {
        width: calc(100% - 80px);
      }

      .dashboard-stats {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .hamburger-btn {
        display: block;
        padding: 0.5rem;
        min-width: 44px;
        min-height: 44px;
      }

      .sidebar-wrapper {
        transform: translateX(-100%);
        width: 280px;
        z-index: 9999;
      }

      .sidebar-wrapper.mobile-visible {
        transform: translateX(0);
      }

      .main-content-wrapper {
        margin-left: 0;
        width: 100%;
        padding: 1rem;
      }

      .sidebar-wrapper.collapsed ~ .main-content-wrapper {
        margin-left: 0;
        width: 100%;
      }
      
      .content-section {
        padding: 1rem;
        border-radius: 15px;
      }

      .sidebar-toggle-btn {
        display: none;
      }

      .header-left {
        gap: 0.8rem;
      }

      .school-logo {
        width: 40px;
        height: 40px;
      }

      .school-info h1 {
        font-size: 1rem;
      }

      .datetime {
        font-size: 0.7rem;
      }

      .header-right {
        gap: 0.5rem;
      }

      .lang-toggle, .theme-toggle {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
      }

      .login-btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        min-height: 44px;
      }

      .sidebar-item {
        padding: 1.2rem 1.5rem;
        min-height: 56px;
      }

      .admin-btn {
        min-height: 44px;
        padding: 0.7rem 1.2rem;
      }

      .submit-btn {
        min-height: 48px;
        padding: 0.9rem 1.5rem;
      }

      .section-title {
        font-size: 1.3rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .section-title span:first-child {
        font-size: 1.8rem;
      }

      .admin-actions {
        flex-direction: column;
      }

      .admin-btn {
        width: 100%;
      }

      .dashboard-stats {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .stat-card {
        padding: 1.5rem;
      }

      .stat-icon {
        font-size: 2.5rem;
        min-width: 60px;
      }

      .stat-value {
        font-size: 2rem;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1.2rem;
      }

      .dashboard-card-title {
        font-size: 1rem;
      }

      .dashboard-item {
        padding: 0.8rem;
      }

      .profile-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .principal-card {
        padding: 1.5rem;
      }

      .principal-photo {
        width: 120px;
        height: 120px;
      }

      .info-card {
        padding: 1.2rem;
      }

      .booking-form {
        gap: 1.2rem;
      }

      .form-input, .form-select, .form-textarea {
        padding: 0.7rem;
        font-size: 0.9rem;
      }

      .submit-btn {
        padding: 0.9rem 1.5rem;
        font-size: 0.95rem;
      }

      .booking-card {
        padding: 1.2rem;
        border-radius: 12px;
      }

      .booking-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .booking-ref {
        font-size: 1rem;
      }

      .detail-row {
        flex-direction: column;
        gap: 0.3rem;
      }

      .detail-label {
        min-width: auto;
        font-size: 0.85rem;
      }

      .detail-value {
        font-size: 0.9rem;
      }

      .pdf-info-grid {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
        max-height: 85%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal-title {
        font-size: 1.2rem;
      }

      .close-btn {
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .empty-state {
        padding: 2rem;
      }

      .empty-state-icon {
        font-size: 3rem;
      }

      .main-header {
        padding: 1rem 1rem;
      }

      .main-footer {
        padding: 1.5rem;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .main-header {
        padding: 0.8rem;
      }

      .school-info h1 {
        font-size: 0.9rem;
      }

      .datetime {
        display: none;
      }

      .header-right {
        gap: 0.3rem;
      }

      .lang-toggle, .theme-toggle {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }

      .login-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .section-title span:first-child {
        font-size: 1.5rem;
      }

      .stat-card {
        flex-direction: column;
        text-align: center;
        padding: 1.2rem;
      }

      .stat-icon {
        font-size: 2rem;
      }

      .stat-value {
        font-size: 1.8rem;
      }

      .stat-label {
        font-size: 0.85rem;
      }

      .dashboard-card-title {
        font-size: 0.95rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .booking-ref {
        font-size: 0.9rem;
      }

      .booking-status {
        padding: 0.3rem 0.8rem;
        font-size: 0.75rem;
      }

      .detail-label, .detail-value {
        font-size: 0.85rem;
      }

      .admin-btn {
        font-size: 0.85rem;
        padding: 0.6rem 1.2rem;
      }

      .download-pdf-btn {
        font-size: 0.85rem;
        padding: 0.6rem 1.2rem;
      }

      .form-label {
        font-size: 0.9rem;
      }

      .principal-photo {
        width: 100px;
        height: 100px;
      }

      .principal-card h3 {
        font-size: 1.1rem;
      }

      .principal-card p {
        font-size: 0.9rem;
      }

      .info-card h3 {
        font-size: 1rem;
      }

      .info-row {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 360px) {
      .school-logo {
        width: 35px;
        height: 35px;
      }

      .school-info h1 {
        font-size: 0.8rem;
      }

      .header-right {
        flex-wrap: wrap;
      }

      .login-btn {
        width: 100%;
        margin-top: 0.5rem;
      }

      .section-title {
        font-size: 1rem;
      }

      .content-section {
        padding: 0.8rem;
      }

      .booking-card {
        padding: 1rem;
      }

      .stat-value {
        font-size: 1.5rem;
      }
    }

    /* Dashboard Styles */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.4s ease;
      animation: slideUp 0.6s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .stat-card:hover::before {
      left: 100%;
    }

    body.dark-mode .stat-card {
      background: #2d1b3d;
      box-shadow: 0 4px 20px rgba(255, 111, 163, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 15px 40px rgba(255, 111, 163, 0.3);
    }

    .stat-icon {
      font-size: 3rem;
      min-width: 70px;
      text-align: center;
      animation: bounceIn 1s ease, float 3s ease-in-out infinite;
    }

    .stat-content {
      flex: 1;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
      line-height: 1;
      margin-bottom: 0.5rem;
      animation: countUp 1s ease;
    }

    body.dark-mode .stat-value {
      color: #fff;
    }

    .stat-label {
      font-size: 0.95rem;
      color: #666;
      font-weight: 500;
    }

    body.dark-mode .stat-label {
      color: #ccc;
    }

    .stat-card.stat-primary {
      border-left: 5px solid #ff6fa3;
    }

    .stat-card.stat-success {
      border-left: 5px solid #28a745;
    }

    .stat-card.stat-warning {
      border-left: 5px solid #ffc107;
    }

    .stat-card.stat-info {
      border-left: 5px solid #17a2b8;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      animation: slideUp 0.8s ease;
    }

    body.dark-mode .dashboard-card {
      background: #2d1b3d;
      box-shadow: 0 4px 20px rgba(255, 111, 163, 0.2);
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(255, 111, 163, 0.2);
    }

    .dashboard-card-title {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 1.2rem;
      color: #ff6fa3;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #ffd6e7;
      font-weight: 600;
    }

    .dashboard-card-title span:first-child {
      font-size: 1.5rem;
      animation: heartbeat 2s ease-in-out infinite;
    }

    body.dark-mode .dashboard-card-title {
      color: #ffb3d9;
      border-bottom-color: #ff6fa3;
    }

.dashboard-list {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  max-height: 260px;   /* atau 300px */
  overflow-y: auto;    /* ini yang hidupkan scroll */
  padding-right: 4px;
}


    .dashboard-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 12px;
      transition: all 0.3s ease;
      border-left: 3px solid #ff6fa3;
      animation: slideInRight 0.5s ease;
    }

    body.dark-mode .dashboard-item {
      background: #1a0a1f;
      border-left-color: #ffb3d9;
    }

    .dashboard-item:hover {
      transform: translateX(5px);
      background: #ffeef7;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.2);
    }

    body.dark-mode .dashboard-item:hover {
      background: #2d1b3d;
    }

    .dashboard-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .dashboard-item-title {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }

    body.dark-mode .dashboard-item-title {
      color: #fff;
    }

    .dashboard-item-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .dashboard-item-info {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.85rem;
      color: #666;
    }

    body.dark-mode .dashboard-item-info {
      color: #ccc;
    }

    .class-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      background: #f8f9fa;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    body.dark-mode .class-stat-item {
      background: #1a0a1f;
    }

    .class-stat-item:hover {
      background: #ffeef7;
      transform: scale(1.03);
    }

    body.dark-mode .class-stat-item:hover {
      background: #2d1b3d;
    }

    .class-stat-name {
      font-weight: 600;
      color: #333;
    }

    body.dark-mode .class-stat-name {
      color: #fff;
    }

    .class-stat-count {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      min-width: 35px;
      text-align: center;
    }

    @keyframes countUp {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #999;
      animation: fadeIn 1s ease;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
      display: inline-block;
      animation: float 3s ease-in-out infinite;
    }

    .empty-state:hover .empty-state-icon {
      animation: bounceIn 0.8s ease, float 3s ease-in-out infinite;
      opacity: 0.8;
    }

    /* Floating Chatbot Button */
    .chatbot-floating-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 25px rgba(255, 111, 163, 0.5);
      transition: all 0.3s ease;
      z-index: 1000;
      border: none;
      animation: pulse 2s ease-in-out infinite;
    }

    .chatbot-floating-btn:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 10px 35px rgba(255, 111, 163, 0.7);
    }

    .chatbot-floating-btn.hidden {
      display: none;
    }

    body.dark-mode .chatbot-floating-btn {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
      box-shadow: 0 6px 25px rgba(255, 111, 163, 0.7);
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    /* Chatbot Settings in Admin Panel */
    .chatbot-settings {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin-top: 1rem;
    }

    body.dark-mode .chatbot-settings {
      background: #1a0a1f;
    }

    .chatbot-settings h4 {
      color: #ff6fa3;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    body.dark-mode .chatbot-settings h4 {
      color: #ffb3d9;
    }

    @media (max-width: 768px) {
      .chatbot-floating-btn {
        bottom: 1.5rem;
        right: 1.5rem;
        width: 55px;
        height: 55px;
        font-size: 1.6rem;
      }
    }


    /* Floating Tutorial Button */
    .tutorial-floating-btn {
      position: fixed;
      bottom: 6.8rem; /* sits above chatbot */
      right: 2rem;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #6b5bff 0%, #ff6fa3 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 25px rgba(107, 91, 255, 0.35);
      transition: all 0.25s ease;
      z-index: 1000;
      border: none;
    }

    .tutorial-floating-btn:hover {
      transform: translateY(-4px) scale(1.08);
      box-shadow: 0 10px 35px rgba(255, 111, 163, 0.45);
    }

    body.dark-mode .tutorial-floating-btn {
      background: linear-gradient(135deg, #3a2b4a 0%, #1a0a1f 100%);
      box-shadow: 0 6px 25px rgba(255, 111, 163, 0.6);
    }

    @media (max-width: 768px) {
      .tutorial-floating-btn {
        bottom: 6.2rem;
        right: 1.5rem;
        width: 52px;
        height: 52px;
        font-size: 1.45rem;
      }
    }


/* Tutorial Topic Picker */
.tutorial-topic-list{
  display:flex;
  flex-direction:column;
  gap: 0.95rem;
}
.tutorial-topic-group-title{
  margin: 0.15rem 0 0.25rem;
  font-weight: 800;
  color: #444;
  font-size: 0.95rem;
}
body.dark-mode .tutorial-topic-group-title{ color:#e8e8e8; }
.tutorial-topic-grid{
  display:flex;
  gap: 0.75rem;
  flex-wrap:wrap;
}
.tutorial-topic-btn{
  flex: 1;
  min-width: 220px;
  text-align:left;
}
.tutorial-topic-btn .sub{
  display:block;
  margin-top: 0.28rem;
  font-size: 0.85rem;
  opacity: 0.85;
  font-weight: 500;
}

    /* ===========================
       Guided Tutorial / Tour UI
       =========================== */
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.0); /* spotlight handles dimming */
      z-index: 9997;
      display: none;
      pointer-events: auto;
    }

    .tour-overlay.active {
      display: block;
    }

    .tour-spotlight {
      position: fixed;
      top: 0;
      left: 0;
      width: 10px;
      height: 10px;
      border-radius: 16px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      outline: 2px solid rgba(255, 255, 255, 0.75);
      outline-offset: 4px;
      z-index: 9998;
      display: none;
      pointer-events: auto; /* allow click to go next (optional) */
      transition: all 0.22s ease;
      background: rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(1px);
    }

    .tour-spotlight.active {
      display: block;
    }

    .tour-hand {
      position: fixed;
      z-index: 9999;
      display: none;
      font-size: 2.1rem;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,0.35));
      animation: tourHandWiggle 0.9s ease-in-out infinite;
      pointer-events: none;
    }

    .tour-hand.active {
      display: block;
    }

    @keyframes tourHandWiggle {
      0%, 100% { transform: translate(0,0) rotate(-6deg); }
      50% { transform: translate(6px, -6px) rotate(6deg); }
    }

    .tour-helper-panel {
      position: fixed;
      top: 110px;
      right: 20px;
      width: 360px;
      max-width: calc(100vw - 40px);
      background: rgba(255,255,255,0.92);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.18);
      z-index: 10000;
      display: none;
      overflow: hidden;
      backdrop-filter: blur(8px);
    }

    body.dark-mode .tour-helper-panel {
      background: rgba(26, 10, 31, 0.92);
      color: #fff;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      border: 1px solid rgba(255, 179, 217, 0.15);
    }

    .tour-helper-panel.active {
      display: block;
    }

    .tour-helper-header {
      padding: 1rem 1.1rem 0.8rem 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      border-bottom: 1px solid rgba(255, 111, 163, 0.18);
    }

    body.dark-mode .tour-helper-header {
      border-bottom: 1px solid rgba(255, 179, 217, 0.18);
    }

    .tour-helper-identity {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      min-width: 0;
    }

    .tour-helper-avatar {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: #fff;
      font-size: 1.35rem;
      box-shadow: 0 10px 25px rgba(255, 111, 163, 0.35);
      flex: 0 0 auto;
    }

    body.dark-mode .tour-helper-avatar {
      background: linear-gradient(135deg, #2d1b3d 0%, #1a0a1f 100%);
      box-shadow: 0 10px 25px rgba(255, 111, 163, 0.55);
      border: 1px solid rgba(255, 179, 217, 0.22);
    }

    .tour-helper-name {
      font-weight: 800;
      color: #ff2f86;
      line-height: 1.1;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-mode .tour-helper-name {
      color: #ffb3d9;
      text-shadow: 0 0 10px rgba(255, 111, 163, 0.25);
    }

    .tour-helper-subtitle {
      font-size: 0.82rem;
      color: #666;
      margin-top: 0.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-mode .tour-helper-subtitle {
      color: rgba(255,255,255,0.75);
    }

    .tour-helper-close {
      background: rgba(255, 111, 163, 0.12);
      border: none;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: #ff2f86;
      font-size: 1.1rem;
      flex: 0 0 auto;
    }

    .tour-helper-close:hover {
      transform: scale(1.05);
      background: rgba(255, 111, 163, 0.18);
    }

    body.dark-mode .tour-helper-close {
      background: rgba(255, 179, 217, 0.12);
      color: #ffb3d9;
    }

    .tour-helper-body {
      padding: 1rem 1.1rem 1.1rem 1.1rem;
    }

    .tour-step-title {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      color: #2d1b3d;
    }

    body.dark-mode .tour-step-title {
      color: #fff;
    }

    .tour-step-text {
      font-size: 0.92rem;
      line-height: 1.5;
      white-space: pre-line;color: rgba(0,0,0,0.72);
    }

    body.dark-mode .tour-step-text {
      color: rgba(255,255,255,0.82);
    }

    .tour-helper-footer {
      padding: 0.9rem 1.1rem 1.1rem 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      border-top: 1px solid rgba(255, 111, 163, 0.18);
      background: rgba(255, 111, 163, 0.06);
    }

    body.dark-mode .tour-helper-footer {
      border-top: 1px solid rgba(255, 179, 217, 0.18);
      background: rgba(255, 179, 217, 0.08);
    }

    .tour-progress {
      font-size: 0.82rem;
      color: #666;
      font-weight: 600;
    }

    body.dark-mode .tour-progress {
      color: rgba(255,255,255,0.75);
    }

    .tour-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: nowrap;
    }

    .tour-btn {
      border: none;
      border-radius: 14px;
      padding: 0.55rem 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.88rem;
      min-width: 74px;
    }

    .tour-btn.secondary {
      background: rgba(0,0,0,0.08);
      color: rgba(0,0,0,0.75);
    }

    body.dark-mode .tour-btn.secondary {
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
    }

    .tour-btn.primary {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: #fff;
      box-shadow: 0 10px 25px rgba(255, 111, 163, 0.28);
    }

    body.dark-mode .tour-btn.primary {
      background: linear-gradient(135deg, #ff6fa3 0%, #7c4bff 100%);
      box-shadow: 0 10px 25px rgba(255, 111, 163, 0.38);
    }

    .tour-btn:hover {
      transform: translateY(-1px);
    }

    .tour-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    /* Mobile: move helper to bottom sheet */
    @media (max-width: 640px) {
      .tour-helper-panel {
        right: 12px;
        left: 12px;
        width: auto;
        top: auto;
        bottom: 12px;
      }
    }

    /* PDF Report Styles */
    .pdf-report-container {
      width: 100%;
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.8s ease;
    }

    .pdf-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 3px solid #ff6fa3;
    }

    .pdf-school-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.3);
    }

    .pdf-school-name {
      font-size: 1.8rem;
      color: #ff6fa3;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .pdf-report-title {
      font-size: 2.2rem;
      color: #333;
      font-weight: 700;
      margin: 1.5rem 0;
    }

    .pdf-report-date {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .pdf-content {
      margin: 2rem 0;
    }

    .pdf-section {
      margin-bottom: 2rem;
    }

    .pdf-section-title {
      font-size: 1.4rem;
      color: #ff6fa3;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #ffd6e7;
    }

    .pdf-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .pdf-info-item {
      background: #f6f6f6;
      padding: 1rem;
      border-radius: 10px;
    }

    .pdf-info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }

    .pdf-info-value {
      color: #333;
      font-size: 1rem;
    }

    .pdf-images-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 2rem 0;
    }

    .pdf-image-item {
      aspect-ratio: 1;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .pdf-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .pdf-signatures {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      margin-top: 3rem;
      padding-top: 2rem;
    }

    .pdf-signature-box {
      text-align: center;
    }

    .pdf-signature-line {
      border-top: 2px solid #333;
      margin: 3rem 0 0.5rem 0;
      padding-top: 0.5rem;
    }

    .pdf-signature-label {
      font-weight: 600;
      color: #666;
      font-size: 0.95rem;
    }

    .pdf-footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 2px solid #ffd6e7;
      color: #999;
      font-size: 0.9rem;
    }

    .download-pdf-btn {
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 111, 163, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .download-pdf-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 111, 163, 0.5);
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
      }

      .main-header,
      .sidebar-wrapper,
      .main-footer,
      .admin-panel,
      .download-pdf-btn,
      .close-btn,
      .admin-btn,
      button {
        display: none !important;
      }

      .pdf-report-container {
        box-shadow: none;
        max-width: 100%;
        margin: 0;
        padding: 1rem;
      }

      .pdf-content {
        page-break-inside: avoid;
      }

      .pdf-section {
        page-break-inside: avoid;
      }

      @page {
        margin: 1cm;
      }
    }

    /* Success Message */
    .success-message {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      display: none;
      animation: bounceIn 0.8s ease;
      position: relative;
      overflow: hidden;
    }

    .success-message::before {
      content: 'ðŸŽ‰';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 2rem;
      animation: float 2s ease-in-out infinite;
    }

    .success-message::after {
      content: 'âœ¨';
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 1.5rem;
      animation: sparkle 1.5s ease-in-out infinite;
    }

    .success-message.show {
      display: block;
    }

    body.dark-mode .success-message {
      background: linear-gradient(135deg, #1a4d2e 0%, #163020 100%);
      color: #90ee90;
    }

    .qr-code {
      width: 200px;
      height: 200px;
      margin: 1rem auto;
      background: white;
      padding: 1rem;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #666;
      border: 2px dashed #ff6fa3;
    }
	.form-input[readonly] {
  background: #f3f3f3;
  cursor: not-allowed;
}

body.dark-mode .form-input[readonly] {
  background: #3a2a4a;
}

/* ========== LETAK SCROLLBAR DI SINI ========== */
.dashboard-list::-webkit-scrollbar {
  width: 6px;
}

.dashboard-list::-webkit-scrollbar-track {
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.04);
}
xxxx


xx
.dashboard-list::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #ff9bcf, #ff6fa3);
  border-radius: 999px;
  box-shadow: 0 0 8px rgba(255, 111, 163, 0.6);
}


body.dark-mode .dashboard-list::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.25);
}

body.dark-mode .dashboard-list::-webkit-scrollbar-thumb {
  background: rgba(255, 179, 217, 0.7);
}
/* ================================================ */
  
/* ===== Media Upload & Preview (v3) ===== */
.form-help {
  margin-top: 0.4rem;
  font-size: 0.85rem;
  color: #777;
  line-height: 1.4;
}
.media-preview {
  margin-top: 0.8rem;
  width: 100%;
  max-width: 420px;
  border-radius: 12px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.12);
  display: none;
}
.media-block {
  margin-top: 1rem;
  display: grid;
  gap: 0.75rem;
}
.media-block img {
  width: 100%;
  max-width: 520px;
  border-radius: 12px;
}
.media-block video, .media-block iframe {
  width: 100%;
  max-width: 720px;
  border-radius: 12px;
  background: #000;
}
.media-link-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  padding: 0.55rem 0.9rem;
  border-radius: 12px;
  border: 1px solid rgba(255,111,163,0.35);
  background: rgba(255,111,163,0.12);
  color: #b81f62;
  font-weight: 700;
  text-decoration: none;
  width: fit-content;
}
.media-link-btn:hover { filter: brightness(0.98); }

/* ===== Sick Bay Medicines Card (v3) ===== */
.info-card {
  background: rgba(255,255,255,0.92);
  border-radius: 18px;
  padding: 1.2rem 1.2rem;
  margin: 1rem 0 1.6rem 0;
  box-shadow: 0 6px 28px rgba(0,0,0,0.12);
  border: 1px solid rgba(255,111,163,0.18);
}
.info-card h3 {
  margin: 0;
  color: #5a1b3a;
  font-size: 1.05rem;
}
.medicine-meta {
  margin-top: 0.25rem;
  color: #666;
  font-size: 0.9rem;
}
.medicine-list {
  margin: 0.9rem 0 0 0;
  padding-left: 1.1rem;
  display: grid;
  gap: 0.35rem;
}
.medicine-list li { color: #333; }
.medicine-admin-row {
  display: grid;
  grid-template-columns: 1.4fr 0.8fr 1.2fr auto;
  gap: 0.6rem;
  margin-top: 0.9rem;
  align-items: center;
}
@media (max-width: 640px) {
  .medicine-admin-row { grid-template-columns: 1fr; }
}
.medicine-admin-actions {
  margin-top: 0.8rem;
  display: grid;
  gap: 0.5rem;
}
.medicine-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.8rem;
  padding: 0.5rem 0.7rem;
  background: rgba(255,111,163,0.06);
  border-radius: 12px;
  border: 1px solid rgba(255,111,163,0.12);
}
.medicine-item small { color: #666; }
.medicine-del {
  border: none;
  border-radius: 10px;
  padding: 0.35rem 0.6rem;
  cursor: pointer;
  background: rgba(220,53,69,0.15);
  color: #b00020;
  font-weight: 800;
}


    /* ===== Home Hero Slider (HiAnime-style) ===== */
    .hero-slider{
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: radial-gradient(1200px 400px at 30% 10%, rgba(255,111,163,0.20), transparent 60%),
                  radial-gradient(900px 380px at 80% 80%, rgba(111,203,255,0.14), transparent 55%),
                  #140a18;
      min-height: 260px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.28);
      margin-bottom: 1.2rem;
    }

    .hero-slides{
      position: relative;
      height: clamp(260px, 34vw, 420px);
    }

    .hero-slide{
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 600ms ease;
    }

    .hero-slide.active{
      opacity: 1;
      pointer-events: auto;
    }

    .hero-bg{
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      transform: scale(1.06);
      filter: saturate(1.05) contrast(1.05);
    }

    .hero-slide.active .hero-bg{
      animation: heroKenBurns 7s ease-in-out infinite alternate;
    }

    @keyframes heroKenBurns{
      from { transform: scale(1.06) translate3d(0,0,0); }
      to   { transform: scale(1.14) translate3d(-12px, -8px, 0); }
    }

    .hero-overlay{
      position: absolute;
      inset: 0;
      background:
        linear-gradient(90deg, rgba(0,0,0,0.78) 0%, rgba(0,0,0,0.35) 55%, rgba(0,0,0,0.12) 100%),
        radial-gradient(900px 350px at 20% 20%, rgba(255,111,163,0.22), transparent 60%);
    }

    .hero-content{
      position: relative;
      z-index: 2;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      gap: 0.6rem;
      padding: 1.2rem 1.2rem 1.1rem 1.2rem;
      color: #fff;
      max-width: 720px;
    }

    .hero-tag{
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.16);
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-size: 0.85rem;
      width: fit-content;
      backdrop-filter: blur(10px);
    }

    .hero-title{
      margin: 0;
      font-size: clamp(1.3rem, 2.6vw, 2.1rem);
      font-weight: 800;
      letter-spacing: 0.2px;
      text-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    .hero-excerpt{
      margin: 0;
      color: rgba(255,255,255,0.86);
      line-height: 1.55;
      font-size: clamp(0.95rem, 1.25vw, 1.05rem);
      max-width: 640px;
    }

    .hero-actions{
      display: flex;
      gap: 0.7rem;
      flex-wrap: wrap;
      margin-top: 0.2rem;
    }

    .hero-btn{
      border: none;
      cursor: pointer;
      border-radius: 12px;
      padding: 0.7rem 1rem;
      font-weight: 700;
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      user-select: none;
    }

    .hero-btn:active{ transform: scale(0.98); }

    .hero-btn.primary{
      background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%);
      color: #fff;
      box-shadow: 0 14px 32px rgba(255,111,163,0.25);
    }

    .hero-btn.secondary{
      background: rgba(255,255,255,0.10);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(12px);
    }

    .hero-btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .hero-meta{
      display: flex;
      gap: 0.9rem;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.88rem;
      color: rgba(255,255,255,0.78);
    }

    .hero-nav-btn{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color: #fff;
      cursor: pointer;
      z-index: 3;
      display: grid;
      place-items: center;
      font-size: 1.6rem;
      backdrop-filter: blur(12px);
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .hero-nav-btn:hover{
      background: rgba(0,0,0,0.35);
      transform: translateY(-50%) scale(1.05);
    }

    .hero-prev{ left: 12px; }
    .hero-next{ right: 12px; }

    .hero-dots{
      position: absolute;
      right: 14px;
      bottom: 12px;
      z-index: 3;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .hero-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.18);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease, width 0.2s ease;
    }

    .hero-dot.active{
      width: 26px;
      background: rgba(255,255,255,0.82);
      transform: scale(1.02);
    }

    .home-note{
      margin-top: 0.6rem;
      padding: 0.8rem 1rem;
      border-radius: 14px;
      background: rgba(255, 111, 163, 0.10);
      border: 1px solid rgba(255, 111, 163, 0.18);
    }

    @media (max-width: 768px){
      .hero-content{ padding: 1rem; }
      .hero-nav-btn{ display: none; }
      .hero-dots{ right: 12px; bottom: 10px; }
    }

</style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Floating Particles -->
  <div class="particles-container"></div>
  <div class="app-wrapper"><!-- Header -->
   <header class="main-header">
    <div class="header-left"><button class="hamburger-btn" id="hamburgerBtn">â˜°</button> <img src="" alt="School Logo" class="school-logo" id="schoolLogo" style="display: none;">
     <div class="school-info">
      <h1 id="schoolName">e-PRIhatin PELAJAR</h1>
      <div class="datetime" id="datetime"></div>
     </div>
    </div>
    <div class="header-right">
  <button class="lang-toggle" id="langToggle">EN</button>
  <button class="theme-toggle" id="themeToggle">ðŸŒ™</button>

  <!-- Login Pelajar -->
  <button class="login-btn" id="studentLoginBtn">
    <span id="studentLoginBtnText">Login Pelajar</span>
  </button>

  <!-- Login Admin -->
  <button class="login-btn" id="loginBtn">
    <span id="loginBtnText">Login Admin</span>
  </button>

  <!-- ðŸ‘‡ Teks selamat datang pelajar -->
  <span id="studentWelcomeText" style="font-weight:600; margin-left: 1rem;"></span>
</div>
</header>


   </header><!-- Sidebar -->
   <nav class="sidebar-wrapper" id="sidebar">
    <ul class="sidebar-nav">
     <li class="sidebar-item active" data-section="home"><span class="sidebar-icon">ðŸ </span><span class="sidebar-text" data-ms="Home" data-en="Home">Home</span></li>

     <li class="sidebar-item" data-section="dashboard"><span class="sidebar-icon">ðŸ“Š</span> <span class="sidebar-text" data-ms="Dashboard" data-en="Dashboard">Dashboard</span></li>
     <li class="sidebar-item" data-section="profile"><span class="sidebar-icon">ðŸ‘¤</span> <span class="sidebar-text" data-ms="Profil" data-en="Profile">Profil</span></li>
     <li class="sidebar-item" data-section="announcements"><span class="sidebar-icon">ðŸ“¢</span> <span class="sidebar-text" data-ms="Makluman" data-en="Announcements">Makluman</span></li>
     <li class="sidebar-item" data-section="clinic"><span class="sidebar-icon">ðŸ©º</span> <span class="sidebar-text" data-ms="Tempahan Klinik" data-en="Clinic Booking">Tempahan Klinik</span></li>
     <li class="sidebar-item" data-section="room"><span class="sidebar-icon">ðŸ›ï¸</span> <span class="sidebar-text" data-ms="Tempahan Katil Sakit" data-en="Sick Bed Booking">Tempahan Katil Sakit</span></li>
     <li class="sidebar-item" data-section="programs"><span class="sidebar-icon">ðŸ“…</span> <span class="sidebar-text" data-ms="Program" data-en="Programs">Program</span></li>
     <li class="sidebar-item" data-section="achievements"><span class="sidebar-icon">ðŸ†</span> <span class="sidebar-text" data-ms="Kejayaan" data-en="Achievements">Kejayaan</span></li>
     <li class="sidebar-item" data-section="teachers"><span class="sidebar-icon">ðŸ‘¥</span> <span class="sidebar-text" data-ms="Guru / Pemandu" data-en="Teachers / Drivers">Guru / Pemandu</span></li>
     <li class="sidebar-item" data-section="sharing"><span class="sidebar-icon">ðŸ“¸</span> <span class="sidebar-text" data-ms="Perkongsian" data-en="Sharing">Perkongsian</span></li>
     <li class="sidebar-item" data-section="guestbook"><span class="sidebar-icon">ðŸ“–</span> <span class="sidebar-text" data-ms="Buku Pelawat" data-en="Guest Book">Buku Pelawat</span></li>
    </ul>
   </nav><!-- Sidebar Toggle Button --> <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Toggle Sidebar">â—€</button> <!-- Main Content -->
   <main class="main-content-wrapper">
   <!-- Home Section -->
   <section class="content-section" id="homeSection">
     <h2 class="section-title"><span>ðŸ </span> <span data-ms="Home" data-en="Home">Home</span></h2>

     <div class="hero-slider" id="homeHeroSlider" aria-label="Makluman Slider">
       <div class="hero-slides" id="homeHeroSlides"></div>

       <button class="hero-nav-btn hero-prev" id="homeHeroPrev" type="button" aria-label="Slaid sebelumnya">â€¹</button>
       <button class="hero-nav-btn hero-next" id="homeHeroNext" type="button" aria-label="Slaid seterusnya">â€º</button>

       <div class="hero-dots" id="homeHeroDots" aria-label="Penunjuk slaid"></div>
     </div>

     <div class="home-note">
       <span data-ms="ðŸ“Œ Tip: Makluman terkini akan dipaparkan di sini secara automatik." data-en="ðŸ“Œ Tip: Latest announcements will appear here automatically.">ðŸ“Œ Tip: Makluman terkini akan dipaparkan di sini secara automatik.</span>
     </div>
   </section>

   <!-- Dashboard Section -->
   <section class="content-section" id="dashboardSection">

     <h2 class="section-title"><span>ðŸ“Š</span> <span data-ms="Dashboard" data-en="Dashboard">Dashboard</span></h2>
     <div class="dashboard-stats">
      <div class="stat-card stat-primary">
       <div class="stat-icon">
        ðŸ©º
       </div>
       <div class="stat-content">
        <div class="stat-value" id="statClinicTotal">
         0
        </div>
        <div class="stat-label" data-ms="Tempahan Klinik" data-en="Clinic Bookings">
         Tempahan Klinik
        </div>
       </div>
      </div>
      <div class="stat-card stat-success">
       <div class="stat-icon">
        âœ…
       </div>
       <div class="stat-content">
        <div class="stat-value" id="statConfirmed">
         0
        </div>
        <div class="stat-label" data-ms="Disahkan" data-en="Confirmed">
         Disahkan
        </div>
       </div>
      </div>
      <div class="stat-card stat-warning">
       <div class="stat-icon">
        â³
       </div>
       <div class="stat-content">
        <div class="stat-value" id="statPending">
         0
        </div>
        <div class="stat-label" data-ms="Menunggu" data-en="Pending">
         Menunggu
        </div>
       </div>
      </div>
      <div class="stat-card stat-info">
       <div class="stat-icon">
        ðŸ›ï¸
       </div>
       <div class="stat-content">
        <div class="stat-value" id="statRoomTotal">
         0
        </div>
        <div class="stat-label" data-ms="Tempahan Katil" data-en="Bed Bookings">
         Tempahan Katil
        </div>
       </div>
      </div>
     </div>
     <div class="dashboard-grid">
      <div class="dashboard-card">
       <h3 class="dashboard-card-title"><span>ðŸ©º</span> <span data-ms="Tempahan Klinik Terkini" data-en="Recent Clinic Bookings">Tempahan Klinik Terkini</span></h3>
       <div id="recentClinicBookings" class="dashboard-list"></div>
      </div>
      <div class="dashboard-card">
       <h3 class="dashboard-card-title">
  <span>ðŸ›ï¸</span>
  <span data-ms="Tempahan Katil Terkini" data-en="Recent Bed Bookings">
    Tempahan Katil Terkini
  </span>
</h3>
       <div id="recentRoomBookings" class="dashboard-list"></div>
      </div>
      <div class="dashboard-card">
       <h3 class="dashboard-card-title"><span>âš ï¸</span> <span data-ms="Kes Keutamaan" data-en="Urgent Cases">Kes Keutamaan</span></h3>
       <div id="urgentCases" class="dashboard-list"></div>
      </div>
      <div class="dashboard-card">
       <h3 class="dashboard-card-title"><span>ðŸ“ˆ</span> <span data-ms="Statistik Kelas" data-en="Class Statistics">Statistik Kelas</span></h3>
       <div id="classStats" class="dashboard-list"></div>
      </div>
     </div>
     <div class="dashboard-card" style="margin-top: 2rem;">
      <h3 class="dashboard-card-title"><span>ðŸ“…</span> <span data-ms="Jadual Temujanji Hari Ini" data-en="Today's Appointments">Jadual Temujanji Hari Ini</span></h3>
      <div id="todayAppointments" class="dashboard-list"></div>
     </div>
    </section><!-- Profile Section -->
    <section class="content-section" id="profileSection">
     <h2 class="section-title"><span>ðŸ‘¤</span> <span data-ms="Profil Sekolah" data-en="School Profile">Profil Sekolah</span></h2>
     <div id="adminPanelProfile" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir" data-en="Admin Panel">Panel Pentadbir</h3>
      <div class="admin-actions"><button class="admin-btn" id="editProfileBtn" data-ms="Edit Profil" data-en="Edit Profile">Edit Profil</button> <button class="admin-btn" id="changePasswordBtn" data-ms="Tukar Kata Laluan" data-en="Change Password">Tukar Kata Laluan</button> <button class="admin-btn" id="logoutBtn" data-ms="Log Keluar" data-en="Logout">Log Keluar</button>
      </div>
      <div class="chatbot-settings">
       <h4 data-ms="ðŸ¤– Tetapan AI Chatbot" data-en="ðŸ¤– AI Chatbot Settings">ðŸ¤– Tetapan AI Chatbot</h4>
       <form class="booking-form" id="chatbotSettingsForm">
        <div class="form-group"><label class="form-label" for="chatbotUrl"> <span data-ms="URL Link Chatbot" data-en="Chatbot Link URL">URL Link Chatbot</span> </label> <input type="url" class="form-input" id="chatbotUrl" placeholder="https://..."> <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;"> <span data-ms="Masukkan URL link ke chatbot AI anda. Kosongkan untuk menyembunyikan butang." data-en="Enter the URL link to your AI chatbot. Leave empty to hide the button."> Masukkan URL link ke chatbot AI anda. Kosongkan untuk menyembunyikan butang. </span> </small>
        </div><button type="submit" class="submit-btn" id="saveChatbotBtn"> <span data-ms="Simpan Tetapan Chatbot" data-en="Save Chatbot Settings">Simpan Tetapan Chatbot</span> </button>
       </form>
      </div>
     </div>
     <div class="profile-grid">
      <div class="profile-left">
       <div class="principal-card"><img src="https://via.placeholder.com/150" alt="Principal" class="principal-photo" id="principalPhoto">
        <h3 id="principalName">Nama Pengetua</h3>
        <p id="principalPosition">Pengetua</p>
        <p id="principalPhone">+60123456789</p>
        <div style="margin-top: 1rem; text-align: left;">
         <h4 data-ms="Ucapan Pentadbir" data-en="Principal's Message">Ucapan Pentadbir</h4>
         <p id="principalMessage" style="margin-top: 0.5rem; line-height: 1.6;">Selamat datang ke portal e-PRIhatin kami.</p>
        </div>
       </div>
      </div>
      <div class="profile-right">
       <div class="info-card">
        <h3 data-ms="Maklumat Sekolah" data-en="School Information">Maklumat Sekolah</h3>
        <div class="info-row"><strong data-ms="Jumlah Guru:" data-en="Staff Count:">Jumlah Guru:</strong> <span id="staffCount">50</span>
        </div>
        <div class="info-row"><strong data-ms="Jumlah Murid:" data-en="Student Count:">Jumlah Murid:</strong> <span id="studentCount">500</span>
        </div>
        <div class="info-row"><strong data-ms="Alamat:" data-en="Address:">Alamat:</strong> <span id="schoolAddress">Kuala Lumpur</span>
        </div>
        <div class="info-row"><strong data-ms="Emel:" data-en="Email:">Emel:</strong> <span id="schoolEmail">school@edu.my</span>
        </div>
        <div class="info-row"><strong data-ms="Telefon:" data-en="Phone:">Telefon:</strong> <span id="schoolPhone">+60312345678</span>
        </div>
       </div>
       <div class="info-card">
        <h3 data-ms="Visi" data-en="Vision">Visi</h3>
        <p id="schoolVision">Menjadi sekolah cemerlang yang melahirkan insan berilmu dan berakhlak mulia.</p>
       </div>
       <div class="info-card">
        <h3 data-ms="Misi" data-en="Mission">Misi</h3>
        <p id="schoolMission">Menyediakan pendidikan berkualiti tinggi untuk pembangunan holistik pelajar.</p>
       </div>
      </div>
     </div>
    </section><!-- Clinic Booking Section -->
    <section class="content-section hidden" id="clinicSection">
     <h2 class="section-title"><span>ðŸ©º</span> <span data-ms="Tempahan Klinik" data-en="Clinic Booking">Tempahan Klinik</span></h2>
     <div id="adminPanelClinic" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Tempahan Klinik" data-en="Admin Panel - Clinic Bookings">Panel Pentadbir - Tempahan Klinik</h3>
      <p data-ms="Anda boleh melihat dan menguruskan semua tempahan di bawah." data-en="You can view and manage all bookings below.">Anda boleh melihat dan menguruskan semua tempahan di bawah.</p>
      <div class="admin-actions" style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:end;">
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:end;">
          <div>
            <label class="form-label" for="clinicExportStart" style="margin-bottom:0.25rem;">
              <span data-ms="Dari" data-en="From">Dari</span>
            </label>
            <input type="date" class="form-input" id="clinicExportStart" style="min-width:170px;">
          </div>
          <div>
            <label class="form-label" for="clinicExportEnd" style="margin-bottom:0.25rem;">
              <span data-ms="Hingga" data-en="To">Hingga</span>
            </label>
            <input type="date" class="form-input" id="clinicExportEnd" style="min-width:170px;">
          </div>
        </div>

        <button class="admin-btn" onclick="downloadAllClinicBookings()" title="Download Data (PDF)">
          <span data-ms="Muat Turun Data Klinik (PDF)" data-en="Download Clinic Data (PDF)">Muat Turun Data Klinik (PDF)</span>
        </button>

        <button class="admin-btn" onclick="downloadClinicBookingsCSV()" title="Download Data (CSV)">
          <span data-ms="Muat Turun Data Klinik (CSV)" data-en="Download Clinic Data (CSV)">Muat Turun Data Klinik (CSV)</span>
        </button>
      </div>

     </div>
     <div id="clinicSuccessMessage" class="success-message"></div>
     <form class="booking-form" id="clinicBookingForm">
      <div class="form-group"><label class="form-label" for="appointmentType"> <span data-ms="Jenis Temu Janji" data-en="Appointment Type">Jenis Temu Janji</span> </label> <select class="form-select" id="appointmentType" required> <option value="" data-ms="Pilih jenis..." data-en="Select type...">Pilih jenis...</option> <option value="consultation" data-ms="Konsultasi Kesihatan" data-en="Health Consultation">Konsultasi Kesihatan</option> <option value="emergency" data-ms="Rawatan Kecemasan" data-en="Emergency Treatment">Rawatan Kecemasan</option> <option value="referral" data-ms="Rujukan Doktor" data-en="Doctor Referral">Rujukan Doktor</option> <option value="screening" data-ms="Saringan &amp; Vaksin" data-en="Screening &amp; Vaccine">Saringan &amp; Vaksin</option> </select>
      </div>
      <div class="form-group"><label class="form-label" for="clinicDate"> <span data-ms="Tarikh" data-en="Date">Tarikh</span> </label> <input type="date" class="form-input" id="clinicDate" required>
      </div>
      <div class="form-group"><label class="form-label" for="clinicTime"> <span data-ms="Masa" data-en="Time">Masa</span> </label> <input type="time" class="form-input" id="clinicTime" required>
      </div>
      <div class="form-help" id="clinicCapacityHint" style="margin-top:-0.25rem;"></div>

      <div class="form-group"><label class="form-label" for="studentName"> <span data-ms="Nama Pelajar" data-en="Student Name">Nama Pelajar</span> </label> <input type="text" class="form-input" id="studentName" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="studentEmail">
          <span data-ms="Emel Pelajar (untuk notifikasi)" data-en="Student Email (for notifications)">Emel Pelajar (untuk notifikasi)</span>
        </label>
        <input type="email" class="form-input" id="studentEmail" placeholder="nama@contoh.com">
        <div class="form-help">
          <span data-ms="Jika diisi, sistem akan hantar notifikasi emel bila tempahan disahkan/ditolak." data-en="If filled, the system can email you when the booking is approved/rejected.">Jika diisi, sistem akan hantar notifikasi emel bila tempahan disahkan/ditolak.</span>
        </div>
      </div>

	  <div class="form-group">
    <label class="form-label" for="studentCategory">
      <span data-ms="Kategori Pelajar" data-en="Student Category">Kategori Pelajar</span>
    </label>
    <select id="studentCategory" class="form-input" required>
      <option value="" disabled selected>
        -- Pilih kategori --
      </option>
      <option value="asrama">
        Asrama
      </option>
      <option value="luar">
        Pelajar Luar
      </option>
    </select>
  </div>
      <div class="form-group"><label class="form-label" for="className"> <span data-ms="Kelas" data-en="Class">Kelas</span> </label> <select class="form-select" id="className" required> <option value="" data-ms="Pilih kelas..." data-en="Select class...">Pilih kelas...</option> <optgroup label="Sijil 1"> <option value="S1KSK1">S1KSK1</option> <option value="S1KSK2">S1KSK2</option> <option value="S1BPR">S1BPR</option> <option value="S1BKP1">S1BKP1</option> <option value="S1BKP2">S1BKP2</option> <option value="S1BPM">S1BPM</option> <option value="S1BPP">S1BPP</option> </optgroup> <optgroup label="Sijil 2"> <option value="S2KSK1">S2KSK1</option> <option value="S2KSK2">S2KSK2</option> <option value="S2BPR">S2BPR</option> <option value="S2BKP1">S2BKP1</option> <option value="S2BKP2">S2BKP2</option> <option value="S2BPM">S2BPM</option> <option value="S2BPP">S2BPP</option> </optgroup> <optgroup label="Diploma 1"> <option value="D1KSK1">D1KSK1</option> <option value="D1KSK2">D1KSK2</option> <option value="D1BPR">D1BPR</option> <option value="D1BKP1">D1BKP1</option> <option value="D1BKP2">D1BKP2</option> <option value="D1BPM">D1BPM</option> <option value="D1BPP">D1BPP</option> </optgroup> <optgroup label="Diploma 2"> <option value="D2KSK1">D2KSK1</option> <option value="D2KSK2">D2KSK2</option> <option value="D2BPR">D2BPR</option> <option value="D2BKP1">D2BKP1</option> <option value="D2BKP2">D2BKP2</option> <option value="D2BPM">D2BPM</option> <option value="D2BPP">D2BPP</option> </optgroup> </select>
      </div>
      <div class="form-group"><label class="form-label" for="guardianPhone"> <span data-ms="No. HP Penjaga (Pilihan)" data-en="Guardian Phone (Optional)">No. HP Penjaga (Pilihan)</span> </label> <input type="tel" class="form-input" id="guardianPhone">
      </div>
      <div class="form-group"><label class="form-label" for="symptoms"> <span data-ms="Simptom Ringkas" data-en="Brief Symptoms">Simptom Ringkas</span> </label> <textarea class="form-textarea" id="symptoms" required></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="documentUrl"> <span data-ms="URL Dokumen Sokongan (Pilihan)" data-en="Supporting Document URL (Optional)">URL Dokumen Sokongan (Pilihan)</span> </label> <input type="url" class="form-input" id="documentUrl" placeholder="https://...">
      </div>
      <div class="form-group">
        <label class="form-label" for="documentFile">
          <span data-ms="Muat naik dokumen (gambar/PDF) (Pilihan)" data-en="Upload document (image/PDF) (Optional)">Muat naik dokumen (gambar/PDF) (Pilihan)</span>
        </label>
        <input type="file" class="form-input" id="documentFile" accept="image/*,application/pdf">
        <input type="hidden" id="documentFileData">
        <div class="form-help">
          <span data-ms="Tip: Pastikan fail kecil (cadangan â‰¤ 2MB). Gambar akan disimpan di pelayar." data-en="Tip: Keep file small (recommended â‰¤ 2MB). Image/PDF will be stored in the browser.">Tip: Pastikan fail kecil (cadangan â‰¤ 2MB). Gambar akan disimpan di pelayar.</span>
        </div>
        <img class="media-preview" id="documentPreview" alt="Preview" style="display:none; max-height: 140px; border-radius: 14px;">
        <a id="documentPdfLink" href="#" target="_blank" style="display:none; margin-top:10px; display:inline-block; font-weight:700;">
          ðŸ“„ <span data-ms="Lihat PDF" data-en="View PDF">Lihat PDF</span>
        </a>
      </div>

      <div class="checkbox-group"><input type="checkbox" class="form-checkbox" id="isUrgent"> <label class="form-label" for="isUrgent"> <span data-ms="Keutamaan / Urgent" data-en="Priority / Urgent">Keutamaan / Urgent</span> </label>
      </div><button type="submit" class="submit-btn" id="clinicSubmitBtn"> <span data-ms="Hantar Tempahan" data-en="Submit Booking">Hantar Tempahan</span> </button>
     </form>
     <div class="bookings-list" id="clinicBookingsList"></div>
    </section><!-- Room Booking Section -->
    <section class="content-section hidden" id="roomSection">
     <h2 class="section-title"><span>ðŸ›ï¸</span> <span data-ms="Tempahan Katil Sakit" data-en="Sick Bed Booking">Tempahan Katil Sakit</span></h2>

     <div class="info-card" id="medicineCard">
       <h3>ðŸ’Š <span data-ms="Ubat-ubatan di Bilik Sakit" data-en="Medicines Available in Sick Bay">Ubat-ubatan di Bilik Sakit</span></h3>
       <div class="medicine-meta">
         <span data-ms="Senarai ini untuk rujukan sahaja. Jika tiada item, sila hubungi pihak sekolah." data-en="This list is for reference only. If an item is unavailable, please contact the school.">Senarai ini untuk rujukan sahaja. Jika tiada item, sila hubungi pihak sekolah.</span>
       </div>
       <ul class="medicine-list" id="medicineList"></ul>

       <div id="medicineAdminPanel" style="display:none;">
         <div class="medicine-meta" style="margin-top:0.8rem;">
           <span data-ms="Admin boleh kemaskini inventori ubat di sini." data-en="Admins can update the medicine inventory here.">Admin boleh kemaskini inventori ubat di sini.</span>
         </div>

         <div class="medicine-admin-row">
           <input type="text" class="form-input" id="medName" placeholder="Nama ubat / item">
           <input type="text" class="form-input" id="medQty" placeholder="Kuantiti">
           <input type="text" class="form-input" id="medNote" placeholder="Catatan (pilihan)">
           <button type="button" class="admin-btn" id="addMedicineBtn" style="background: linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%); color: white;">âž• <span data-ms="Tambah" data-en="Add">Tambah</span></button>
         </div>

         <div class="medicine-admin-actions" id="medicineAdminList"></div>
       </div>
     </div>

     <div id="adminPanelRoom" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Tempahan Katil Sakit" data-en="Admin Panel - Sick Bed Bookings">Panel Pentadbir - Tempahan Katil Sakit</h3>
      <p data-ms="Anda boleh melihat dan menguruskan semua tempahan di bawah." data-en="You can view and manage all bookings below.">Anda boleh melihat dan menguruskan semua tempahan di bawah.</p>
      <div class="admin-actions" style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:end;">
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:end;">
          <div>
            <label class="form-label" for="roomExportStart" style="margin-bottom:0.25rem;">
              <span data-ms="Dari" data-en="From">Dari</span>
            </label>
            <input type="date" class="form-input" id="roomExportStart" style="min-width:170px;">
          </div>
          <div>
            <label class="form-label" for="roomExportEnd" style="margin-bottom:0.25rem;">
              <span data-ms="Hingga" data-en="To">Hingga</span>
            </label>
            <input type="date" class="form-input" id="roomExportEnd" style="min-width:170px;">
          </div>
        </div>

        <button class="admin-btn" onclick="downloadAllRoomBookings()" title="Download Data (PDF)">
          <span data-ms="Muat Turun Data Katil (PDF)" data-en="Download Bed Data (PDF)">Muat Turun Data Katil (PDF)</span>
        </button>

        <button class="admin-btn" onclick="downloadRoomBookingsCSV()" title="Download Data (CSV)">
          <span data-ms="Muat Turun Data Katil (CSV)" data-en="Download Bed Data (CSV)">Muat Turun Data Katil (CSV)</span>
        </button>
      </div>

     </div>
     <div id="roomSuccessMessage" class="success-message"></div>
     <form class="booking-form" id="roomBookingForm">
      <div class="form-group"><label class="form-label" for="roomType"> <span data-ms="Lokasi Katil Sakit" data-en="Sick Bed Location">Lokasi Katil Sakit</span> </label> <select class="form-select" id="roomType" required> <option value="" data-ms="Pilih lokasi..." data-en="Select location...">Pilih lokasi...</option> <option value="asrama_a" data-ms="Asrama Blok A" data-en="Dormitory Block A">Asrama Blok A</option> <option value="asrama_b" data-ms="Asrama Blok B" data-en="Dormitory Block B">Asrama Blok B</option> <option value="asrama_c" data-ms="Asrama Blok C" data-en="Dormitory Block C">Asrama Blok C</option> <option value="asrama_d" data-ms="Asrama Blok D" data-en="Dormitory Block D">Asrama Blok D</option> <option value="bilik_sakit" data-ms="Bilik Sakit Sekolah" data-en="School Sick Bay">Bilik Sakit Sekolah</option> </select>
      </div>
      <div class="form-group"><label class="form-label" for="studentName2"> <span data-ms="Nama Pelajar" data-en="Student Name">Nama Pelajar</span> </label> <input type="text" class="form-input" id="studentName2" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="studentEmail2">
          <span data-ms="Emel Pelajar (untuk notifikasi)" data-en="Student Email (for notifications)">Emel Pelajar (untuk notifikasi)</span>
        </label>
        <input type="email" class="form-input" id="studentEmail2" placeholder="nama@contoh.com">
      </div>

	    <!-- Kategori Pelajar (Asrama / Luar) -->
  <div class="form-group">
    <label class="form-label" for="roomStudentCategory">
      <span data-ms="Kategori Pelajar" data-en="Student Category">Kategori Pelajar</span>
    </label>
    <select id="roomStudentCategory" class="form-input" required>
      <option value="" disabled selected>
        -- Pilih kategori --
      </option>
      <option value="asrama">
        Asrama
      </option>
      <option value="luar">
        Pelajar Luar
      </option>
    </select>
  </div>

      <div class="form-group"><label class="form-label" for="className2"> <span data-ms="Kelas" data-en="Class">Kelas</span> </label> <select class="form-select" id="className2" required> <option value="" data-ms="Pilih kelas..." data-en="Select class...">Pilih kelas...</option> <optgroup label="Sijil 1"> <option value="S1KSK1">S1KSK1</option> <option value="S1KSK2">S1KSK2</option> <option value="S1BPR">S1BPR</option> <option value="S1BKP1">S1BKP1</option> <option value="S1BKP2">S1BKP2</option> <option value="S1BPM">S1BPM</option> <option value="S1BPP">S1BPP</option> </optgroup> <optgroup label="Sijil 2"> <option value="S2KSK1">S2KSK1</option> <option value="S2KSK2">S2KSK2</option> <option value="S2BPR">S2BPR</option> <option value="S2BKP1">S2BKP1</option> <option value="S2BKP2">S2BKP2</option> <option value="S2BPM">S2BPM</option> <option value="S2BPP">S2BPP</option> </optgroup> <optgroup label="Diploma 1"> <option value="D1KSK1">D1KSK1</option> <option value="D1KSK2">D1KSK2</option> <option value="D1BPR">D1BPR</option> <option value="D1BKP1">D1BKP1</option> <option value="D1BKP2">D1BKP2</option> <option value="D1BPM">D1BPM</option> <option value="D1BPP">D1BPP</option> </optgroup> <optgroup label="Diploma 2"> <option value="D2KSK1">D2KSK1</option> <option value="D2KSK2">D2KSK2</option> <option value="D2BPR">D2BPR</option> <option value="D2BKP1">D2BKP1</option> <option value="D2BKP2">D2BKP2</option> <option value="D2BPM">D2BPM</option> <option value="D2BPP">D2BPP</option> </optgroup> </select>
      </div>
      <div class="form-group"><label class="form-label" for="roomDate"> <span data-ms="Tarikh Mula" data-en="Start Date">Tarikh Mula</span> </label> <input type="date" class="form-input" id="roomDate" required>
      </div>
      <div class="form-group"><label class="form-label" for="roomStartTime"> <span data-ms="Masa Mula" data-en="Start Time">Masa Mula</span> </label> <input type="time" class="form-input" id="roomStartTime" required>
      </div>
      <div class="form-group"><label class="form-label" for="estimatedDays"> <span data-ms="Anggaran Hari Menginap" data-en="Estimated Days">Anggaran Hari Menginap</span> </label> <select class="form-select" id="estimatedDays" required> <option value="1" data-ms="1 Hari" data-en="1 Day">1 Hari</option> <option value="2" data-ms="2 Hari" data-en="2 Days">2 Hari</option> <option value="3" data-ms="3 Hari" data-en="3 Days">3 Hari</option> <option value="4" data-ms="4 Hari" data-en="4 Days">4 Hari</option> <option value="5" data-ms="5 Hari" data-en="5 Days">5 Hari</option> <option value="7" data-ms="7 Hari" data-en="7 Days">7 Hari</option> </select>
      </div>
      <div class="form-help" style="margin-top:-0.25rem;">
        <span data-ms="Nota: Tempahan katil akan direset automatik pada 00:00 setiap hari (semua katil jadi available semula)." data-en="Note: Bed bookings auto-reset at 00:00 daily (all beds become available again).">Nota: Tempahan katil akan direset automatik pada 00:00 setiap hari (semua katil jadi available semula).</span>
      </div>

      <div class="form-group"><label class="form-label" for="guardianPhone2"> <span data-ms="No. HP Penjaga" data-en="Guardian Phone">No. HP Penjaga</span> </label> <input type="tel" class="form-input" id="guardianPhone2" required>
      </div>
      <div class="form-group"><label class="form-label" for="roomPurpose"> <span data-ms="Sebab / Simptom" data-en="Reason / Symptoms">Sebab / Simptom</span> </label> <textarea class="form-textarea" id="roomPurpose" required></textarea>
      </div>
      <div class="form-group">
        <label class="form-label" for="roomDocumentUrl">
          <span data-ms="URL Dokumen Sokongan (Pilihan)" data-en="Supporting Document URL (Optional)">URL Dokumen Sokongan (Pilihan)</span>
        </label>
        <input type="url" class="form-input" id="roomDocumentUrl" placeholder="https://...">
      </div>

      <div class="form-group">
        <label class="form-label" for="roomDocumentFile">
          <span data-ms="Muat naik dokumen (gambar/PDF) (Pilihan)" data-en="Upload document (image/PDF) (Optional)">Muat naik dokumen (gambar/PDF) (Pilihan)</span>
        </label>
        <input type="file" class="form-input" id="roomDocumentFile" accept="image/*,application/pdf">
        <input type="hidden" id="roomDocumentFileData">
        <div class="form-help">
          <span data-ms="Tip: Pastikan fail kecil (cadangan â‰¤ 2MB). Dokumen akan disimpan di pelayar." data-en="Tip: Keep file small (recommended â‰¤ 2MB). Document will be stored in the browser.">Tip: Pastikan fail kecil (cadangan â‰¤ 2MB). Dokumen akan disimpan di pelayar.</span>
        </div>
        <img class="media-preview" id="roomDocumentPreview" alt="Preview" style="display:none; max-height: 140px; border-radius: 14px;">
        <a id="roomDocumentPdfLink" href="#" target="_blank" style="display:none; margin-top:10px; display:inline-block; font-weight:700;">
          ðŸ“„ <span data-ms="Lihat PDF" data-en="View PDF">Lihat PDF</span>
        </a>
      </div>
<button type="submit" class="submit-btn" id="roomSubmitBtn"> <span data-ms="Hantar Tempahan" data-en="Submit Booking">Hantar Tempahan</span> </button>
     </form>
     <div class="bookings-list" id="roomBookingsList"></div>
    </section><!-- Other Sections (Placeholder) -->
    <section class="content-section hidden" id="announcementsSection">
     <h2 class="section-title"><span>ðŸ“¢</span> <span data-ms="Makluman" data-en="Announcements">Makluman</span></h2>
     <div id="adminPanelAnnouncements" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Makluman" data-en="Admin Panel - Announcements">Panel Pentadbir - Makluman</h3>
      <div class="admin-actions"><button class="admin-btn" id="addAnnouncementBtn" data-ms="âž• Tambah Makluman" data-en="âž• Add Announcement">âž• Tambah Makluman</button>
      </div>
      <div id="announcementFormContainer" style="display: none; margin-top: 2rem; background: white; padding: 2rem; border-radius: 15px;">
       <h4 style="color: #ff6fa3; margin-bottom: 1.5rem;" data-ms="Tambah Makluman Baru" data-en="Add New Announcement">Tambah Makluman Baru</h4>
       <form class="booking-form" id="announcementForm">
        <div class="form-group"><label class="form-label" for="announcementTitleMs"> <span data-ms="Tajuk (Malay)" data-en="Title (Malay)">Tajuk (Malay)</span> </label> <input type="text" class="form-input" id="announcementTitleMs" required>
        </div>
        <div class="form-group"><label class="form-label" for="announcementTitleEn"> <span data-ms="Title (English)" data-en="Title (English)">Title (English)</span> </label> <input type="text" class="form-input" id="announcementTitleEn" required>
        </div>
        <div class="form-group"><label class="form-label" for="announcementContentMs"> <span data-ms="Kandungan (Malay)" data-en="Content (Malay)">Kandungan (Malay)</span> </label> <textarea class="form-textarea" id="announcementContentMs" required style="min-height: 150px;"></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="announcementContentEn"> <span data-ms="Content (English)" data-en="Content (English)">Content (English)</span> </label> <textarea class="form-textarea" id="announcementContentEn" required style="min-height: 150px;"></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="announcementDate"> <span data-ms="Tarikh" data-en="Date">Tarikh</span> </label> <input type="date" class="form-input" id="announcementDate" required>
        </div>
        <div class="form-group"><label class="form-label" for="announcementImageUrl"> <span data-ms="URL Gambar (Pilihan)" data-en="Image URL (Optional)">URL Gambar (Pilihan)</span> </label> <input type="url" class="form-input" id="announcementImageUrl" placeholder="https://...">
        </div>

        <div class="form-group">
          <label class="form-label" for="announcementImageFile">
            <span data-ms="Muat Naik Gambar (Pilihan)" data-en="Upload Image (Optional)">Muat Naik Gambar (Pilihan)</span>
          </label>
          <input type="file" class="form-input" id="announcementImageFile" accept="image/*">
          <div class="form-help">
            <span data-ms="Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)" data-en="You can pick an image from your device storage. (Recommended: < 1.5MB)">Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)</span>
          </div>
          <img class="media-preview" id="announcementImagePreview" alt="Preview">
        </div>
        <div class="form-group">
          <label class="form-label" for="announcementVideoUrl">
            <span data-ms="URL Video (Pilihan)" data-en="Video URL (Optional)">URL Video (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="announcementVideoUrl" placeholder="https://youtube.com/... atau https://...mp4">
        </div>
        <div class="form-group">
          <label class="form-label" for="announcementLinkUrl">
            <span data-ms="URL Pautan (Pilihan)" data-en="Link URL (Optional)">URL Pautan (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="announcementLinkUrl" placeholder="https://...">
        </div>

        <div style="display: flex; gap: 1rem;"><button type="submit" class="submit-btn" id="saveAnnouncementBtn"> <span data-ms="Simpan Makluman" data-en="Save Announcement">Simpan Makluman</span> </button> <button type="button" class="submit-btn" id="cancelAnnouncementBtn" style="background: #6c757d;"> <span data-ms="Batal" data-en="Cancel">Batal</span> </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bookings-list" id="announcementsList"></div>
    </section>
    <section class="content-section hidden" id="programsSection">
     <h2 class="section-title"><span>ðŸ“…</span> <span data-ms="Program" data-en="Programs">Program</span></h2>
     <div id="adminPanelPrograms" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Program" data-en="Admin Panel - Programs">Panel Pentadbir - Program</h3>
      <div class="admin-actions"><button class="admin-btn" id="addProgramBtn" data-ms="âž• Tambah Program" data-en="âž• Add Program">âž• Tambah Program</button>
      </div>
      <div id="programFormContainer" style="display: none; margin-top: 2rem; background: white; padding: 2rem; border-radius: 15px;">
       <h4 style="color: #ff6fa3; margin-bottom: 1.5rem;" data-ms="Tambah Program Baru" data-en="Add New Program">Tambah Program Baru</h4>
       <form class="booking-form" id="programForm">
        <div class="form-group"><label class="form-label" for="programNameMs"> <span data-ms="Nama Program (Malay)" data-en="Program Name (Malay)">Nama Program (Malay)</span> </label> <input type="text" class="form-input" id="programNameMs" required>
        </div>
        <div class="form-group"><label class="form-label" for="programNameEn"> <span data-ms="Program Name (English)" data-en="Program Name (English)">Program Name (English)</span> </label> <input type="text" class="form-input" id="programNameEn" required>
        </div>
        <div class="form-group"><label class="form-label" for="programDescMs"> <span data-ms="Penerangan (Malay)" data-en="Description (Malay)">Penerangan (Malay)</span> </label> <textarea class="form-textarea" id="programDescMs" required></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="programDescEn"> <span data-ms="Description (English)" data-en="Description (English)">Description (English)</span> </label> <textarea class="form-textarea" id="programDescEn" required></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="programDate"> <span data-ms="Tarikh" data-en="Date">Tarikh</span> </label> <input type="date" class="form-input" id="programDate" required>
        </div>
        <div class="form-group"><label class="form-label" for="programTime"> <span data-ms="Masa" data-en="Time">Masa</span> </label> <input type="time" class="form-input" id="programTime" required>
        </div>
        <div class="form-group"><label class="form-label" for="programVenue"> <span data-ms="Tempat" data-en="Venue">Tempat</span> </label> <input type="text" class="form-input" id="programVenue" required>
        </div>
        <div class="form-group"><label class="form-label" for="programImageUrl"> <span data-ms="URL Gambar (Pilihan)" data-en="Image URL (Optional)">URL Gambar (Pilihan)</span> </label> <input type="url" class="form-input" id="programImageUrl" placeholder="https://...">
        </div>

        <div class="form-group">
          <label class="form-label" for="programImageFile">
            <span data-ms="Muat Naik Gambar (Pilihan)" data-en="Upload Image (Optional)">Muat Naik Gambar (Pilihan)</span>
          </label>
          <input type="file" class="form-input" id="programImageFile" accept="image/*">
          <div class="form-help">
            <span data-ms="Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)" data-en="You can pick an image from your device storage. (Recommended: < 1.5MB)">Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)</span>
          </div>
          <img class="media-preview" id="programImagePreview" alt="Preview">
        </div>
        <div class="form-group">
          <label class="form-label" for="programVideoUrl">
            <span data-ms="URL Video (Pilihan)" data-en="Video URL (Optional)">URL Video (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="programVideoUrl" placeholder="https://youtube.com/... atau https://...mp4">
        </div>
        <div class="form-group">
          <label class="form-label" for="programLinkUrl">
            <span data-ms="URL Pautan (Pilihan)" data-en="Link URL (Optional)">URL Pautan (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="programLinkUrl" placeholder="https://...">
        </div>

        <div style="display: flex; gap: 1rem;"><button type="submit" class="submit-btn" id="saveProgramBtn"> <span data-ms="Simpan Program" data-en="Save Program">Simpan Program</span> </button> <button type="button" class="submit-btn" id="cancelProgramBtn" style="background: #6c757d;"> <span data-ms="Batal" data-en="Cancel">Batal</span> </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bookings-list" id="programsList"></div>
    </section>
    <section class="content-section hidden" id="achievementsSection">
     <h2 class="section-title"><span>ðŸ†</span> <span data-ms="Kejayaan" data-en="Achievements">Kejayaan</span></h2>
     <div id="adminPanelAchievements" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Kejayaan" data-en="Admin Panel - Achievements">Panel Pentadbir - Kejayaan</h3>
      <div class="admin-actions"><button class="admin-btn" id="addAchievementBtn" data-ms="âž• Tambah Kejayaan" data-en="âž• Add Achievement">âž• Tambah Kejayaan</button>
      </div>
      <div id="achievementFormContainer" style="display: none; margin-top: 2rem; background: white; padding: 2rem; border-radius: 15px;">
       <h4 style="color: #ff6fa3; margin-bottom: 1.5rem;" data-ms="Tambah Kejayaan Baru" data-en="Add New Achievement">Tambah Kejayaan Baru</h4>
       <form class="booking-form" id="achievementForm">
        <div class="form-group"><label class="form-label" for="achievementTitleMs"> <span data-ms="Tajuk (Malay)" data-en="Title (Malay)">Tajuk (Malay)</span> </label> <input type="text" class="form-input" id="achievementTitleMs" required>
        </div>
        <div class="form-group"><label class="form-label" for="achievementTitleEn"> <span data-ms="Title (English)" data-en="Title (English)">Title (English)</span> </label> <input type="text" class="form-input" id="achievementTitleEn" required>
        </div>
        <div class="form-group"><label class="form-label" for="achievementDescMs"> <span data-ms="Penerangan (Malay)" data-en="Description (Malay)">Penerangan (Malay)</span> </label> <textarea class="form-textarea" id="achievementDescMs" required></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="achievementDescEn"> <span data-ms="Description (English)" data-en="Description (English)">Description (English)</span> </label> <textarea class="form-textarea" id="achievementDescEn" required></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="achievementDate"> <span data-ms="Tarikh" data-en="Date">Tarikh</span> </label> <input type="date" class="form-input" id="achievementDate" required>
        </div>
        <div class="form-group"><label class="form-label" for="achievementCategory"> <span data-ms="Kategori" data-en="Category">Kategori</span> </label> <select class="form-select" id="achievementCategory" required> <option value="" data-ms="Pilih kategori..." data-en="Select category...">Pilih kategori...</option> <option value="academic" data-ms="Akademik" data-en="Academic">Akademik</option> <option value="sports" data-ms="Sukan" data-en="Sports">Sukan</option> <option value="arts" data-ms="Kesenian" data-en="Arts">Kesenian</option> <option value="community" data-ms="Komuniti" data-en="Community">Komuniti</option> </select>
        </div>
        <div class="form-group"><label class="form-label" for="achievementImageUrl"> <span data-ms="URL Gambar (Pilihan)" data-en="Image URL (Optional)">URL Gambar (Pilihan)</span> </label> <input type="url" class="form-input" id="achievementImageUrl" placeholder="https://...">
        </div>

        <div class="form-group">
          <label class="form-label" for="achievementImageFile">
            <span data-ms="Muat Naik Gambar (Pilihan)" data-en="Upload Image (Optional)">Muat Naik Gambar (Pilihan)</span>
          </label>
          <input type="file" class="form-input" id="achievementImageFile" accept="image/*">
          <div class="form-help">
            <span data-ms="Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)" data-en="You can pick an image from your device storage. (Recommended: < 1.5MB)">Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)</span>
          </div>
          <img class="media-preview" id="achievementImagePreview" alt="Preview">
        </div>
        <div class="form-group">
          <label class="form-label" for="achievementVideoUrl">
            <span data-ms="URL Video (Pilihan)" data-en="Video URL (Optional)">URL Video (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="achievementVideoUrl" placeholder="https://youtube.com/... atau https://...mp4">
        </div>
        <div class="form-group">
          <label class="form-label" for="achievementLinkUrl">
            <span data-ms="URL Pautan (Pilihan)" data-en="Link URL (Optional)">URL Pautan (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="achievementLinkUrl" placeholder="https://...">
        </div>

        <div style="display: flex; gap: 1rem;"><button type="submit" class="submit-btn" id="saveAchievementBtn"> <span data-ms="Simpan Kejayaan" data-en="Save Achievement">Simpan Kejayaan</span> </button> <button type="button" class="submit-btn" id="cancelAchievementBtn" style="background: #6c757d;"> <span data-ms="Batal" data-en="Cancel">Batal</span> </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bookings-list" id="achievementsList"></div>
    </section>
    <section class="content-section hidden" id="teachersSection">
     <h2 class="section-title"><span>ðŸ‘¥</span> <span data-ms="Guru / Pemandu Bertugas" data-en="Teachers / Drivers on Duty">Guru / Pemandu Bertugas</span></h2>
     <div id="adminPanelTeachers" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Jadual Bertugas" data-en="Admin Panel - Duty Schedule">Panel Pentadbir - Jadual Bertugas</h3>
      <div class="admin-actions"><button class="admin-btn" id="addScheduleBtn" data-ms="âž• Tambah Jadual" data-en="âž• Add Schedule">âž• Tambah Jadual</button>
      </div>
      <div id="scheduleFormContainer" style="display: none; margin-top: 2rem; background: white; padding: 2rem; border-radius: 15px;">
       <h4 style="color: #ff6fa3; margin-bottom: 1.5rem;" data-ms="Tambah Jadual Bertugas" data-en="Add Duty Schedule">Tambah Jadual Bertugas</h4>
       <form class="booking-form" id="scheduleForm">
        <div class="form-group"><label class="form-label" for="scheduleTitle"> <span data-ms="Tajuk Jadual" data-en="Schedule Title">Tajuk Jadual</span> </label> <input type="text" class="form-input" id="scheduleTitle" required placeholder="Cth: Jadual Guru Bertugas Mac 2024">
        </div>
        <div class="form-group"><label class="form-label" for="scheduleImageUrl"> <span data-ms="URL Gambar Jadual" data-en="Schedule Image URL">URL Gambar Jadual</span> </label> <input type="url" class="form-input" id="scheduleImageUrl" required placeholder="https://..."> <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;"> <span data-ms="Masukkan URL link gambar jadual bertugas (format: JPG, PNG)" data-en="Enter image URL for duty schedule (format: JPG, PNG)"> Masukkan URL link gambar jadual bertugas (format: JPG, PNG) </span> </small>
        </div>
        <div class="form-group"><label class="form-label" for="scheduleMonth"> <span data-ms="Bulan / Tempoh" data-en="Month / Period">Bulan / Tempoh</span> </label> <input type="text" class="form-input" id="scheduleMonth" required placeholder="Cth: Mac 2024">
        </div>
        <div style="display: flex; gap: 1rem;"><button type="submit" class="submit-btn" id="saveScheduleBtn"> <span data-ms="Simpan Jadual" data-en="Save Schedule">Simpan Jadual</span> </button> <button type="button" class="submit-btn" id="cancelScheduleBtn" style="background: #6c757d;"> <span data-ms="Batal" data-en="Cancel">Batal</span> </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bookings-list" id="schedulesList"></div>
    </section>
    <section class="content-section hidden" id="guestbookSection">
     <h3 class="dashboard-card-title">
  <span>ðŸ“–</span>
  <span data-ms="Buku Pelawat" data-en="Guest Book">
    Buku Pelawat
  </span>
</h3>

     <div id="adminPanelGuestbook" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Buku Pelawat" data-en="Admin Panel - Guest Book">Panel Pentadbir - Buku Pelawat</h3>
      <p data-ms="Anda boleh melihat dan menguruskan semua entri buku pelawat di bawah." data-en="You can view and manage all guestbook entries below.">Anda boleh melihat dan menguruskan semua entri buku pelawat di bawah.</p>
     </div>
     <form class="booking-form" id="guestbookForm">
      <div class="form-group"><label class="form-label" for="guestName"> <span data-ms="Nama" data-en="Name">Nama</span> </label> <input type="text" class="form-input" id="guestName" required>
      </div>
      <div class="form-group"><label class="form-label" for="guestEmail"> <span data-ms="Emel (Pilihan)" data-en="Email (Optional)">Emel (Pilihan)</span> </label> <input type="email" class="form-input" id="guestEmail">
      </div>
      <div class="form-group"><label class="form-label" for="guestPhone"> <span data-ms="No. Telefon (Pilihan)" data-en="Phone Number (Optional)">No. Telefon (Pilihan)</span> </label> <input type="tel" class="form-input" id="guestPhone">
      </div>
      <div class="form-group"><label class="form-label" for="guestOrganization"> <span data-ms="Organisasi / Syarikat" data-en="Organization / Company">Organisasi / Syarikat</span> </label> <input type="text" class="form-input" id="guestOrganization" required>
      </div>
      <div class="form-group"><label class="form-label" for="guestPurpose"> <span data-ms="Tujuan Lawatan" data-en="Purpose of Visit">Tujuan Lawatan</span> </label> <select class="form-select" id="guestPurpose" required> <option value="" data-ms="Pilih tujuan..." data-en="Select purpose...">Pilih tujuan...</option> <option value="official" data-ms="Lawatan Rasmi" data-en="Official Visit">Lawatan Rasmi</option> <option value="meeting" data-ms="Mesyuarat" data-en="Meeting">Mesyuarat</option> <option value="program" data-ms="Program / Aktiviti" data-en="Program / Activity">Program / Aktiviti</option> <option value="inspection" data-ms="Pemeriksaan" data-en="Inspection">Pemeriksaan</option> <option value="other" data-ms="Lain-lain" data-en="Others">Lain-lain</option> </select>
      </div>
      <div class="form-group"><label class="form-label" for="guestMessage"> <span data-ms="Komen / Cadangan" data-en="Comments / Suggestions">Komen / Cadangan</span> </label> <textarea class="form-textarea" id="guestMessage" required style="min-height: 120px;"></textarea>
      </div>
      <div class="form-group"><label class="form-label" for="guestRating"> <span data-ms="Penilaian Perkhidmatan" data-en="Service Rating">Penilaian Perkhidmatan</span> </label> <select class="form-select" id="guestRating" required> <option value="" data-ms="Pilih penilaian..." data-en="Select rating...">Pilih penilaian...</option> <option value="5" data-ms="â­â­â­â­â­ Sangat Baik" data-en="â­â­â­â­â­ Excellent">â­â­â­â­â­ Sangat Baik</option> <option value="4" data-ms="â­â­â­â­ Baik" data-en="â­â­â­â­ Good">â­â­â­â­ Baik</option> <option value="3" data-ms="â­â­â­ Sederhana" data-en="â­â­â­ Average">â­â­â­ Sederhana</option> <option value="2" data-ms="â­â­ Kurang Baik" data-en="â­â­ Below Average">â­â­ Kurang Baik</option> <option value="1" data-ms="â­ Perlu Penambahbaikan" data-en="â­ Needs Improvement">â­ Perlu Penambahbaikan</option> </select>
      </div><button type="submit" class="submit-btn" id="guestbookSubmitBtn"> <span data-ms="Hantar Entri" data-en="Submit Entry">Hantar Entri</span> </button>
     </form>
     <div class="bookings-list" id="guestbookList"></div>
    </section>
    <section class="content-section hidden" id="sharingSection">
     <h2 class="section-title"><span>ðŸ“¸</span> <span data-ms="Perkongsian" data-en="Sharing">Perkongsian</span></h2>
     <div class="sharing-public-form" style="background: white; padding: 2rem; border-radius: 20px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(255, 111, 163, 0.15);">
      <h3 style="color: #ff6fa3; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;"><span>âœï¸</span> <span data-ms="Kongsi Cerita Anda" data-en="Share Your Story">Kongsi Cerita Anda</span></h3>
      <form class="booking-form" id="publicSharingForm">
       <div class="form-group"><label class="form-label" for="publicSharingTitleMs"> <span data-ms="Tajuk (Malay)" data-en="Title (Malay)">Tajuk (Malay)</span> </label> <input type="text" class="form-input" id="publicSharingTitleMs" required>
       </div>
       <div class="form-group"><label class="form-label" for="publicSharingTitleEn"> <span data-ms="Title (English)" data-en="Title (English)">Title (English)</span> </label> <input type="text" class="form-input" id="publicSharingTitleEn" required>
       </div>
       <div class="form-group"><label class="form-label" for="publicSharingContentMs"> <span data-ms="Kandungan (Malay)" data-en="Content (Malay)">Kandungan (Malay)</span> </label> <textarea class="form-textarea" id="publicSharingContentMs" required style="min-height: 120px;"></textarea>
       </div>
       <div class="form-group"><label class="form-label" for="publicSharingContentEn"> <span data-ms="Content (English)" data-en="Content (English)">Content (English)</span> </label> <textarea class="form-textarea" id="publicSharingContentEn" required style="min-height: 120px;"></textarea>
       </div>
       <div class="form-group"><label class="form-label" for="publicSharingAuthor"> <span data-ms="Nama Anda" data-en="Your Name">Nama Anda</span> </label> <input type="text" class="form-input" id="publicSharingAuthor" required>
       </div>
       <div class="form-group"><label class="form-label" for="publicSharingImageUrl"> <span data-ms="URL Gambar (Pilihan)" data-en="Image URL (Optional)">URL Gambar (Pilihan)</span> </label> <input type="url" class="form-input" id="publicSharingImageUrl" placeholder="https://...">
       </div>

        <div class="form-group">
          <label class="form-label" for="publicSharingImageFile">
            <span data-ms="Muat Naik Gambar (Pilihan)" data-en="Upload Image (Optional)">Muat Naik Gambar (Pilihan)</span>
          </label>
          <input type="file" class="form-input" id="publicSharingImageFile" accept="image/*">
          <div class="form-help">
            <span data-ms="Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)" data-en="You can pick an image from your device storage. (Recommended: < 1.5MB)">Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)</span>
          </div>
          <img class="media-preview" id="publicSharingImagePreview" alt="Preview">
        </div>
        <div class="form-group">
          <label class="form-label" for="publicSharingVideoUrl">
            <span data-ms="URL Video (Pilihan)" data-en="Video URL (Optional)">URL Video (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="publicSharingVideoUrl" placeholder="https://youtube.com/... atau https://...mp4">
        </div>
        <div class="form-group">
          <label class="form-label" for="publicSharingLinkUrl">
            <span data-ms="URL Pautan (Pilihan)" data-en="Link URL (Optional)">URL Pautan (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="publicSharingLinkUrl" placeholder="https://...">
        </div>
<button type="submit" class="submit-btn" id="submitPublicSharingBtn"> <span data-ms="ðŸ“¤ Hantar Perkongsian" data-en="ðŸ“¤ Submit Sharing">ðŸ“¤ Hantar Perkongsian</span> </button>
      </form>
     </div>
     <div id="adminPanelSharing" class="admin-panel" style="display: none;">
      <h3 data-ms="Panel Pentadbir - Perkongsian" data-en="Admin Panel - Sharing">Panel Pentadbir - Perkongsian</h3>
      <p style="font-size: 0.9rem; margin-top: 0.5rem;" data-ms="Semua perkongsian daripada pengguna akan dipaparkan di bawah. Anda boleh memadam perkongsian yang tidak sesuai." data-en="All user submissions are displayed below. You can delete inappropriate content.">Semua perkongsian daripada pengguna akan dipaparkan di bawah. Anda boleh memadam perkongsian yang tidak sesuai.</p>
      <div id="sharingFormContainer" style="display: none; margin-top: 2rem; background: white; padding: 2rem; border-radius: 15px;">
       <h4 style="color: #ff6fa3; margin-bottom: 1.5rem;" data-ms="Tambah Perkongsian Baru" data-en="Add New Sharing">Tambah Perkongsian Baru</h4>
       <form class="booking-form" id="sharingForm">
        <div class="form-group"><label class="form-label" for="sharingTitleMs"> <span data-ms="Tajuk (Malay)" data-en="Title (Malay)">Tajuk (Malay)</span> </label> <input type="text" class="form-input" id="sharingTitleMs" required>
        </div>
        <div class="form-group"><label class="form-label" for="sharingTitleEn"> <span data-ms="Title (English)" data-en="Title (English)">Title (English)</span> </label> <input type="text" class="form-input" id="sharingTitleEn" required>
        </div>
        <div class="form-group"><label class="form-label" for="sharingContentMs"> <span data-ms="Kandungan (Malay)" data-en="Content (Malay)">Kandungan (Malay)</span> </label> <textarea class="form-textarea" id="sharingContentMs" required style="min-height: 150px;"></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="sharingContentEn"> <span data-ms="Content (English)" data-en="Content (English)">Content (English)</span> </label> <textarea class="form-textarea" id="sharingContentEn" required style="min-height: 150px;"></textarea>
        </div>
        <div class="form-group"><label class="form-label" for="sharingAuthor"> <span data-ms="Penulis" data-en="Author">Penulis</span> </label> <input type="text" class="form-input" id="sharingAuthor" required>
        </div>
        <div class="form-group"><label class="form-label" for="sharingDate"> <span data-ms="Tarikh" data-en="Date">Tarikh</span> </label> <input type="date" class="form-input" id="sharingDate" required>
        </div>
        <div class="form-group"><label class="form-label" for="sharingImageUrl"> <span data-ms="URL Gambar (Pilihan)" data-en="Image URL (Optional)">URL Gambar (Pilihan)</span> </label> <input type="url" class="form-input" id="sharingImageUrl" placeholder="https://...">
        </div>

        <div class="form-group">
          <label class="form-label" for="sharingImageFile">
            <span data-ms="Muat Naik Gambar (Pilihan)" data-en="Upload Image (Optional)">Muat Naik Gambar (Pilihan)</span>
          </label>
          <input type="file" class="form-input" id="sharingImageFile" accept="image/*">
          <div class="form-help">
            <span data-ms="Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)" data-en="You can pick an image from your device storage. (Recommended: < 1.5MB)">Anda boleh pilih gambar dari storan peranti. (Cadangan: < 1.5MB)</span>
          </div>
          <img class="media-preview" id="sharingImagePreview" alt="Preview">
        </div>
        <div class="form-group">
          <label class="form-label" for="sharingVideoUrl">
            <span data-ms="URL Video (Pilihan)" data-en="Video URL (Optional)">URL Video (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="sharingVideoUrl" placeholder="https://youtube.com/... atau https://...mp4">
        </div>
        <div class="form-group">
          <label class="form-label" for="sharingLinkUrl">
            <span data-ms="URL Pautan (Pilihan)" data-en="Link URL (Optional)">URL Pautan (Pilihan)</span>
          </label>
          <input type="url" class="form-input" id="sharingLinkUrl" placeholder="https://...">
        </div>

        <div style="display: flex; gap: 1rem;"><button type="submit" class="submit-btn" id="saveSharingBtn"> <span data-ms="Simpan Perkongsian" data-en="Save Sharing">Simpan Perkongsian</span> </button> <button type="button" class="submit-btn" id="cancelSharingBtn" style="background: #6c757d;"> <span data-ms="Batal" data-en="Cancel">Batal</span> </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bookings-list" id="sharingList"></div>
    </section>
    <section class="content-section hidden" id="guestbookSection">
     <h2 class="section-title"><span>ðŸ“–</span> <span data-ms="Buku Pelawat" data-en="Guest Book">Buku Pelawat</span></h2>
     <div class="empty-state">
      <div class="empty-state-icon">
       ðŸ“–
      </div>
      <p data-ms="Bahagian ini akan tersedia tidak lama lagi." data-en="This section will be available soon.">Bahagian ini akan tersedia tidak lama lagi.</p>
     </div>
    </section>
   </main><!-- Footer -->
   <footer class="main-footer">
    <p id="footerText">Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.</p>
   </footer>
  </div><!-- Floating Tutorial Button --> <button type="button" class="tutorial-floating-btn" id="tutorialBtn" title="Tutorial"> â” </button>
  <!-- Floating Chatbot Button --> <button class="chatbot-floating-btn hidden" id="chatbotBtn" title="AI Chatbot"> ðŸ¤– </button>

  <!-- Tutorial Role Picker Modal -->
  <div class="modal-overlay" id="tutorialRoleModal">
    <div class="modal-content" style="max-width: 520px;">
      <div class="modal-header">
        <h3 class="modal-title" data-ms="Apa yang anda hendak tahu?" data-en="What would you like to learn?">Apa yang anda hendak tahu?</h3>
        <button class="close-btn" id="closeTutorialRoleModal">âœ•</button>
      </div>
      <div style="padding: 0.25rem 0 0.75rem 0; color: #666; font-size: 0.95rem;">
        <span data-ms="Pilih topik tutorial yang anda mahu." data-en="Choose the tutorial topic you want.">Pilih topik tutorial yang anda mahu.</span>
      </div>

      <div id="tutorialTopicList" class="tutorial-topic-list"></div>

      <div style="margin-top: 0.9rem; font-size: 0.85rem; color: #888;">
        <span data-ms="Tip: Anda boleh tekan 'Skip' bila-bila masa." data-en="Tip: You can press 'Skip' anytime.">Tip: Anda boleh tekan 'Skip' bila-bila masa.</span>
      </div>
    </div>
  </div>

  <!-- Guided Tour Elements -->
  <div class="tour-overlay" id="tourOverlay"></div>
  <div class="tour-spotlight" id="tourSpotlight" title=""></div>
  <div class="tour-hand" id="tourHand">ðŸ‘‰</div>

  <div class="tour-helper-panel" id="tourHelperPanel">
    <div class="tour-helper-header">
      <div class="tour-helper-identity">
        <div class="tour-helper-avatar">âœ¨</div>
        <div style="min-width:0;">
          <div class="tour-helper-name">June</div>
          <div class="tour-helper-subtitle" id="tourHelperSubtitle" data-ms="Pembantu Sistem" data-en="System Helper">Pembantu Sistem</div>
        </div>
      </div>
      <button class="tour-helper-close" id="tourCloseBtn" title="Close">âœ•</button>
    </div>

    <div class="tour-helper-body">
      <div class="tour-step-title" id="tourStepTitle"></div>
      <div class="tour-step-text" id="tourStepText"></div>
    </div>

    <div class="tour-helper-footer">
      <div class="tour-progress" id="tourProgress"></div>
      <div class="tour-controls">
        <button class="tour-btn secondary" id="tourBackBtn" type="button">Back</button>
        <button class="tour-btn secondary" id="tourSkipBtn" type="button">Skip</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title" data-ms="Log Masuk Pentadbir" data-en="Admin Login">Log Masuk Pentadbir</h3><button class="close-btn" id="closeLoginModal">âœ•</button>
    </div>
    <form class="booking-form" id="loginForm">
     <div class="form-group"><label class="form-label" for="username"> <span data-ms="Nama Pengguna" data-en="Username">Nama Pengguna</span> </label> <input type="text" class="form-input" id="username" required>
     </div>
     <div class="form-group"><label class="form-label" for="password"> <span data-ms="Kata Laluan" data-en="Password">Kata Laluan</span> </label> <input type="password" class="form-input" id="password" required>
     </div><button type="submit" class="submit-btn"> <span data-ms="Log Masuk" data-en="Login">Log Masuk</span> </button>
    </form>
   </div>
   </div>
   <!-- Student Login Modal -->
<div class="modal-overlay" id="studentLoginModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Log Masuk Pelajar</h3>
      <button class="close-btn" id="closeStudentLoginModal">âœ•</button>
    </div>

    <form class="booking-form" id="studentLoginForm">
      <div class="form-group">
        <label class="form-label" for="studentId">No IC / ID Pelajar</label>
        <input type="text" class="form-input" id="studentId" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="studentPassword">Kata Laluan</label>
        <input type="password" class="form-input" id="studentPassword" required>
      </div>

      <button type="submit" class="submit-btn">Log Masuk</button>
    </form>
  </div>
</div>


  </div><!-- Edit Profile Modal -->
  <div class="modal-overlay" id="editProfileModal">
   <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
     <h3 class="modal-title" data-ms="Edit Profil Sekolah" data-en="Edit School Profile">Edit Profil Sekolah</h3><button class="close-btn" id="closeEditProfileModal">âœ•</button>
	</div>

    <form class="booking-form" id="editProfileForm">
     <div class="form-group"><label class="form-label" for="editSchoolNameMs"> <span data-ms="Nama Sekolah (Malay)" data-en="School Name (Malay)">Nama Sekolah (Malay)</span> </label> <input type="text" class="form-input" id="editSchoolNameMs" required>
     </div>
     <div class="form-group"><label class="form-label" for="editSchoolNameEn"> <span data-ms="School Name (English)" data-en="School Name (English)">School Name (English)</span> </label> <input type="text" class="form-input" id="editSchoolNameEn" required>
     </div>
     <div class="form-group"><label class="form-label" for="editLogoUrl"> <span data-ms="URL Logo Sekolah" data-en="School Logo URL">URL Logo Sekolah</span> </label> <input type="url" class="form-input" id="editLogoUrl" placeholder="https://...">
     </div>
     <div class="form-group"><label class="form-label" for="editStaffCount"> <span data-ms="Jumlah Guru" data-en="Staff Count">Jumlah Guru</span> </label> <input type="number" class="form-input" id="editStaffCount" required>
     </div>
     <div class="form-group"><label class="form-label" for="editStudentCount"> <span data-ms="Jumlah Murid" data-en="Student Count">Jumlah Murid</span> </label> <input type="number" class="form-input" id="editStudentCount" required>
     </div>
     <div class="form-group"><label class="form-label" for="editAddress"> <span data-ms="Alamat" data-en="Address">Alamat</span> </label> <input type="text" class="form-input" id="editAddress" required>
     </div>
     <div class="form-group"><label class="form-label" for="editEmail"> <span data-ms="Emel" data-en="Email">Emel</span> </label> <input type="email" class="form-input" id="editEmail" required>
     </div>
     <div class="form-group"><label class="form-label" for="editPhone"> <span data-ms="Telefon" data-en="Phone">Telefon</span> </label> <input type="tel" class="form-input" id="editPhone" required>
     </div>
     <div class="form-group"><label class="form-label" for="editVisionMs"> <span data-ms="Visi (Malay)" data-en="Vision (Malay)">Visi (Malay)</span> </label> <textarea class="form-textarea" id="editVisionMs" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editVisionEn"> <span data-ms="Vision (English)" data-en="Vision (English)">Vision (English)</span> </label> <textarea class="form-textarea" id="editVisionEn" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editMissionMs"> <span data-ms="Misi (Malay)" data-en="Mission (Malay)">Misi (Malay)</span> </label> <textarea class="form-textarea" id="editMissionMs" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editMissionEn"> <span data-ms="Mission (English)" data-en="Mission (English)">Mission (English)</span> </label> <textarea class="form-textarea" id="editMissionEn" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalName"> <span data-ms="Nama Pengetua" data-en="Principal Name">Nama Pengetua</span> </label> <input type="text" class="form-input" id="editPrincipalName" required>
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalPosition"> <span data-ms="Jawatan" data-en="Position">Jawatan</span> </label> <input type="text" class="form-input" id="editPrincipalPosition" required>
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalPhone"> <span data-ms="No HP Pengetua" data-en="Principal Phone">No HP Pengetua</span> </label> <input type="tel" class="form-input" id="editPrincipalPhone" required>
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalPhotoUrl"> <span data-ms="URL Foto Pengetua" data-en="Principal Photo URL">URL Foto Pengetua</span> </label> <input type="url" class="form-input" id="editPrincipalPhotoUrl" placeholder="https://...">
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalMessageMs"> <span data-ms="Ucapan Pentadbir (Malay)" data-en="Principal's Message (Malay)">Ucapan Pentadbir (Malay)</span> </label> <textarea class="form-textarea" id="editPrincipalMessageMs" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editPrincipalMessageEn"> <span data-ms="Principal's Message (English)" data-en="Principal's Message (English)">Principal's Message (English)</span> </label> <textarea class="form-textarea" id="editPrincipalMessageEn" required></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="editFooterText"> <span data-ms="Teks Footer" data-en="Footer Text">Teks Footer</span> </label> <input type="text" class="form-input" id="editFooterText" required>
     </div><button type="submit" class="submit-btn" id="saveProfileBtn"> <span data-ms="Simpan" data-en="Save">Simpan</span> </button>
    </form>
   </div>
  </div>
  <script>
    // Global state
    // Global state
let currentLang = 'ms';
let isLoggedIn = false;
let userRole = null;
let allData = [];

// Home Hero Slider state
let homeHeroIndex = 0;
let homeHeroTimer = null;
let homeHeroItems = [];
let homeHeroTouchStartX = null;

// Status login pelajar
let isStudentLoggedIn = false;
let currentStudent = null;

// Password default semua pelajar
const STUDENT_DEFAULT_PASSWORD = "123456";

// ====== v4 (Jan 2026): Slot kapasiti + Reset katil harian + CSV export + Email notifikasi (EmailJS) ======
const EPR_CFG = {
  CLINIC_DAILY_CAPACITY: 15,          // Had tempahan klinik per tarikh
  BED_AUTO_RESET_DAILY: true,         // Reset semua katil pada 00:00 setiap hari
  BED_RESET_KEY: 'eprihatin_last_bed_reset_date',
  AUDIT_LOG_ENABLED: true
};

// EmailJS (Cara A) â€” isi nilai ini bila dah create EmailJS service + template
// Nota: "template_params" ikut nama parameter yang awak set dalam template EmailJS.
const EPR_EMAILJS = {
  enabled: true,
  serviceId: 'service_yhwdq7w',
  templateId: 'template_038kkgl',
  publicKey: 'LfssxfgkZyg2-AVZK',
  endpoint: 'https://api.emailjs.com/api/v1.0/email/send'
};

let __eprMidnightTimer = null;
let __eprAutoExpireRunning = false;

function eprLocalISODate(d = new Date()) {
  const tzOff = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tzOff).toISOString().slice(0, 10); // YYYY-MM-DD local
}

function eprNextMidnightISO(fromDateStr) {
  // fromDateStr: YYYY-MM-DD
  const [y, m, day] = (fromDateStr || eprLocalISODate()).split('-').map(Number);
  const dt = new Date(y, (m - 1), day + 1, 0, 0, 0, 0); // next day 00:00 local
  return dt.toISOString();
}

function eprFilterByDateRange(list, startDate, endDate) {
  const s = startDate || '';
  const e = endDate || '';
  return (list || []).filter(b => {
    const d = (b.date || '').slice(0, 10);
    if (!d) return false;
    if (s && d < s) return false;
    if (e && d > e) return false;
    return true;
  });
}

function eprClinicIsActiveStatus(status) {
  const s = (status || '').toLowerCase();
  return s !== 'rejected' && s !== 'deleted' && s !== 'completed' && s !== 'expired';
}

function eprGetClinicActiveCount(dateStr) {
  if (!dateStr) return 0;
  return allData.filter(b => (b.booking_type === 'clinic' || b.type === 'clinic') &&
    (b.date || '').slice(0, 10) === dateStr &&
    eprClinicIsActiveStatus(b.status)
  ).length;
}

function eprHasDuplicateClinicBooking(dateStr, timeStr, studentName, studentIc) {
  const nameKey = (studentName || '').trim().toLowerCase();
  const icKey = (studentIc || '').trim();
  return allData.some(b => (b.booking_type === 'clinic' || b.type === 'clinic') &&
    (b.date || '').slice(0, 10) === dateStr &&
    eprClinicIsActiveStatus(b.status) &&
    (
      (icKey && (b.student_ic || '').trim() === icKey) ||
      (!icKey && (b.student_name || '').trim().toLowerCase() === nameKey) ||
      (icKey && (b.student_name || '').trim().toLowerCase() === nameKey)
    ) &&
    // kalau ada time, elak duplicate slot sama
    (!timeStr || (b.time || '') === timeStr)
  );
}

function eprUpdateClinicCapacityHint() {
  const dateEl = document.getElementById('clinicDate');
  const hintEl = document.getElementById('clinicCapacityHint');
  if (!dateEl || !hintEl) return;

  const dateStr = dateEl.value;
  if (!dateStr) {
    hintEl.textContent = '';
    return;
  }

  const used = eprGetClinicActiveCount(dateStr);
  const left = Math.max(0, EPR_CFG.CLINIC_DAILY_CAPACITY - used);

  hintEl.textContent = (currentLang === 'ms')
    ? `Slot tinggal: ${left}/${EPR_CFG.CLINIC_DAILY_CAPACITY} (untuk tarikh ${dateStr})`
    : `Slots left: ${left}/${EPR_CFG.CLINIC_DAILY_CAPACITY} (for ${dateStr})`;

  hintEl.style.color = (left === 0) ? '#b00020' : '';
}

async function eprLogAudit(action, booking, extra = {}) {
  try {
    if (!EPR_CFG.AUDIT_LOG_ENABLED || !window.dataSdk) return;
    const actor = (userRole || (isStudentLoggedIn ? 'student' : 'guest')) || 'unknown';
    const actorName = (actor === 'student' && currentStudent && currentStudent.name) ? currentStudent.name : actor;
    const record = {
      id: 'audit_' + Date.now(),
      type: 'audit',
      action,
      actor_role: actor,
      actor_name: actorName,
      booking_id: booking ? (booking.__backendId || booking.id) : '',
      reference_number: booking ? (booking.reference_number || '') : '',
      booking_type: booking ? (booking.booking_type || booking.type || '') : '',
      timestamp: new Date().toISOString(),
      ...extra
    };
    await window.dataSdk.create(record);
  } catch (e) {
    console.warn('Audit log gagal', e);
  }
}

async function eprSendEmailStatus(booking, newStatus, reason = '') {
  try {
    if (!EPR_EMAILJS.enabled) return { ok: false, skipped: true };
    const toEmail = (booking && (booking.student_email || booking.email || '') || '').trim();
    if (!toEmail) return { ok: false, skipped: true };

    const isClinic = (booking.booking_type === 'clinic' || booking.type === 'clinic');
    const statusLabelMs = (newStatus === 'confirmed') ? 'DISAHKAN' : (newStatus === 'rejected' ? 'DITOLAK' : newStatus);
    const statusLabelEn = (newStatus === 'confirmed') ? 'APPROVED' : (newStatus === 'rejected' ? 'REJECTED' : newStatus);

    const subject = (currentLang === 'ms')
      ? `${isClinic ? 'Tempahan Klinik' : 'Tempahan Katil Sakit'} ${statusLabelMs} (${booking.reference_number || booking.id})`
      : `${isClinic ? 'Clinic Booking' : 'Sick Bed Booking'} ${statusLabelEn} (${booking.reference_number || booking.id})`;

    const message = (currentLang === 'ms')
      ? `Status tempahan anda: ${statusLabelMs}\nTarikh: ${booking.date || '-'}\nMasa: ${booking.time || booking.start_time || '-'}\nNo. Rujukan: ${booking.reference_number || booking.id}\n${reason ? `Sebab/Catatan: ${reason}\n` : ''}`
      : `Your booking status: ${statusLabelEn}\nDate: ${booking.date || '-'}\nTime: ${booking.time || booking.start_time || '-'}\nReference: ${booking.reference_number || booking.id}\n${reason ? `Reason/Note: ${reason}\n` : ''}`;

    const payload = {
      service_id: EPR_EMAILJS.serviceId,
      template_id: EPR_EMAILJS.templateId,
      user_id: EPR_EMAILJS.publicKey,
      template_params: {
        to_email: toEmail,
        subject,
        message,
        student_name: booking.student_name || '',
        reference_number: booking.reference_number || booking.id,
        booking_date: booking.date || '',
        booking_time: booking.time || booking.start_time || '',
        status: newStatus,
        reason: reason || ''
      }
    };

    const res = await fetch(EPR_EMAILJS.endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return { ok: res.ok, status: res.status };
  } catch (e) {
    console.warn('EmailJS gagal', e);
    return { ok: false, error: String(e) };
  }
}

async function eprExpireRoomBookingsIfNeeded() {
  if (__eprAutoExpireRunning) return;
  __eprAutoExpireRunning = true;
  try {
    if (!window.dataSdk) return;
    const now = new Date();
    const today = eprLocalISODate(now);

    // kalau dah pernah reset hari ni, skip (untuk elak loop)
    const last = localStorage.getItem(EPR_CFG.BED_RESET_KEY) || '';
    if (last === today) return;

    if (!EPR_CFG.BED_AUTO_RESET_DAILY) return;

    // Tukar semua room booking yang masih aktif kepada completed (reset katil)
    const activeRooms = allData.filter(b =>
      (b.booking_type === 'room' || b.type === 'room') &&
      ((b.status || '').toLowerCase() === 'confirmed' || (b.status || '').toLowerCase() === 'pending')
    );

    if (activeRooms.length) {
      for (const b of activeRooms) {
        b.status = 'completed';
        b.completed_at = now.toISOString();
        b.admin_notes = (b.admin_notes || '') + (b.admin_notes ? ' | ' : '') + 'Auto reset 00:00';
        await window.dataSdk.update(b);
        await eprLogAudit('bed_auto_reset_completed', b, { note: 'Auto reset harian 00:00' });
      }
    } else {
      await eprLogAudit('bed_auto_reset_noop', null, { note: 'Tiada tempahan katil aktif' });
    }

    localStorage.setItem(EPR_CFG.BED_RESET_KEY, today);
    if (activeRooms.length) {
      showInlineMessage('roomSuccessMessage',
        currentLang === 'ms'
          ? 'â„¹ï¸ Reset harian: semua katil telah ditetapkan semula (available).'
          : 'â„¹ï¸ Daily reset: all beds have been reset (available).',
        'success'
      );
    }
} catch (e) {
    console.warn('Auto reset katil gagal', e);
  } finally {
    __eprAutoExpireRunning = false;
  }
}

function eprScheduleNextMidnightReset() {
  if (!EPR_CFG.BED_AUTO_RESET_DAILY) return;

  if (__eprMidnightTimer) {
    clearTimeout(__eprMidnightTimer);
    __eprMidnightTimer = null;
  }

  const now = new Date();
  const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 2); // 00:00:02
  const ms = Math.max(1000, nextMidnight.getTime() - now.getTime());

  __eprMidnightTimer = setTimeout(async () => {
    await eprExpireRoomBookingsIfNeeded();
    eprScheduleNextMidnightReset(); // jadualkan untuk esok pula
  }, ms);
}
// ====== end v4 helpers ======

// SENARAI PELAJAR
// ðŸ‘‰ IC = No KP pelajar (tanpa dash)
// ðŸ‘‰ name = Nama pelajar (ikut Excel)
const studentAccounts = [
  {
    ic: '010203040501',
    name: 'ALI BIN CONTOH'
  },
  {
    ic: '020304050607',
    name: 'SITI BINTI CONTOH'
  }
  // â— Tambah lagi baris di sini untuk pelajar lain
  // { ic: 'NOICLAIN', name: 'NAMA PELAJAR LAIN' },
];

    // Default config
    const defaultConfig = {
      system_title_ms: 'e-PRIhatin PELAJAR',
      system_title_en: 'e-PRIhatin STUDENT',
      welcome_message_ms: 'Selamat Datang',
      welcome_message_en: 'Welcome',
      primary_color: '#ff6fa3',
      secondary_color: '#ffd6e7',
      text_color: '#333333',
      accent_color: '#ff9ec5',
      background_color: '#ffeef7'
    };

    // Data handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        updateProfileDisplay();
        updateBookingsDisplay();
        eprUpdateClinicCapacityHint();
      renderMedicines();

      function __clearPreview(imgId, fileId){
        const img = document.getElementById(imgId);
        const fi = document.getElementById(fileId);
        if (img) { img.style.display='none'; img.src=''; }
        if (fi) { fi.value=''; }
      }
      const __formsToClear = [
        {form:'announcementForm', img:'announcementImagePreview', file:'announcementImageFile'},
        {form:'programForm', img:'programImagePreview', file:'programImageFile'},
        {form:'achievementForm', img:'achievementImagePreview', file:'achievementImageFile'},
        {form:'publicSharingForm', img:'publicSharingImagePreview', file:'publicSharingImageFile'},
        {form:'sharingForm', img:'sharingImagePreview', file:'sharingImageFile'}
      ];
      __formsToClear.forEach(x=>{
        const f=document.getElementById(x.form);
        if (!f) return;
        f.addEventListener('reset', ()=>__clearPreview(x.img,x.file));
      });

      }
    };
	
// ðŸ”½ðŸ”½ðŸ”½ TAMBAH Fallback di sini (TANPA <script>) ðŸ”½ðŸ”½ðŸ”½
(function () {
  // Kalau memang ada dataSdk sebenar (dari server), jangan override
  if (window.dataSdk) return;

  console.log('dataSdk tiada, guna fallback localStorage');

  const STORAGE_KEY = 'eprihatin_data_v1';

  function loadFromLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('Gagal baca localStorage', e);
      return [];
    }
  }

  function saveToLocal(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error('Gagal simpan localStorage', e);
    }
  }

  // Isi data awal dari localStorage
  allData = loadFromLocal();

  // Emulate dataSdk API
  window.dataSdk = {
    async init(handler) {
      if (handler && typeof handler.onDataChanged === 'function') {
        handler.onDataChanged(allData);
      }
      return { isOk: true };
    },

    async create(record) {
      record.__backendId = record.__backendId || record.id || ('id_' + Date.now());
      allData.push(record);
      saveToLocal(allData);

      if (dataHandler && typeof dataHandler.onDataChanged === 'function') {
        dataHandler.onDataChanged(allData);
      }
      return { isOk: true };
    },

    async update(record) {
      const id = record.__backendId || record.id;
      const idx = allData.findIndex(d => (d.__backendId || d.id) === id);

      if (idx !== -1)  {
        allData[idx] = { 
  ...allData[idx],
  ...record
};


      } else {
        allData.push(record);
      }

      saveToLocal(allData);

      if (dataHandler && typeof dataHandler.onDataChanged === 'function') {
        dataHandler.onDataChanged(allData);
      }
      return { isOk: true };
    },

    async delete(record) {
      const id = record.__backendId || record.id;
      allData = allData.filter(d => (d.__backendId || d.id) !== id);

      saveToLocal(allData);

      if (dataHandler && typeof dataHandler.onDataChanged === 'function') {
        dataHandler.onDataChanged(allData);
      }
      return { isOk: true };
    }
  };
})();

// ðŸ”¼ðŸ”¼ðŸ”¼ Habis fallback ðŸ”¼ðŸ”¼ðŸ”¼

    // Initialize SDK
    async function initializeApp() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const title = currentLang === 'ms' ? 
              (config.system_title_ms || defaultConfig.system_title_ms) : 
              (config.system_title_en || defaultConfig.system_title_en);
            
            const schoolNameEl = document.getElementById('schoolName');
            if (schoolNameEl) {
              schoolNameEl.textContent = title;
            }

            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            const textColor = config.text_color || defaultConfig.text_color;

            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);
            document.documentElement.style.setProperty('--text-color', textColor);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                }
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ secondary_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['system_title_ms', config.system_title_ms || defaultConfig.system_title_ms],
            ['system_title_en', config.system_title_en || defaultConfig.system_title_en],
            ['welcome_message_ms', config.welcome_message_ms || defaultConfig.welcome_message_ms],
            ['welcome_message_en', config.welcome_message_en || defaultConfig.welcome_message_en]
          ])
        });
      }

      updateDateTime();
      setInterval(updateDateTime, 1000);
      setupEventListeners();
      updateLanguage();
    
      // v4 init: slot kapasiti & reset katil harian
      eprUpdateClinicCapacityHint();
      await eprExpireRoomBookingsIfNeeded();
      eprScheduleNextMidnightReset();

}

    // Update date time
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      const dateStr = now.toLocaleDateString(currentLang === 'ms' ? 'ms-MY' : 'en-US', options);
      const dateTimeEl = document.getElementById('datetime');
      if (dateTimeEl) {
        dateTimeEl.textContent = dateStr;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Hamburger menu
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const sidebar = document.getElementById('sidebar');
      if (hamburgerBtn && sidebar) {
        hamburgerBtn.addEventListener('click', () => {
          sidebar.classList.toggle('mobile-visible');
        });
      }
    // Setup event untuk Login Pelajar
    function setupStudentLogin() {
      const studentLoginBtn = document.getElementById('studentLoginBtn');
      const studentLoginModal = document.getElementById('studentLoginModal');
      const closeStudentLoginModal = document.getElementById('closeStudentLoginModal');
      const studentLoginForm = document.getElementById('studentLoginForm');

      // Klik butang di header
      if (studentLoginBtn && studentLoginModal) {
        studentLoginBtn.addEventListener('click', () => {
          if (isStudentLoggedIn) {
            // Kalau dah login â†’ logout
            handleStudentLogout();
          } else {
            // Kalau belum â†’ buka modal
            studentLoginModal.classList.add('active');
          }
        });
      }

      // Butang X tutup modal
      if (closeStudentLoginModal && studentLoginModal) {
        closeStudentLoginModal.addEventListener('click', () => {
          studentLoginModal.classList.remove('active');
        });
      }

      // Klik luar kotak â†’ tutup modal
      if (studentLoginModal) {
        studentLoginModal.addEventListener('click', (e) => {
          if (e.target === studentLoginModal) {
            studentLoginModal.classList.remove('active');
          }
        });
      }

      // Submit form login pelajar
      if (studentLoginForm) {
        studentLoginForm.addEventListener('submit', handleStudentLogin);
      }
    }
// ðŸ”´ Tambah baris ini
  setupStudentLogin();
      // Sidebar toggle button
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      if (sidebarToggleBtn && sidebar) {
        sidebarToggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          // Update button icon
          if (sidebar.classList.contains('collapsed')) {
            sidebarToggleBtn.textContent = 'â–¶';
          } else {
            sidebarToggleBtn.textContent = 'â—€';
          }
        });
      }

      // Language toggle
      const langToggle = document.getElementById('langToggle');
      if (langToggle) {
        langToggle.addEventListener('click', () => {
          currentLang = currentLang === 'ms' ? 'en' : 'ms';
          langToggle.textContent = currentLang === 'ms' ? 'EN' : 'MS';
          updateLanguage();
          updateDateTime();
        });
      }

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          themeToggle.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
        });
      }

// Login button (ADMINADMIN)
const loginBtn = document.getElementById('loginBtn');
const loginModal = document.getElementById('loginModal');
const closeLoginModal = document.getElementById('closeLoginModal');

if (loginBtn && loginModal) {
  loginBtn.addEventListener('click', () => {
    if (isLoggedIn) {
      // Admin sudah login â†’ klik untuk logout
      handleLogout();
    } else {
      // Admin belum login â†’ buka modal admin
      loginModal.classList.add('active');
    }
  });
}

if (closeLoginModal && loginModal) {
  closeLoginModal.addEventListener('click', () => {
    loginModal.classList.remove('active');
  });
}
const loginForm = document.getElementById('loginForm');
if (loginForm) {
  loginForm.addEventListener('submit', handleLogin);
}



      // Sidebar navigation
      const sidebarItems = document.querySelectorAll('.sidebar-item');
      sidebarItems.forEach(item => {
        item.addEventListener('click', () => {
          const section = item.getAttribute('data-section');
          navigateToSection(section);
          
          sidebarItems.forEach(si => si.classList.remove('active'));
          item.classList.add('active');
          
          if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
              sidebar.classList.remove('mobile-visible');
            }
          }
        });
      });

      // Clinic booking form
      const clinicBookingForm = document.getElementById('clinicBookingForm');
      if (clinicBookingForm) {
        clinicBookingForm.addEventListener('submit', handleClinicBooking);
      }

      // Room booking form
      const roomBookingForm = document.getElementById('roomBookingForm');
      if (roomBookingForm) {
        roomBookingForm.addEventListener('submit', handleRoomBooking);
      }

      // Edit profile button
      const editProfileBtn = document.getElementById('editProfileBtn');
      const editProfileModal = document.getElementById('editProfileModal');
      const closeEditProfileModal = document.getElementById('closeEditProfileModal');
      
      if (editProfileBtn && editProfileModal) {
        editProfileBtn.addEventListener('click', () => {
          populateEditProfileForm();
          editProfileModal.classList.add('active');
        });
      }

      if (closeEditProfileModal && editProfileModal) {
        closeEditProfileModal.addEventListener('click', () => {
          editProfileModal.classList.remove('active');
        });
      }

      // Edit profile form
      const editProfileForm = document.getElementById('editProfileForm');
      if (editProfileForm) {
        editProfileForm.addEventListener('submit', handleEditProfile);
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }

      // Chatbot settings form
      const chatbotSettingsForm = document.getElementById('chatbotSettingsForm');
      if (chatbotSettingsForm) {
        chatbotSettingsForm.addEventListener('submit', handleChatbotSettings);
      }

      // Chatbot button click
      const chatbotBtn = document.getElementById('chatbotBtn');
      if (chatbotBtn) {
        chatbotBtn.addEventListener('click', handleChatbotClick);
      }

      // Announcement form handlers
      const addAnnouncementBtn = document.getElementById('addAnnouncementBtn');
      const announcementFormContainer = document.getElementById('announcementFormContainer');
      const cancelAnnouncementBtn = document.getElementById('cancelAnnouncementBtn');
      const announcementForm = document.getElementById('announcementForm');

      if (addAnnouncementBtn && announcementFormContainer) {
        addAnnouncementBtn.addEventListener('click', () => {
          announcementFormContainer.style.display = 'block';
          announcementForm.reset();
        });
      }

      if (cancelAnnouncementBtn && announcementFormContainer) {
        cancelAnnouncementBtn.addEventListener('click', () => {
          announcementFormContainer.style.display = 'none';
          announcementForm.reset();
        });
      }

      if (announcementForm) {
        announcementForm.addEventListener('submit', handleAnnouncementSubmit);
      }

      // Program form handlers
      const addProgramBtn = document.getElementById('addProgramBtn');
      const programFormContainer = document.getElementById('programFormContainer');
      const cancelProgramBtn = document.getElementById('cancelProgramBtn');
      const programForm = document.getElementById('programForm');

      if (addProgramBtn && programFormContainer) {
        addProgramBtn.addEventListener('click', () => {
          programFormContainer.style.display = 'block';
          programForm.reset();
        });
      }

      if (cancelProgramBtn && programFormContainer) {
        cancelProgramBtn.addEventListener('click', () => {
          programFormContainer.style.display = 'none';
          programForm.reset();
        });
      }

      if (programForm) {
        programForm.addEventListener('submit', handleProgramSubmit);
      }

      // Achievement form handlers
      const addAchievementBtn = document.getElementById('addAchievementBtn');
      const achievementFormContainer = document.getElementById('achievementFormContainer');
      const cancelAchievementBtn = document.getElementById('cancelAchievementBtn');
      const achievementForm = document.getElementById('achievementForm');

      if (addAchievementBtn && achievementFormContainer) {
        addAchievementBtn.addEventListener('click', () => {
          achievementFormContainer.style.display = 'block';
          achievementForm.reset();
        });
      }

      if (cancelAchievementBtn && achievementFormContainer) {
        cancelAchievementBtn.addEventListener('click', () => {
          achievementFormContainer.style.display = 'none';
          achievementForm.reset();
        });
      }

      if (achievementForm) {
        achievementForm.addEventListener('submit', handleAchievementSubmit);
      }

      // Schedule form handlers
      const addScheduleBtn = document.getElementById('addScheduleBtn');
      const scheduleFormContainer = document.getElementById('scheduleFormContainer');
      const cancelScheduleBtn = document.getElementById('cancelScheduleBtn');
      const scheduleForm = document.getElementById('scheduleForm');

      if (addScheduleBtn && scheduleFormContainer) {
        addScheduleBtn.addEventListener('click', () => {
          scheduleFormContainer.style.display = 'block';
          scheduleForm.reset();
        });
      }

      if (cancelScheduleBtn && scheduleFormContainer) {
        cancelScheduleBtn.addEventListener('click', () => {
          scheduleFormContainer.style.display = 'none';
          scheduleForm.reset();
        });
      }

      if (scheduleForm) {
        scheduleForm.addEventListener('submit', handleScheduleSubmit);
      }

      // Public sharing form handler
      const publicSharingForm = document.getElementById('publicSharingForm');
      if (publicSharingForm) {
        publicSharingForm.addEventListener('submit', handlePublicSharingSubmit);
      }

      // Guestbook form
      const guestbookForm = document.getElementById('guestbookForm');
      if (guestbookForm) {
        guestbookForm.addEventListener('submit', handleGuestbookSubmit);
      }
    
      // v4: slot klinik â€” paparkan baki slot bila pilih tarikh
      const clinicDateInput = document.getElementById('clinicDate');
      if (clinicDateInput) {
        clinicDateInput.addEventListener('change', eprUpdateClinicCapacityHint);
        clinicDateInput.addEventListener('input', eprUpdateClinicCapacityHint);
      }

}

    // Handle login
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (username === 'admin' && password === 'akuadmin') {
  isLoggedIn = true;
  userRole = 'admin';

  localStorage.setItem('adminLoggedIn', 'true');
  localStorage.setItem('adminRole', userRole);

  const loginModal = document.getElementById('loginModal');
  if (loginModal) {
    loginModal.classList.remove('active');
  }

        
        updateLoginState();
        
        const form = e.target;
        if (form) {
          form.reset();
        }
      } else {
        const errorMsg = currentLang === 'ms' ? 
          'Nama pengguna atau kata laluan salah!' : 
          'Incorrect username or password!';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
      }
    }

    // Handle logout
    function handleLogout() {
      isLoggedIn = false;
      userRole = null;
      
      // Buang status login dari localStorage
      localStorage.removeItem('adminLoggedIn');
      localStorage.removeItem('adminRole');
      
      updateLoginState();
    }
       
    // --------------------------------
    // LOGIN / LOGOUT PELAJAR
    // --------------------------------
    function handleStudentLogin(e) {
      e.preventDefault();

      const icInput = document.getElementById('studentId');
      const passwordInput = document.getElementById('studentPassword');

      if (!icInput || !passwordInput) return;

      const ic = icInput.value.trim();
      const password = passwordInput.value.trim();

      if (!ic) {
        alert('Sila masukkan No. IC pelajar.');
        return;
      }

      // Semua pelajar guna password sama: 123456
      if (password !== STUDENT_DEFAULT_PASSWORD) {
        alert('Kata laluan pelajar salah. Gunakan 123456.');
        return;
      }

      // Buang simbol/dash kalau pelajar tulis IC dengan -
      const cleanIc = ic.replace(/\D/g, '');

      // Cari pelajar dalam senarai studentAccounts
      const student = studentAccounts.find(
        s => s.ic.replace(/\D/g, '') === cleanIc
      );

      if (!student) {
        alert('No. IC pelajar tidak dijumpai dalam senarai.');
        return;
      }

      // âœ… Berjaya login
      isStudentLoggedIn = true;
      currentStudent = student;

      // Tutup modal
      const modal = document.getElementById('studentLoginModal');
      if (modal) modal.classList.remove('active');

      // Kosongkan input
      icInput.value = '';
      passwordInput.value = '';

      // Tukar teks pada butang Login Pelajar
      const btnText = document.getElementById('studentLoginBtnText');
      if (btnText) {
        btnText.textContent = 'Log Keluar Pelajar';
      }

           console.log('Pelajar login:', currentStudent);
      updateStudentUIAfterLogin(); // ðŸ‘ˆ TAMBAH BARIS INI
    }


    function handleStudentLogout() {
      isStudentLoggedIn = false;
      currentStudent = null;

      const btnText = document.getElementById('studentLoginBtnText');
      if (btnText) {
        btnText.textContent = 'Login Pelajar';
      }

      console.log('Pelajar logout');
	    // ============================
  // RESET FIELD NAMA (CLINIK)
  // ============================
  const clinicNameInput = document.getElementById('studentName');
  if (clinicNameInput) {
    clinicNameInput.value = '';
    clinicNameInput.readOnly = false;
    clinicNameInput.classList.remove('readonly-field');
  }

  // ============================
  // RESET FIELD NAMA (KATIL SAKIT)
  // ============================
  const bedNameInput = document.getElementById('studentName2'); 
  if (bedNameInput) {
    bedNameInput.value = '';
    bedNameInput.readOnly = false;
    bedNameInput.classList.remove('readonly-field');
  }

  // ============================
  // RESET TEKS SELAMAT DATANG
  // ============================
  const welcomeEl = document.getElementById('studentWelcomeText');
  if (welcomeEl) {
    welcomeEl.textContent = '';
  }

    }
	
function updateStudentUIAfterLogin() {
  if (!currentStudent) return;

  // 1. Teks "Selamat datang"
  const welcomeEl = document.getElementById('studentWelcomeText');
  if (welcomeEl) {
    welcomeEl.textContent = `Selamat datang, ${currentStudent.name}`;
  }

  // 2. Auto isi nama pelajar dalam Tempahan Klinik
  const clinicNameInput = document.getElementById('studentName');
  if (clinicNameInput) {
    clinicNameInput.value = currentStudent.name;
    clinicNameInput.readOnly = true;
    clinicNameInput.classList.add('readonly-field');
  }

   // 3. Auto isi nama pelajar dalam Tempahan Katil Sakit
  const bedNameInput = document.getElementById('studentName2');
  if (bedNameInput) {
    bedNameInput.value = currentStudent.name;
    bedNameInput.readOnly = true;
    bedNameInput.classList.add('readonly-field');
  }

  // 4. Auto isi emel (jika ada dalam senarai pelajar)
  const emailVal = (currentStudent.email || '').trim();
  if (emailVal) {
    const clinicEmailInput = document.getElementById('studentEmail');
    if (clinicEmailInput) clinicEmailInput.value = emailVal;

    const bedEmailInput = document.getElementById('studentEmail2');
    if (bedEmailInput) bedEmailInput.value = emailVal;
  }

}
//010203040501

    // Check login status dari localStorage
    function checkLoginStatus() {
      const savedLogin = localStorage.getItem('adminLoggedIn');
      const savedRole = localStorage.getItem('adminRole');
      
      if (savedLogin === 'true' && savedRole) {
        isLoggedIn = true;
        userRole = savedRole;
        updateLoginState();
      }
    }

    // Update login state
    function updateLoginState() {
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const adminPanels = document.querySelectorAll('.admin-panel');

      if (loginBtn && loginBtnText) {
        if (isLoggedIn) {
          loginBtnText.textContent = currentLang === 'ms' ? 'Log Keluar' : 'Logout';
          loginBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        } else {
          loginBtnText.textContent = currentLang === 'ms' ? 'Login Admin' : 'Admin Login';
          loginBtn.style.background = 'linear-gradient(135deg, #ff6fa3 0%, #ff9ec5 100%)';
        }
      }

      adminPanels.forEach(panel => {
        if (panel) {
          panel.style.display = isLoggedIn ? 'block' : 'none';
        }
      });

      // Refresh semua display supaya butang admin muncul
      updateBookingsDisplay();
      renderMedicines();

      function __clearPreview(imgId, fileId){
        const img = document.getElementById(imgId);
        const fi = document.getElementById(fileId);
        if (img) { img.style.display='none'; img.src=''; }
        if (fi) { fi.value=''; }
      }
      const __formsToClear = [
        {form:'announcementForm', img:'announcementImagePreview', file:'announcementImageFile'},
        {form:'programForm', img:'programImagePreview', file:'programImageFile'},
        {form:'achievementForm', img:'achievementImagePreview', file:'achievementImageFile'},
        {form:'publicSharingForm', img:'publicSharingImagePreview', file:'publicSharingImageFile'},
        {form:'sharingForm', img:'sharingImagePreview', file:'sharingImageFile'}
      ];
      __formsToClear.forEach(x=>{
        const f=document.getElementById(x.form);
        if (!f) return;
        f.addEventListener('reset', ()=>__clearPreview(x.img,x.file));
      });

    }

    // ===============================
// FUNGSI NAVIGATE ANTARA PAGE
// ===============================
function navigateToSection(sectionName) {
  // Sembunyikan semua section
  const sections = document.querySelectorAll('.content-section');
  sections.forEach(section => {
    section.classList.add('hidden');
  });

  // Buka section yang dipilih
  const target = document.getElementById(sectionName + 'Section');
  if (target) {
    target.classList.remove('hidden');
  }
}


    // Update language
    function updateLanguage() {
      const elements = document.querySelectorAll('[data-ms][data-en]');
      elements.forEach(el => {
        const text = currentLang === 'ms' ? el.getAttribute('data-ms') : el.getAttribute('data-en');
        if (text) {
          if (el.tagName === 'INPUT' && el.type !== 'submit') {
            el.placeholder = text;
          } else if (el.tagName === 'OPTION') {
            el.textContent = text;
          } else {
            el.textContent = text;
          }
        }
      });
    
      try { renderMedicines(); } catch {}
      try { updateBookingsDisplay(); } catch {}
    }

// Handle clinic booking
    async function handleClinicBooking(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('clinicSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menghantar...' : 'Submitting...');

      // ===== Slot kapasiti klinik (15 orang / tarikh) + elak duplicate =====
      const __clinicDate = document.getElementById('clinicDate').value;
      const __expiresAt = eprNextMidnightISO(__clinicDate);
      const __clinicTime = document.getElementById('clinicTime').value;
      const __studentName = document.getElementById('studentName').value;
      const __studentIc = (currentStudent && currentStudent.ic) ? currentStudent.ic : '';

      const __used = eprGetClinicActiveCount(__clinicDate);
      if (__used >= EPR_CFG.CLINIC_DAILY_CAPACITY) {
        showInlineMessage('clinicSuccessMessage',
          currentLang === 'ms'
            ? `âŒ Slot penuh untuk ${__clinicDate}. Had: ${EPR_CFG.CLINIC_DAILY_CAPACITY} tempahan.`
            : `âŒ Slots are full for ${__clinicDate}. Limit: ${EPR_CFG.CLINIC_DAILY_CAPACITY}.`,
          'error'
        );
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        eprUpdateClinicCapacityHint();
        return;
      }

      if (eprHasDuplicateClinicBooking(__clinicDate, __clinicTime, __studentName, __studentIc)) {
        showInlineMessage('clinicSuccessMessage',
          currentLang === 'ms'
            ? 'âŒ Anda sudah ada tempahan (slot sama) untuk tarikh ini.'
            : 'âŒ You already have a booking (same slot) for this date.',
          'error'
        );
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      const bookingData = {
        id: 'clinic_' + Date.now(),
        type: 'clinic',
        booking_type: 'clinic',
        appointment_type: document.getElementById('appointmentType').value,
        date: document.getElementById('clinicDate').value,
        time: document.getElementById('clinicTime').value,
        student_name: document.getElementById('studentName').value,
        student_email: (document.getElementById('studentEmail') ? document.getElementById('studentEmail').value.trim() : ''),
        student_ic: (currentStudent && currentStudent.ic) ? currentStudent.ic : '',
		student_category: document.getElementById('studentCategory').value,
        class_name: document.getElementById('className').value,
        guardian_phone: document.getElementById('guardianPhone').value || '',
        symptoms: document.getElementById('symptoms').value,
        is_urgent: document.getElementById('isUrgent').checked,
        document_url: document.getElementById('documentUrl').value || '',
        document_file: (document.getElementById('documentFileData') ? (document.getElementById('documentFileData').value || '') : ''),
        status: 'pending',
        reference_number: 'CLN' + Date.now().toString().slice(-8),
        created_at: new Date().toISOString(),
        expires_at: __expiresAt,
        admin_notes: ''
      };

      if (window.dataSdk) {
        if (allData.length >= 999) {
          showInlineMessage('clinicSuccessMessage', 
            currentLang === 'ms' ? 
            'Had maksimum 999 tempahan telah dicapai. Sila padam beberapa tempahan dahulu.' :
            'Maximum limit of 999 bookings reached. Please delete some bookings first.', 
            'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          return;
        }

        let result;
        try {
          result = await window.dataSdk.create(bookingData);
        } catch (err) {
          console.error('Clinic booking create failed', err);
          result = { isOk: false, error: err };
        }
        
        if (result.isOk) {
          await eprLogAudit('clinic_booking_created', bookingData, { student_email: bookingData.student_email || '' });
          eprUpdateClinicCapacityHint();
          e.target.reset();
          showInlineMessage('clinicSuccessMessage', 
            currentLang === 'ms' ? 
            'âœ… Tempahan berjaya dihantar! Nombor rujukan: ' + bookingData.reference_number :
            'âœ… Booking submitted successfully! Reference number: ' + bookingData.reference_number);
        } else {
          showInlineMessage('clinicSuccessMessage', 
            currentLang === 'ms' ? 
            'âŒ Ralat: Gagal menghantar tempahan. Sila cuba lagi.' :
            'âŒ Error: Failed to submit booking. Please try again.', 
            'error');
        }
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }

    // Handle room booking
    async function handleRoomBooking(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('roomSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menghantar...' : 'Submitting...');

      // ===== Tempahan katil: elak duplicate + auto reset 00:00 =====
      const __roomDate = document.getElementById('roomDate').value;
      const __roomStudentName = document.getElementById('studentName2').value;
      const __roomStudentIc = (currentStudent && currentStudent.ic) ? currentStudent.ic : '';

      const __dupRoom = allData.some(b =>
        (b.booking_type === 'room' || b.type === 'room') &&
        (b.date || '').slice(0, 10) === __roomDate &&
        ((b.status || '').toLowerCase() === 'confirmed' || (b.status || '').toLowerCase() === 'pending') &&
        (
          (__roomStudentIc && (b.student_ic || '').trim() === __roomStudentIc) ||
          (!__roomStudentIc && (b.student_name || '').trim().toLowerCase() === (__roomStudentName || '').trim().toLowerCase()) ||
          (__roomStudentIc && (b.student_name || '').trim().toLowerCase() === (__roomStudentName || '').trim().toLowerCase())
        )
      );

      if (__dupRoom) {
        showInlineMessage('roomSuccessMessage',
          currentLang === 'ms'
            ? 'âŒ Anda sudah ada tempahan katil aktif untuk tarikh ini.'
            : 'âŒ You already have an active bed booking for this date.',
          'error'
        );
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      const __expiresAt = eprNextMidnightISO(__roomDate);

      const bookingData = {
        id: 'room_' + Date.now(),
        type: 'room',
        booking_type: 'room',
        room_type: document.getElementById('roomType').value,
        student_name: document.getElementById('studentName2').value,
        student_email: (document.getElementById('studentEmail2') ? document.getElementById('studentEmail2').value.trim() : ''),
        student_ic: (currentStudent && currentStudent.ic) ? currentStudent.ic : '',
		student_category: document.getElementById('roomStudentCategory').value,
        class_name: document.getElementById('className2').value,
        date: document.getElementById('roomDate').value,
        start_time: document.getElementById('roomStartTime').value,
        estimated_days: document.getElementById('estimatedDays').value,
        guardian_phone: document.getElementById('guardianPhone2').value,
        purpose: document.getElementById('roomPurpose').value,
        document_url: (document.getElementById('roomDocumentUrl') ? (document.getElementById('roomDocumentUrl').value || '') : ''),
        document_file: (document.getElementById('roomDocumentFileData') ? (document.getElementById('roomDocumentFileData').value || '') : ''),
        status: 'pending',
        reference_number: 'BED' + Date.now().toString().slice(-8),
        created_at: new Date().toISOString(),
        admin_notes: ''
      };

      if (window.dataSdk) {
        if (allData.length >= 999) {
          showInlineMessage('roomSuccessMessage', 
            currentLang === 'ms' ? 
            'Had maksimum 999 tempahan telah dicapai. Sila padam beberapa tempahan dahulu.' :
            'Maximum limit of 999 bookings reached. Please delete some bookings first.', 
            'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          return;
        }

        const result = await window.dataSdk.create(bookingData);
        
        if (result.isOk) {
          await eprLogAudit('room_booking_created', bookingData, { student_email: bookingData.student_email || '' });
          e.target.reset();
          showInlineMessage('roomSuccessMessage', 
            currentLang === 'ms' ? 
            'âœ… Tempahan berjaya dihantar! Nombor rujukan: ' + bookingData.reference_number :
            'âœ… Booking submitted successfully! Reference number: ' + bookingData.reference_number);
        } else {
          showInlineMessage('roomSuccessMessage', 
            currentLang === 'ms' ? 
            'âŒ Ralat: Gagal menghantar tempahan. Sila cuba lagi.' :
            'âŒ Error: Failed to submit booking. Please try again.', 
            'error');
        }
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }

    // Show inline message
    function showInlineMessage(elementId, message, type = 'success') {
      const messageEl = document.getElementById(elementId);
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.className = 'success-message show';
        if (type === 'error') {
          messageEl.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
          messageEl.style.color = '#721c24';
        } else {
          messageEl.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
          messageEl.style.color = '#155724';
        }
        
        setTimeout(() => {
          messageEl.classList.remove('show');
        }, 5000);
      }
    }

    // Update bookings display
    function updateBookingsDisplay() {
      updateClinicBookings();
      updateRoomBookings();
      updateDashboard();
      updateAnnouncements();
      updatePrograms();
      updateAchievements();
      updateSchedules();
      updateSharing();
      updateGuestbook();
    }

    // Update clinic bookings
    

    function renderSupportingDocBlock(booking, currentLang) {
      if (!booking) return '';
      const docUrl = booking.document_url || '';
      const docFile = booking.document_file || '';
      if (!docUrl && !docFile) return '';

      const label = (currentLang === 'ms') ? 'Dokumen Sokongan' : 'Supporting Document';
      const viewDoc = (currentLang === 'ms') ? 'Lihat Dokumen' : 'View Document';
      const viewPdf = (currentLang === 'ms') ? 'Lihat PDF' : 'View PDF';

      let inner = '';
      if (docUrl) {
        inner += `
          <div style="margin-top: 0.5rem;">
            <a href="${docUrl}" target="_blank" style="color: #ff6fa3; text-decoration: underline;">
              ðŸ“Ž ${viewDoc}
            </a>
          </div>
        `;
      }

      if (docFile) {
        const isPdf = docFile.startsWith('data:application/pdf');
        if (isPdf) {
          inner += `
            <div style="margin-top: 0.5rem;">
              <a href="${docFile}" target="_blank" style="color: #ff6fa3; text-decoration: underline;">
                ðŸ“„ ${viewPdf}
              </a>
            </div>
          `;
        } else {
          inner += `
            <div style="margin-top: 0.75rem;">
              <img src="${docFile}" alt="${label}" style="max-width: 100%; max-height: 240px; border-radius: 14px; border: 1px solid rgba(255,111,163,0.35);" />
            </div>
          `;
        }
      }

      return `
        <div class="pdf-info-item" style="grid-column: 1 / -1; margin-top: 1rem;">
          <div class="pdf-info-label">${label}</div>
          <div class="pdf-info-value" style="margin-top: 0.5rem;">
            ${inner}
          </div>
        </div>
      `;
    }
function updateClinicBookings() {
      const clinicBookingsList = document.getElementById('clinicBookingsList');
      if (!clinicBookingsList) return;

      const clinicBookings = allData.filter(b => b.booking_type === 'clinic' || b.type === 'clinic');
      
      if (clinicBookings.length === 0) {
        clinicBookingsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ©º</div>
            <p>${currentLang === 'ms' ? 'Tiada tempahan klinik lagi.' : 'No clinic bookings yet.'}</p>
          </div>
        `;
        return;
      }

      clinicBookingsList.innerHTML = clinicBookings.map(booking => {
        const uniqueId = booking.__backendId || booking.id;
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${booking.reference_number || booking.id}</span>
              <span class="booking-status status-${booking.status}">
                ${booking.status === 'pending' ? (currentLang === 'ms' ? 'Menunggu' : 'Pending') : booking.status === 'confirmed' ? (currentLang === 'ms' ? 'Disahkan' : 'Confirmed') : booking.status === 'completed' ? (currentLang === 'ms' ? 'Selesai' : 'Completed') : booking.status === 'expired' ? (currentLang === 'ms' ? 'Tamat' : 'Expired') : (currentLang === 'ms' ? 'Ditolak' : 'Rejected')}
              </span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Jenis:' : 'Type:'}</span>
                <span class="detail-value">${booking.appointment_type || '-'}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Nama:' : 'Name:'}</span>
                <span class="detail-value">${booking.student_name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Kelas:' : 'Class:'}</span>
                <span class="detail-value">${booking.class_name}</span>
              </div>
			  <div class="detail-row">
  <span class="detail-label">${currentLang === 'ms' ? 'Kategori:' : 'Category:'}</span>
  <span class="detail-value">${
    booking.student_category === 'asrama'
      ? (currentLang === 'ms' ? 'Asrama' : 'Boarder')
      : booking.student_category === 'luar'
        ? (currentLang === 'ms' ? 'Pelajar Luar' : 'Day Student')
        : '-'
  }</span>
</div>

              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Tarikh:' : 'Date:'}</span>
                <span class="detail-value">${booking.date} ${booking.time || ''}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Simptom:' : 'Symptoms:'}</span>
                <span class="detail-value">${booking.symptoms}</span>
              </div>
              ${booking.is_urgent ? `
                <div class="detail-row">
                  <span class="detail-label">${currentLang === 'ms' ? 'Status:' : 'Status:'}</span>
                  <span class="detail-value" style="color: #dc3545; font-weight: 600;">âš ï¸ ${currentLang === 'ms' ? 'KEUTAMAAN' : 'URGENT'}</span>
                </div>
              ` : ''}
              ${booking.admin_notes ? `
                <div class="detail-row">
                  <span class="detail-label">${currentLang === 'ms' ? 'Nota Admin:' : 'Admin Notes:'}</span>
                  <span class="detail-value">${booking.admin_notes}</span>
                </div>
              ` : ''}
            </div>
            ${isLoggedIn && booking.status === 'pending' ? `
              <div class="admin-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="admin-btn" onclick="approveBooking('${uniqueId}')" style="background: #28a745; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  âœ… ${currentLang === 'ms' ? 'Terima' : 'Approve'}
                </button>
                <button class="admin-btn" onclick="rejectBooking('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  âŒ ${currentLang === 'ms' ? 'Tolak' : 'Reject'}
                </button>
                <button class="admin-btn" onclick="deleteBooking('${uniqueId}')" style="background: #6c757d; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
                <button class="admin-btn" onclick="downloadBookingPDF('${uniqueId}')" style="background: #17a2b8; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ“¥ PDF
                </button>
              </div>
            ` : isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="admin-btn" onclick="deleteBooking('${uniqueId}')" style="background: #6c757d; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
                <button class="admin-btn" onclick="downloadBookingPDF('${uniqueId}')" style="background: #17a2b8; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ“¥ PDF
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Update room bookings
    function updateRoomBookings() {
      const roomBookingsList = document.getElementById('roomBookingsList');
      if (!roomBookingsList) return;

      const roomBookings = allData.filter(b => b.booking_type === 'room' || b.type === 'room');
      
      if (roomBookings.length === 0) {
        roomBookingsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ›ï¸</div>
            <p>${currentLang === 'ms' ? 'Tiada tempahan katil sakit lagi.' : 'No bed bookings yet.'}</p>
          </div>
        `;
        return;
      }

      roomBookingsList.innerHTML = roomBookings.map(booking => {
        const uniqueId = booking.__backendId || booking.id;
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${booking.reference_number || booking.id}</span>
              <span class="booking-status status-${booking.status}">
                ${booking.status === 'pending' ? (currentLang === 'ms' ? 'Menunggu' : 'Pending') : booking.status === 'confirmed' ? (currentLang === 'ms' ? 'Disahkan' : 'Confirmed') : booking.status === 'completed' ? (currentLang === 'ms' ? 'Selesai' : 'Completed') : booking.status === 'expired' ? (currentLang === 'ms' ? 'Tamat' : 'Expired') : (currentLang === 'ms' ? 'Ditolak' : 'Rejected')}
              </span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Lokasi:' : 'Location:'}</span>
                <span class="detail-value">${booking.room_type || '-'}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Nama:' : 'Name:'}</span>
                <span class="detail-value">${booking.student_name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Kelas:' : 'Class:'}</span>
                <span class="detail-value">${booking.class_name}</span>
              </div>
<div class="detail-row">
  <span class="detail-label">${currentLang === 'ms' ? 'Kategori:' : 'Category:'}</span>
  <span class="detail-value">${
    booking.student_category === 'asrama'
      ? (currentLang === 'ms' ? 'Asrama' : 'Boarder')
      : booking.student_category === 'luar'
        ? (currentLang === 'ms' ? 'Pelajar Luar' : 'Day Student')
        : '-'
  }</span>
</div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Tarikh Mula:' : 'Start Date:'}</span>
                <span class="detail-value">${booking.date} ${booking.start_time || ''}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Anggaran:' : 'Duration:'}</span>
                <span class="detail-value">${booking.estimated_days} ${currentLang === 'ms' ? 'hari' : 'days'}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'No. HP Penjaga:' : 'Guardian Phone:'}</span>
                <span class="detail-value">${booking.guardian_phone}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Sebab:' : 'Reason:'}</span>
                <span class="detail-value">${booking.purpose}</span>
              </div>
              ${booking.admin_notes ? `
                <div class="detail-row">
                  <span class="detail-label">${currentLang === 'ms' ? 'Nota Admin:' : 'Admin Notes:'}</span>
                  <span class="detail-value">${booking.admin_notes}</span>
                </div>
              ` : ''}
              ${renderSupportingDocBlock(booking, currentLang)}
            </div>
            ${isLoggedIn && booking.status === 'pending' ? `
              <div class="admin-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="admin-btn" onclick="approveBooking('${uniqueId}')" style="background: #28a745; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  âœ… ${currentLang === 'ms' ? 'Terima' : 'Approve'}
                </button>
                <button class="admin-btn" onclick="rejectBooking('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  âŒ ${currentLang === 'ms' ? 'Tolak' : 'Reject'}
                </button>
                <button class="admin-btn" onclick="deleteBooking('${uniqueId}')" style="background: #6c757d; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
                <button class="admin-btn" onclick="downloadBookingPDF('${uniqueId}')" style="background: #17a2b8; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ“¥ PDF
                </button>
              </div>
            ` : isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="admin-btn" onclick="deleteBooking('${uniqueId}')" style="background: #6c757d; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
                <button class="admin-btn" onclick="downloadBookingPDF('${uniqueId}')" style="background: #17a2b8; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ“¥ PDF
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Approve booking
    async function approveBooking(bookingId) {
      const booking = allData.find(b => (b.__backendId || b.id) === bookingId);
      if (!booking || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 
        'Terima tempahan ini?' : 
        'Approve this booking?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #28a745; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        booking.status = 'confirmed';
        const result = await window.dataSdk.update(booking);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
        
        if (!result.isOk) {
          showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
            currentLang === 'ms' ? 'âŒ Gagal mengemaskini status.' : 'âŒ Failed to update status.',
            'error');
        } else {
          await eprLogAudit('booking_approved', booking, {});
          const emailRes = await eprSendEmailStatus(booking, 'confirmed', booking.admin_notes || '');
          if (emailRes && emailRes.ok) {
            showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
              currentLang === 'ms'
                ? 'âœ… Tempahan disahkan. Notifikasi emel telah dihantar.'
                : 'âœ… Booking approved. Email notification has been sent.',
              'success');
          } else {
            showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
              currentLang === 'ms'
                ? 'âœ… Tempahan disahkan. (Emel tidak dihantar â€” tiada emel / belum set EmailJS)'
                : 'âœ… Booking approved. (Email not sent â€” missing email / EmailJS not configured)',
              'success');
          }
        }
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Reject booking
    async function rejectBooking(bookingId) {
      const booking = allData.find(b => (b.__backendId || b.id) === bookingId);
      if (!booking || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 
        'Tolak tempahan ini?' : 
        'Reject this booking?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        const reason = prompt(
          currentLang === 'ms'
            ? 'Masukkan sebab/nota penolakan (akan dihantar ke emel jika diisi):'
            : 'Enter a rejection reason/note (will be emailed if provided):'
        ) || '';
        booking.admin_notes = reason;
        booking.status = 'rejected';
        const result = await window.dataSdk.update(booking);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
        
        if (!result.isOk) {
          showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
            currentLang === 'ms' ? 'âŒ Gagal mengemaskini status.' : 'âŒ Failed to update status.',
            'error');
        } else {
          await eprLogAudit('booking_rejected', booking, { reason: booking.admin_notes || '' });
          const emailRes = await eprSendEmailStatus(booking, 'rejected', booking.admin_notes || '');
          if (emailRes && emailRes.ok) {
            showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
              currentLang === 'ms'
                ? 'âœ… Tempahan ditolak. Notifikasi emel telah dihantar.'
                : 'âœ… Booking rejected. Email notification has been sent.',
              'success');
          } else {
            showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
              currentLang === 'ms'
                ? 'âœ… Tempahan ditolak. (Emel tidak dihantar â€” tiada emel / belum set EmailJS)'
                : 'âœ… Booking rejected. (Email not sent â€” missing email / EmailJS not configured)',
              'success');
          }
        }
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Delete booking
    async function deleteBooking(bookingId) {
      const booking = allData.find(b => (b.__backendId || b.id) === bookingId);
      if (!booking || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 
        'Padam tempahan ini?' : 
        'Delete this booking?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        const result = await window.dataSdk.delete(booking);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
        
        if (!result.isOk) {
          showInlineMessage(booking.booking_type === 'clinic' ? 'clinicSuccessMessage' : 'roomSuccessMessage',
            currentLang === 'ms' ? 'âŒ Gagal memadam tempahan.' : 'âŒ Failed to delete booking.',
            'error');
        }
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Download booking PDF
    function downloadBookingPDF(bookingId) {
      const booking = allData.find(b => (b.__backendId || b.id) === bookingId);
      if (!booking) return;

      // Get profile data for header
      const profileData = allData.find(d => d.type === 'profile') || {};
      const schoolName = currentLang === 'ms' ? 
        (profileData.school_name_ms || 'e-PRIhatin PELAJAR') : 
        (profileData.school_name_en || 'e-PRIhatin STUDENT');

      // Create modal for PDF preview
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.style.overflowY = 'auto';
      modal.style.padding = '2rem';
      
      const isClinic = booking.booking_type === 'clinic' || booking.type === 'clinic';
      const reportTitle = currentLang === 'ms' ? 
        (isClinic ? 'Laporan Tempahan Klinik' : 'Laporan Tempahan Katil Sakit') :
        (isClinic ? 'Clinic Booking Report' : 'Sick Bed Booking Report');

  const rangeHtml = (startDate || endDate)
    ? `<p class="pdf-report-date" style="font-weight: 600;">
         ${(currentLang === 'ms' ? 'Julat Tarikh:' : 'Date Range:')}
         ${startDate || '-'} ${endDate ? ('â†’ ' + endDate) : ''}
       </p>`
    : '';

      modal.innerHTML = `
        <div class="pdf-report-container" id="pdfReportContainer">
          <div style="text-align: right; margin-bottom: 1rem;">
            <button onclick="this.closest('.modal-overlay').remove()" style="background: #6c757d; color: white; padding: 0.5rem 1rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; margin-right: 0.5rem;">
              âœ• ${currentLang === 'ms' ? 'Tutup' : 'Close'}
            </button>
            <button onclick="window.print()" class="download-pdf-btn">
              ðŸ–¨ï¸ ${currentLang === 'ms' ? 'Cetak / Simpan PDF' : 'Print / Save PDF'}
            </button>
          </div>

          <div class="pdf-header">
            ${profileData.logo_url ? `<img src="${profileData.logo_url}" alt="Logo" class="pdf-school-logo" onerror="this.style.display='none';">` : ''}
            <h1 class="pdf-school-name">${schoolName}</h1>
            <h2 class="pdf-report-title">${reportTitle}</h2>
            <p class="pdf-report-date">${currentLang === 'ms' ? 'Tarikh Laporan:' : 'Report Date:'} ${new Date().toLocaleDateString(currentLang === 'ms' ? 'ms-MY' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            ${rangeHtml}
            <p class="pdf-report-date" style="font-weight: 600; color: #ff6fa3;">
              ${currentLang === 'ms' ? 'No. Rujukan:' : 'Reference No:'} ${booking.reference_number || booking.id}
            </p>
          </div>

          <div class="pdf-content">
            <div class="pdf-section">
              <h3 class="pdf-section-title">${currentLang === 'ms' ? 'ðŸ“‹ Maklumat Tempahan' : 'ðŸ“‹ Booking Information'}</h3>
              <div class="pdf-info-grid">
                <div class="pdf-info-item">
                  <div class="pdf-info-label">${currentLang === 'ms' ? 'Status' : 'Status'}</div>
                  <div class="pdf-info-value" style="color: ${booking.status === 'confirmed' ? '#28a745' : booking.status === 'rejected' ? '#dc3545' : '#ffc107'}; font-weight: 700; text-transform: uppercase;">
                    ${booking.status === 'pending' ? (currentLang === 'ms' ? 'MENUNGGU' : 'PENDING') : 
                      booking.status === 'confirmed' ? (currentLang === 'ms' ? 'DISAHKAN' : 'CONFIRMED') : 
                      (currentLang === 'ms' ? 'DITOLAK' : 'REJECTED')}
                  </div>
                </div>
                ${isClinic ? `
                  <div class="pdf-info-item">
                    <div class="pdf-info-label">${currentLang === 'ms' ? 'Jenis Temu Janji' : 'Appointment Type'}</div>
                    <div class="pdf-info-value">${booking.appointment_type || '-'}</div>
                  </div>
                ` : `
                  <div class="pdf-info-item">
                    <div class="pdf-info-label">${currentLang === 'ms' ? 'Lokasi Katil' : 'Bed Location'}</div>
                    <div class="pdf-info-value">${booking.room_type || '-'}</div>
                  </div>
                `}
                <div class="pdf-info-item">
                  <div class="pdf-info-label">${currentLang === 'ms' ? 'Tarikh' : 'Date'}</div>
                  <div class="pdf-info-value">${booking.date}</div>
                </div>
                <div class="pdf-info-item">
                  <div class="pdf-info-label">${currentLang === 'ms' ? 'Masa' : 'Time'}</div>
                  <div class="pdf-info-value">${booking.time || booking.start_time || '-'}</div>
                </div>
                ${!isClinic ? `
                  <div class="pdf-info-item">
                    <div class="pdf-info-label">${currentLang === 'ms' ? 'Anggaran Hari' : 'Estimated Days'}</div>
                    <div class="pdf-info-value">${booking.estimated_days || '-'} ${currentLang === 'ms' ? 'hari' : 'days'}</div>
                  </div>
                ` : ''}
                <div class="pdf-info-item">
                  <div class="pdf-info-label">${currentLang === 'ms' ? 'Tarikh Dibuat' : 'Created Date'}</div>
                  <div class="pdf-info-value">${new Date(booking.created_at).toLocaleString(currentLang === 'ms' ? 'ms-MY' : 'en-US')}</div>
                </div>
              </div>
            </div>

            <div class="pdf-section">
  <h3 class="pdf-section-title">${currentLang === 'ms' ? 'ðŸ‘¤ Maklumat Pelajar' : 'ðŸ‘¤ Student Information'}</h3>
  <div class="pdf-info-grid">
    <div class="pdf-info-item">
      <div class="pdf-info-label">${currentLang === 'ms' ? 'Nama Pelajar' : 'Student Name'}</div>
      <div class="pdf-info-value" style="font-weight: 700; font-size: 1.1rem; color: #ff6fa3;">
        ${booking.student_name}
      </div>
    </div>
    <div class="pdf-info-item">
      <div class="pdf-info-label">${currentLang === 'ms' ? 'Kelas' : 'Class'}</div>
      <div class="pdf-info-value">${booking.class_name}</div>
    </div>
    <div class="pdf-info-item">
      <div class="pdf-info-label">${currentLang === 'ms' ? 'Kategori Pelajar' : 'Student Category'}</div>
      <div class="pdf-info-value">${
        (booking.student_category || '').toLowerCase() === 'asrama'
          ? (currentLang === 'ms' ? 'Asrama' : 'Boarder')
          : (booking.student_category || '').toLowerCase() === 'luar'
            ? (currentLang === 'ms' ? 'Pelajar Luar' : 'Day Student')
            : '-'
      }</div>
    </div>
    <div class="pdf-info-item">
      <div class="pdf-info-label">${currentLang === 'ms' ? 'No. HP Penjaga' : 'Guardian Phone'}</div>
      <div class="pdf-info-value">${booking.guardian_phone || '-'}</div>
    </div>

            <div class="pdf-section">
              <h3 class="pdf-section-title">${currentLang === 'ms' ? 'ðŸ“ Keterangan' : 'ðŸ“ Details'}</h3>
              <div class="pdf-info-item" style="grid-column: 1 / -1;">
                <div class="pdf-info-label">${isClinic ? (currentLang === 'ms' ? 'Simptom / Aduan' : 'Symptoms / Complaint') : (currentLang === 'ms' ? 'Sebab / Tujuan' : 'Reason / Purpose')}</div>
                <div class="pdf-info-value" style="white-space: pre-wrap; line-height: 1.6; margin-top: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                  ${booking.symptoms || booking.purpose || '-'}
                </div>
              </div>
              ${booking.admin_notes ? `
                <div class="pdf-info-item" style="grid-column: 1 / -1; margin-top: 1rem;">
                  <div class="pdf-info-label">${currentLang === 'ms' ? 'Nota Pentadbir' : 'Admin Notes'}</div>
                  <div class="pdf-info-value" style="white-space: pre-wrap; line-height: 1.6; margin-top: 0.5rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    ${booking.admin_notes}
                  </div>
                </div>
              ` : ''}
              ${renderSupportingDocBlock(booking, currentLang)}
            </div>

            ${booking.status === 'confirmed' ? `
              <div class="pdf-section" style="background: #d4edda; padding: 1.5rem; border-radius: 15px; border: 2px solid #28a745;">
                <h3 class="pdf-section-title" style="color: #155724; border-bottom-color: #28a745;">
                  âœ… ${currentLang === 'ms' ? 'Tempahan Disahkan' : 'Booking Confirmed'}
                </h3>
                <p style="color: #155724; line-height: 1.6; margin: 0;">
                  ${currentLang === 'ms' ? 
                    'Tempahan ini telah disahkan oleh pihak pentadbir. Sila hadir pada tarikh dan masa yang ditetapkan.' : 
                    'This booking has been confirmed by the administrator. Please attend at the scheduled date and time.'}
                </p>
              </div>
            ` : booking.status === 'rejected' ? `
              <div class="pdf-section" style="background: #f8d7da; padding: 1.5rem; border-radius: 15px; border: 2px solid #dc3545;">
                <h3 class="pdf-section-title" style="color: #721c24; border-bottom-color: #dc3545;">
                  âŒ ${currentLang === 'ms' ? 'Tempahan Ditolak' : 'Booking Rejected'}
                </h3>
                <p style="color: #721c24; line-height: 1.6; margin: 0;">
                  ${currentLang === 'ms' ? 
                    'Tempahan ini telah ditolak. Sila hubungi pihak pentadbir untuk maklumat lanjut.' : 
                    'This booking has been rejected. Please contact the administrator for more information.'}
                </p>
              </div>
            ` : `
              <div class="pdf-section" style="background: #fff3cd; padding: 1.5rem; border-radius: 15px; border: 2px solid #ffc107;">
                <h3 class="pdf-section-title" style="color: #856404; border-bottom-color: #ffc107;">
                  â³ ${currentLang === 'ms' ? 'Menunggu Pengesahan' : 'Pending Confirmation'}
                </h3>
                <p style="color: #856404; line-height: 1.6; margin: 0;">
                  ${currentLang === 'ms' ? 
                    'Tempahan ini sedang menunggu pengesahan daripada pihak pentadbir.' : 
                    'This booking is pending confirmation from the administrator.'}
                </p>
              </div>
            `}
          </div>

          <div class="pdf-signatures">
            <div class="pdf-signature-box">
              <div class="pdf-signature-line">
                <div class="pdf-signature-label">${currentLang === 'ms' ? 'Tandatangan Pemohon' : 'Applicant Signature'}</div>
                <div style="margin-top: 1rem; color: #999; font-style: italic;">${booking.student_name}</div>
              </div>
            </div>
            <div class="pdf-signature-box">
              <div class="pdf-signature-line">
                <div class="pdf-signature-label">${currentLang === 'ms' ? 'Tandatangan Pentadbir' : 'Administrator Signature'}</div>
                <div style="margin-top: 1rem; color: #999; font-style: italic;">${profileData.principal_name || 'Pengetua'}</div>
              </div>
            </div>
          </div>

          <div class="pdf-footer">
            <p>${currentLang === 'ms' ? 'Dokumen ini dijana secara automatik oleh sistem e-PRIhatin PELAJAR' : 'This document is automatically generated by the e-PRIhatin STUDENT system'}</p>
            <p>${profileData.footer_text || 'Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.'}</p>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add print styles dynamically
      const printStyle = document.createElement('style');
      printStyle.id = 'printStyles';
      printStyle.textContent = `
        @media print {
          body * {
            visibility: hidden;
          }
          #pdfReportContainer, #pdfReportContainer * {
            visibility: visible;
          }
          #pdfReportContainer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
          }
          .download-pdf-btn {
            display: none !important;
          }
          button {
            display: none !important;
          }
        }
      `;
      document.head.appendChild(printStyle);
    }

   // Helper: cipta style untuk print jika belum ada
function ensurePrintStyles() {
  if (!document.getElementById('printStyles')) {
    const printStyle = document.createElement('style');
    printStyle.id = 'printStyles';
    printStyle.textContent = `
      @media print {
        body * {
          visibility: hidden;
        }
        #pdfReportContainer, #pdfReportContainer * {
          visibility: visible;
        }
        #pdfReportContainer {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .download-pdf-btn {
          display: none !important;
        }
        button {
          display: none !important;
        }
      }
    `;
    document.head.appendChild(printStyle);
  }
}

// Helper: buka modal laporan semua tempahan
function openAllBookingsReport(bookings, isClinic, startDate = '', endDate = '') {
  if (!bookings || bookings.length === 0) {
    const msg = currentLang === 'ms'
      ? 'Tiada rekod untuk dimuat turun.'
      : 'No records to download.';
    showInlineMessage(isClinic ? 'clinicSuccessMessage' : 'roomSuccessMessage', 'â„¹ï¸ ' + msg, 'error');
    return;
  }

  ensurePrintStyles();

  const profileData = allData.find(d => d.type === 'profile') || {};
  const schoolName = currentLang === 'ms'
    ? (profileData.school_name_ms || 'e-PRIhatin PELAJAR')
    : (profileData.school_name_en || 'e-PRIhatin STUDENT');

  const reportTitle = currentLang === 'ms'
    ? (isClinic ? 'Laporan Semua Tempahan Klinik' : 'Laporan Semua Tempahan Katil Sakit')
    : (isClinic ? 'All Clinic Bookings Report' : 'All Sick Bed Bookings Report');

  // Bina header jadual
  const tableHeader = isClinic
  ? (currentLang === 'ms'
      ? `<tr>
           <th>Bil</th>
           <th>Tarikh</th>
           <th>Masa</th>
           <th>Nama Pelajar</th>
           <th>Kategori</th>
           <th>Kelas</th>
           <th>Jenis Temu Janji</th>
           <th>Status</th>
           <th>Urgent</th>
           <th>No. Rujukan</th>
         </tr>`
      : `<tr>
           <th>No.</th>
           <th>Date</th>
           <th>Time</th>
           <th>Student Name</th>
           <th>Category</th>
           <th>Class</th>
           <th>Appointment Type</th>
           <th>Status</th>
           <th>Urgent</th>
           <th>Reference No.</th>
         </tr>`)
  : (currentLang === 'ms'
      ? `<tr>
           <th>Bil</th>
           <th>Tarikh</th>
           <th>Masa Mula</th>
           <th>Nama Pelajar</th>
           <th>Kategori</th>
           <th>Kelas</th>
           <th>Lokasi Katil</th>
           <th>Tujuan</th>
           <th>Status</th>
           <th>No. Rujukan</th>
         </tr>`
      : `<tr>
           <th>No.</th>
           <th>Date</th>
           <th>Start Time</th>
           <th>Student Name</th>
           <th>Category</th>
           <th>Class</th>
           <th>Bed Location</th>
           <th>Purpose</th>
           <th>Status</th>
           <th>Reference No.</th>
         </tr>`);


  // Bina baris jadual
  const rowsHtml = bookings
  .sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''))
  .map((b, index) => {
    const statusLabel = (() => {
      const s = (b.status || '').toLowerCase();
      if (s === 'confirmed') {
        return currentLang === 'ms' ? 'Disahkan' : 'Confirmed';
      } else if (s === 'pending') {
        return currentLang === 'ms' ? 'Menunggu' : 'Pending';
      } else if (s === 'rejected') {
        return currentLang === 'ms' ? 'Ditolak' : 'Rejected';
      }
      return b.status || '-';
    })();

    const categoryLabel = (() => {
      const c = (b.student_category || '').toLowerCase();
      if (c === 'asrama') {
        return currentLang === 'ms' ? 'Asrama' : 'Boarder';
      } else if (c === 'luar') {
        return currentLang === 'ms' ? 'Pelajar Luar' : 'Day Student';
      }
      return '-';
    })();

    if (isClinic) {
      return `
        <tr>
          <td>${index + 1}</td>
          <td>${b.date || '-'}</td>
          <td>${b.time || '-'}</td>
          <td>${b.student_name || '-'}</td>
          <td>${categoryLabel}</td>
          <td>${b.class_name || '-'}</td>
          <td>${b.appointment_type || '-'}</td>
          <td>${statusLabel}</td>
          <td>${b.is_urgent ? (currentLang === 'ms' ? 'Ya' : 'Yes') : (currentLang === 'ms' ? 'Tidak' : 'No')}</td>
          <td>${b.reference_number || b.id}</td>
        </tr>
      `;
    } else {
      return `
        <tr>
          <td>${index + 1}</td>
          <td>${b.date || '-'}</td>
          <td>${b.start_time || '-'}</td>
          <td>${b.student_name || '-'}</td>
          <td>${categoryLabel}</td>
          <td>${b.class_name || '-'}</td>
          <td>${b.room_type || '-'}</td>
          <td>${b.purpose || '-'}</td>
          <td>${statusLabel}</td>
          <td>${b.reference_number || b.id}</td>
        </tr>
      `;
    }
  }).join('');


  // Cipta modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.style.overflowY = 'auto';
  modal.style.padding = '2rem';

  modal.innerHTML = `
    <div class="pdf-report-container" id="pdfReportContainer">
      <div style="text-align: right; margin-bottom: 1rem;">
        <button onclick="this.closest('.modal-overlay').remove()" style="background: #6c757d; color: white; padding: 0.5rem 1rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; margin-right: 0.5rem;">
          âœ• ${currentLang === 'ms' ? 'Tutup' : 'Close'}
        </button>
        <button onclick="window.print()" class="download-pdf-btn">
          ðŸ–¨ï¸ ${currentLang === 'ms' ? 'Cetak / Simpan PDF' : 'Print / Save PDF'}
        </button>
      </div>

      <div class="pdf-header">
        ${profileData.logo_url ? `<img src="${profileData.logo_url}" alt="Logo" class="pdf-school-logo" onerror="this.style.display='none';">` : ''}
        <h1 class="pdf-school-name">${schoolName}</h1>
        <h2 class="pdf-report-title">${reportTitle}</h2>
        <p class="pdf-report-date">
          ${(currentLang === 'ms' ? 'Tarikh Laporan:' : 'Report Date:')}
          ${new Date().toLocaleDateString(currentLang === 'ms' ? 'ms-MY' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>
        <p class="pdf-report-date" style="font-weight: 600;">
          ${currentLang === 'ms' ? 'Jumlah Rekod:' : 'Total Records:'} ${bookings.length}
        </p>
      </div>

      <div class="pdf-content">
        <table class="pdf-table">
          <thead>${tableHeader}</thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </div>

      <div class="pdf-footer">
        <p>${currentLang === 'ms'
          ? 'Dokumen ini dijana secara automatik oleh sistem e-PRIhatin PELAJAR.'
          : 'This document is automatically generated by the e-PRIhatin STUDENT system.'}</p>
        <p>${profileData.footer_text || 'Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.'}</p>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// âœ… Download semua tempahan klinik
function downloadAllClinicBookings() {
  const clinicBookings = allData.filter(b => b.booking_type === 'clinic' || b.type === 'clinic');
  const start = (document.getElementById('clinicExportStart') && document.getElementById('clinicExportStart').value) ? document.getElementById('clinicExportStart').value : '';
  const end = (document.getElementById('clinicExportEnd') && document.getElementById('clinicExportEnd').value) ? document.getElementById('clinicExportEnd').value : '';
  const filtered = eprFilterByDateRange(clinicBookings, start, end);
  openAllBookingsReport(filtered, true, start, end);
}

// âœ… Download semua tempahan katil
function downloadAllRoomBookings() {
  const roomBookings = allData.filter(b => b.booking_type === 'room' || b.type === 'room');
  const start = (document.getElementById('roomExportStart') && document.getElementById('roomExportStart').value) ? document.getElementById('roomExportStart').value : '';
  const end = (document.getElementById('roomExportEnd') && document.getElementById('roomExportEnd').value) ? document.getElementById('roomExportEnd').value : '';
  const filtered = eprFilterByDateRange(roomBookings, start, end);
  openAllBookingsReport(filtered, false, start, end);
}

function eprDownloadCSV(filename, headers, rows) {
  const escapeCSV = (v) => {
    const s = (v === null || v === undefined) ? '' : String(v);
    const needs = /[",\n]/.test(s);
    const esc = s.replace(/"/g, '""');
    return needs ? `"${esc}"` : esc;
  };

  const lines = [];
  lines.push(headers.map(escapeCSV).join(','));
  rows.forEach(r => lines.push(r.map(escapeCSV).join(',')));

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}

function downloadClinicBookingsCSV() {
  const clinicBookings = allData.filter(b => b.booking_type === 'clinic' || b.type === 'clinic');
  const start = (document.getElementById('clinicExportStart') && document.getElementById('clinicExportStart').value) ? document.getElementById('clinicExportStart').value : '';
  const end = (document.getElementById('clinicExportEnd') && document.getElementById('clinicExportEnd').value) ? document.getElementById('clinicExportEnd').value : '';
  const filtered = eprFilterByDateRange(clinicBookings, start, end);

  if (!filtered.length) {
    showInlineMessage('clinicSuccessMessage',
      currentLang === 'ms' ? 'â„¹ï¸ Tiada rekod untuk dimuat turun (CSV).' : 'â„¹ï¸ No records to download (CSV).',
      'error'
    );
    return;
  }

  const headers = [
    'Reference No', 'Status', 'Date', 'Time', 'Student Name', 'Student Category', 'Class',
    'Appointment Type', 'Guardian Phone', 'Symptoms', 'Urgent', 'Student Email', 'Created At', 'Admin Notes'
  ];

  const rows = filtered
    .sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''))
    .map(b => ([
      b.reference_number || b.id,
      b.status || '',
      b.date || '',
      b.time || '',
      b.student_name || '',
      b.student_category || '',
      b.class_name || '',
      b.appointment_type || '',
      b.guardian_phone || '',
      b.symptoms || '',
      b.is_urgent ? 'YES' : 'NO',
      b.student_email || '',
      b.created_at || '',
      b.admin_notes || ''
    ]));

  const file = `clinic_bookings_${start || 'all'}_${end || 'all'}.csv`;
  eprDownloadCSV(file, headers, rows);

  showInlineMessage('clinicSuccessMessage',
    currentLang === 'ms' ? 'âœ… CSV berjaya dimuat turun.' : 'âœ… CSV downloaded successfully.',
    'success'
  );
}

function downloadRoomBookingsCSV() {
  const roomBookings = allData.filter(b => b.booking_type === 'room' || b.type === 'room');
  const start = (document.getElementById('roomExportStart') && document.getElementById('roomExportStart').value) ? document.getElementById('roomExportStart').value : '';
  const end = (document.getElementById('roomExportEnd') && document.getElementById('roomExportEnd').value) ? document.getElementById('roomExportEnd').value : '';
  const filtered = eprFilterByDateRange(roomBookings, start, end);

  if (!filtered.length) {
    showInlineMessage('roomSuccessMessage',
      currentLang === 'ms' ? 'â„¹ï¸ Tiada rekod untuk dimuat turun (CSV).' : 'â„¹ï¸ No records to download (CSV).',
      'error'
    );
    return;
  }

  const headers = [
    'Reference No', 'Status', 'Date', 'Start Time', 'Student Name', 'Student Category', 'Class',
    'Bed Location', 'Estimated Days', 'Guardian Phone', 'Purpose', 'Student Email', 'Created At', 'Expires At', 'Admin Notes'
  ];

  const rows = filtered
    .sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''))
    .map(b => ([
      b.reference_number || b.id,
      b.status || '',
      b.date || '',
      b.start_time || '',
      b.student_name || '',
      b.student_category || '',
      b.class_name || '',
      b.room_type || '',
      b.estimated_days || '',
      b.guardian_phone || '',
      b.purpose || '',
      b.student_email || '',
      b.created_at || '',
      b.expires_at || '',
      b.admin_notes || ''
    ]));

  const file = `bed_bookings_${start || 'all'}_${end || 'all'}.csv`;
  eprDownloadCSV(file, headers, rows);

  showInlineMessage('roomSuccessMessage',
    currentLang === 'ms' ? 'âœ… CSV berjaya dimuat turun.' : 'âœ… CSV downloaded successfully.',
    'success'
  );
}


// âœ… Download semua tempahan katil



    // Update dashboard
    function updateDashboard() {
      const clinicBookings = allData.filter(b => b.booking_type === 'clinic' || b.type === 'clinic');
      const roomBookings = allData.filter(b => b.booking_type === 'room' || b.type === 'room');
      const confirmedBookings = allData.filter(b => b.status === 'confirmed');
      const pendingBookings = allData.filter(b => b.status === 'pending');

      const statClinicTotal = document.getElementById('statClinicTotal');
      const statRoomTotal = document.getElementById('statRoomTotal');
      const statConfirmed = document.getElementById('statConfirmed');
      const statPending = document.getElementById('statPending');

      if (statClinicTotal) statClinicTotal.textContent = clinicBookings.length;
      if (statRoomTotal) statRoomTotal.textContent = roomBookings.length;
      if (statConfirmed) statConfirmed.textContent = confirmedBookings.length;
      if (statPending) statPending.textContent = pendingBookings.length;

      updateRecentBookings();
      updateUrgentCases();
      updateClassStats();
      updateTodayAppointments();
    }

    // Update recent bookings
    function updateRecentBookings() {
      const recentClinic = allData
        .filter(b => b.booking_type === 'clinic' || b.type === 'clinic')
        .slice(-5)
        .reverse();
      
      const recentRoom = allData
        .filter(b => b.booking_type === 'room' || b.type === 'room')
        .slice(-5)
        .reverse();

      const recentClinicEl = document.getElementById('recentClinicBookings');
      const recentRoomEl = document.getElementById('recentRoomBookings');

      if (recentClinicEl) {
        if (recentClinic.length === 0) {
          recentClinicEl.innerHTML = `<div class="empty-state"><p>${currentLang === 'ms' ? 'Tiada data' : 'No data'}</p></div>`;
        } else {
          recentClinicEl.innerHTML = recentClinic.map(b => `
            <div class="dashboard-item">
              <div class="dashboard-item-header">
                <span class="dashboard-item-title">${b.student_name}</span>
                <span class="dashboard-item-badge status-${b.status}">${b.status}</span>
              </div>
              <div class="dashboard-item-info">
                <span>${b.class_name} â€¢ ${b.date}</span>
              </div>
            </div>
          `).join('');
        }
      }

      if (recentRoomEl) {
        if (recentRoom.length === 0) {
          recentRoomEl.innerHTML = `<div class="empty-state"><p>${currentLang === 'ms' ? 'Tiada data' : 'No data'}</p></div>`;
        } else {
          recentRoomEl.innerHTML = recentRoom.map(b => `
            <div class="dashboard-item">
              <div class="dashboard-item-header">
                <span class="dashboard-item-title">${b.student_name}</span>
                <span class="dashboard-item-badge status-${b.status}">${b.status}</span>
              </div>
              <div class="dashboard-item-info">
                <span>${b.class_name} â€¢ ${b.date}</span>
              </div>
            </div>
          `).join('');
        }
      }
    }

    // Update urgent cases
    function updateUrgentCases() {
      const urgentCasesEl = document.getElementById('urgentCases');
      if (!urgentCasesEl) return;

      const urgent = allData.filter(b => b.is_urgent && b.status === 'pending');
      
      if (urgent.length === 0) {
        urgentCasesEl.innerHTML = `<div class="empty-state"><p>${currentLang === 'ms' ? 'Tiada kes keutamaan' : 'No urgent cases'}</p></div>`;
      } else {
        urgentCasesEl.innerHTML = urgent.map(b => `
          <div class="dashboard-item" style="border-left-color: #dc3545;">
            <div class="dashboard-item-header">
              <span class="dashboard-item-title">âš ï¸ ${b.student_name}</span>
              <span class="dashboard-item-badge" style="background: #dc3545; color: white;">${currentLang === 'ms' ? 'Urgent' : 'Urgent'}</span>
            </div>
            <div class="dashboard-item-info">
              <span>${b.class_name} â€¢ ${b.date}</span>
              <span>${b.symptoms || b.purpose}</span>
            </div>
          </div>
        `).join('');
      }
    }

    // Update class stats
    function updateClassStats() {
      const classStatsEl = document.getElementById('classStats');
      if (!classStatsEl) return;

      const classCount = {};
      allData.forEach(b => {
        if (b.class_name) {
          classCount[b.class_name] = (classCount[b.class_name] || 0) + 1;
        }
      });

      const sortedClasses = Object.entries(classCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      if (sortedClasses.length === 0) {
        classStatsEl.innerHTML = `<div class="empty-state"><p>${currentLang === 'ms' ? 'Tiada data' : 'No data'}</p></div>`;
      } else {
        classStatsEl.innerHTML = sortedClasses.map(([className, count]) => `
          <div class="class-stat-item">
            <span class="class-stat-name">${className}</span>
            <span class="class-stat-count">${count}</span>
          </div>
        `).join('');
      }
    }

    // Update today's appointments
    function updateTodayAppointments() {
      const todayAppointmentsEl = document.getElementById('todayAppointments');
      if (!todayAppointmentsEl) return;

      const today = new Date().toISOString().split('T')[0];
      const todayBookings = allData.filter(b => b.date === today);

      if (todayBookings.length === 0) {
        todayAppointmentsEl.innerHTML = `<div class="empty-state"><p>${currentLang === 'ms' ? 'Tiada temujanji hari ini' : 'No appointments today'}</p></div>`;
      } else {
        todayAppointmentsEl.innerHTML = todayBookings.map(b => `
          <div class="dashboard-item">
            <div class="dashboard-item-header">
              <span class="dashboard-item-title">${b.student_name}</span>
              <span class="dashboard-item-badge status-${b.status}">${b.status}</span>
            </div>
            <div class="dashboard-item-info">
              <span>${b.class_name} â€¢ ${b.time || b.start_time || '-'}</span>
              <span>${b.booking_type === 'clinic' ? (b.symptoms || '-') : (b.purpose || '-')}</span>
            </div>
          </div>
        `).join('');
      }
    }

    // Update profile display
    function updateProfileDisplay() {
      const profileData = allData.find(d => d.type === 'profile');
      
      if (profileData) {
        const schoolNameEl = document.getElementById('schoolName');
        const schoolLogoEl = document.getElementById('schoolLogo');
        const principalPhotoEl = document.getElementById('principalPhoto');
        const principalNameEl = document.getElementById('principalName');
        const principalPositionEl = document.getElementById('principalPosition');
        const principalPhoneEl = document.getElementById('principalPhone');
        const principalMessageEl = document.getElementById('principalMessage');
        const staffCountEl = document.getElementById('staffCount');
        const studentCountEl = document.getElementById('studentCount');
        const schoolAddressEl = document.getElementById('schoolAddress');
        const schoolEmailEl = document.getElementById('schoolEmail');
        const schoolPhoneEl = document.getElementById('schoolPhone');
        const schoolVisionEl = document.getElementById('schoolVision');
        const schoolMissionEl = document.getElementById('schoolMission');
        const footerTextEl = document.getElementById('footerText');
        const chatbotUrlEl = document.getElementById('chatbotUrl');
        const chatbotBtn = document.getElementById('chatbotBtn');

        const schoolName = currentLang === 'ms' ? 
          (profileData.school_name_ms || 'e-PRIhatin PELAJAR') : 
          (profileData.school_name_en || 'e-PRIhatin STUDENT');

        if (schoolNameEl) schoolNameEl.textContent = schoolName;
        
        if (schoolLogoEl && profileData.logo_url) {
          schoolLogoEl.src = profileData.logo_url;
          schoolLogoEl.style.display = 'block';
        }
        
        if (principalPhotoEl && profileData.principal_photo_url) {
          principalPhotoEl.src = profileData.principal_photo_url;
        }
        
        if (principalNameEl) principalNameEl.textContent = profileData.principal_name || 'Nama Pengetua';
        if (principalPositionEl) principalPositionEl.textContent = profileData.principal_position || 'Pengetua';
        if (principalPhoneEl) principalPhoneEl.textContent = profileData.principal_phone || '+60123456789';
        
        const principalMessage = currentLang === 'ms' ? 
          (profileData.principal_message_ms || 'Selamat datang ke portal e-PRIhatin kami.') : 
          (profileData.principal_message_en || 'Welcome to our e-PRIhatin portal.');
        if (principalMessageEl) principalMessageEl.textContent = principalMessage;
        
        if (staffCountEl) staffCountEl.textContent = profileData.staff_count || '50';
        if (studentCountEl) studentCountEl.textContent = profileData.student_count || '500';
        if (schoolAddressEl) schoolAddressEl.textContent = profileData.address || 'Kuala Lumpur';
        if (schoolEmailEl) schoolEmailEl.textContent = profileData.email || 'school@edu.my';
        if (schoolPhoneEl) schoolPhoneEl.textContent = profileData.phone || '+60312345678';
        
        const vision = currentLang === 'ms' ? 
          (profileData.vision_ms || 'Menjadi sekolah cemerlang yang melahirkan insan berilmu dan berakhlak mulia.') : 
          (profileData.vision_en || 'To become an excellent school that produces knowledgeable and virtuous individuals.');
        if (schoolVisionEl) schoolVisionEl.textContent = vision;
        
        const mission = currentLang === 'ms' ? 
          (profileData.mission_ms || 'Menyediakan pendidikan berkualiti tinggi untuk pembangunan holistik pelajar.') : 
          (profileData.mission_en || 'Providing high quality education for holistic student development.');
        if (schoolMissionEl) schoolMissionEl.textContent = mission;
        
        if (footerTextEl) footerTextEl.textContent = profileData.footer_text || 'Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.';
        
        if (chatbotUrlEl) chatbotUrlEl.value = profileData.chatbot_url || '';
        
        if (chatbotBtn) {
          if (profileData.chatbot_url && profileData.chatbot_url.trim() !== '') {
            chatbotBtn.classList.remove('hidden');
            chatbotBtn.setAttribute('data-url', profileData.chatbot_url);
          } else {
            chatbotBtn.classList.add('hidden');
          }
        }
      }
    }

    // Populate edit profile form
    function populateEditProfileForm() {
      const profileData = allData.find(d => d.type === 'profile') || {};

      document.getElementById('editSchoolNameMs').value = profileData.school_name_ms || 'e-PRIhatin PELAJAR';
      document.getElementById('editSchoolNameEn').value = profileData.school_name_en || 'e-PRIhatin STUDENT';
      document.getElementById('editLogoUrl').value = profileData.logo_url || '';
      document.getElementById('editStaffCount').value = profileData.staff_count || '50';
      document.getElementById('editStudentCount').value = profileData.student_count || '500';
      document.getElementById('editAddress').value = profileData.address || 'Kuala Lumpur';
      document.getElementById('editEmail').value = profileData.email || 'school@edu.my';
      document.getElementById('editPhone').value = profileData.phone || '+60312345678';
      document.getElementById('editVisionMs').value = profileData.vision_ms || 'Menjadi sekolah cemerlang yang melahirkan insan berilmu dan berakhlak mulia.';
      document.getElementById('editVisionEn').value = profileData.vision_en || 'To become an excellent school that produces knowledgeable and virtuous individuals.';
      document.getElementById('editMissionMs').value = profileData.mission_ms || 'Menyediakan pendidikan berkualiti tinggi untuk pembangunan holistik pelajar.';
      document.getElementById('editMissionEn').value = profileData.mission_en || 'Providing high quality education for holistic student development.';
      document.getElementById('editPrincipalName').value = profileData.principal_name || 'Nama Pengetua';
      document.getElementById('editPrincipalPosition').value = profileData.principal_position || 'Pengetua';
      document.getElementById('editPrincipalPhone').value = profileData.principal_phone || '+60123456789';
      document.getElementById('editPrincipalPhotoUrl').value = profileData.principal_photo_url || '';
      document.getElementById('editPrincipalMessageMs').value = profileData.principal_message_ms || 'Selamat datang ke portal e-PRIhatin kami.';
      document.getElementById('editPrincipalMessageEn').value = profileData.principal_message_en || 'Welcome to our e-PRIhatin portal.';
      document.getElementById('editFooterText').value = profileData.footer_text || 'Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.';
    }

    // Handle edit profile
    async function handleEditProfile(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      const saveBtn = document.getElementById('saveProfileBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menyimpan...' : 'Saving...');

      const profileData = {
        id: 'profile_1',
        type: 'profile',
        school_name_ms: document.getElementById('editSchoolNameMs').value,
        school_name_en: document.getElementById('editSchoolNameEn').value,
        logo_url: document.getElementById('editLogoUrl').value,
        staff_count: document.getElementById('editStaffCount').value,
        student_count: document.getElementById('editStudentCount').value,
        address: document.getElementById('editAddress').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        vision_ms: document.getElementById('editVisionMs').value,
        vision_en: document.getElementById('editVisionEn').value,
        mission_ms: document.getElementById('editMissionMs').value,
        mission_en: document.getElementById('editMissionEn').value,
        principal_name: document.getElementById('editPrincipalName').value,
        principal_position: document.getElementById('editPrincipalPosition').value,
        principal_phone: document.getElementById('editPrincipalPhone').value,
        principal_photo_url: document.getElementById('editPrincipalPhotoUrl').value,
        principal_message_ms: document.getElementById('editPrincipalMessageMs').value,
        principal_message_en: document.getElementById('editPrincipalMessageEn').value,
        footer_text: document.getElementById('editFooterText').value,
        chatbot_url: allData.find(d => d.type === 'profile')?.chatbot_url || ''
      };

      const existingProfile = allData.find(d => d.type === 'profile');
      
      let result;
      if (existingProfile) {
        profileData.__backendId = existingProfile.__backendId;
        result = await window.dataSdk.update(profileData);
      } else {
        result = await window.dataSdk.create(profileData);
      }

      if (result.isOk) {
        const editProfileModal = document.getElementById('editProfileModal');
        if (editProfileModal) {
          editProfileModal.classList.remove('active');
        }
        
        const successMsg = currentLang === 'ms' ? 
          'âœ… Profil berjaya dikemaskini!' : 
          'âœ… Profile updated successfully!';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = successMsg;
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
      } else {
        const errorMsg = currentLang === 'ms' ? 
          'âŒ Gagal mengemaskini profil.' : 
          'âŒ Failed to update profile.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
      }

      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    }

    // Handle chatbot settings
    async function handleChatbotSettings(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      const saveBtn = document.getElementById('saveChatbotBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menyimpan...' : 'Saving...');

      const chatbotUrl = document.getElementById('chatbotUrl').value.trim();
      
      const existingProfile = allData.find(d => d.type === 'profile');
      
      if (existingProfile) {
        existingProfile.chatbot_url = chatbotUrl;
        const result = await window.dataSdk.update(existingProfile);
        
        if (result.isOk) {
          const successMsg = currentLang === 'ms' ? 
            'âœ… Tetapan chatbot berjaya disimpan!' : 
            'âœ… Chatbot settings saved successfully!';
          
          const tempMsg = document.createElement('div');
          tempMsg.className = 'success-message show';
          tempMsg.textContent = successMsg;
          tempMsg.style.position = 'fixed';
          tempMsg.style.top = '20px';
          tempMsg.style.left = '50%';
          tempMsg.style.transform = 'translateX(-50%)';
          tempMsg.style.zIndex = '10000';
          document.body.appendChild(tempMsg);
          
          setTimeout(() => {
            document.body.removeChild(tempMsg);
          }, 3000);
        }
      } else {
        const profileData = {
          id: 'profile_1',
          type: 'profile',
          school_name_ms: 'e-PRIhatin PELAJAR',
          school_name_en: 'e-PRIhatin STUDENT',
          logo_url: '',
          staff_count: '50',
          student_count: '500',
          address: 'Kuala Lumpur',
          email: 'school@edu.my',
          phone: '+60312345678',
          vision_ms: 'Menjadi sekolah cemerlang yang melahirkan insan berilmu dan berakhlak mulia.',
          vision_en: 'To become an excellent school that produces knowledgeable and virtuous individuals.',
          mission_ms: 'Menyediakan pendidikan berkualiti tinggi untuk pembangunan holistik pelajar.',
          mission_en: 'Providing high quality education for holistic student development.',
          principal_name: 'Nama Pengetua',
          principal_position: 'Pengetua',
          principal_phone: '+60123456789',
          principal_photo_url: '',
          principal_message_ms: 'Selamat datang ke portal e-PRIhatin kami.',
          principal_message_en: 'Welcome to our e-PRIhatin portal.',
          footer_text: 'Â© 2024 e-PRIhatin PELAJAR. Hak Cipta Terpelihara.',
          chatbot_url: chatbotUrl
        };
        
        await window.dataSdk.create(profileData);
      }

      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    }

    // Handle chatbot button click
    function handleChatbotClick() {
      const chatbotBtn = document.getElementById('chatbotBtn');
      const url = chatbotBtn.getAttribute('data-url');
      
      if (url && url.trim() !== '') {
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    }


    // ===== Media helpers (v3) =====
    function isYouTubeUrl(url) {
      try {
        const u = new URL(url);
        return u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be');
      } catch { return false; }
    }

    function toYouTubeEmbed(url) {
      try {
        const u = new URL(url);
        let id = '';
        if (u.hostname.includes('youtu.be')) {
          id = u.pathname.replace('/', '');
        } else {
          id = u.searchParams.get('v') || '';
          if (!id && u.pathname.includes('/shorts/')) id = u.pathname.split('/shorts/')[1]?.split('?')[0] || '';
        }
        return id ? `https://www.youtube.com/embed/${id}` : '';
      } catch { return ''; }
    }

    async function readFileAsDataURL(file, maxMB = 1.5) {
      if (!file) return '';
      const maxBytes = maxMB * 1024 * 1024;
      if (file.size > maxBytes) {
        const msg = currentLang === 'ms'
          ? `Fail terlalu besar. Sila guna gambar lebih kecil (< ${maxMB}MB).`
          : `File is too large. Please use a smaller image (< ${maxMB}MB).`;
        alert(msg);
        return '';
      }
      return await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => resolve('');
        reader.readAsDataURL(file);
      });
    }

    function setupImagePicker(fileInputId, previewImgId, urlInputId) {
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewImgId);
      const urlInput = urlInputId ? document.getElementById(urlInputId) : null;
      if (!fileInput || !preview) return;

      fileInput.addEventListener('change', async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          preview.style.display = 'none';
          preview.src = '';
          return;
        }
        const data = await readFileAsDataURL(file);
        if (!data) {
          fileInput.value = '';
          preview.style.display = 'none';
          preview.src = '';
          return;
        }
        preview.src = data;
        preview.style.display = 'block';
        if (urlInput) urlInput.value = '';
      });
    }

    

    // Document picker: supports image/* and application/pdf. Stores as DataURL in hidden input.
    // Shows image preview OR a PDF link preview.
    function setupDocPicker(fileInputId, previewImgId, pdfLinkId, hiddenInputId, maxMB = 2) {
      const fileInput = document.getElementById(fileInputId);
      const previewImg = document.getElementById(previewImgId);
      const pdfLink = document.getElementById(pdfLinkId);
      const hidden = document.getElementById(hiddenInputId);
      if (!fileInput || !hidden) return;

      fileInput.addEventListener('change', async () => {
        const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
        if (!file) {
          hidden.value = '';
          if (previewImg) { previewImg.style.display = 'none'; previewImg.src = ''; }
          if (pdfLink) { pdfLink.style.display = 'none'; pdfLink.href = '#'; }
          return;
        }

        try {
          const dataUrl = await readFileAsDataURL(file, maxMB);
          hidden.value = dataUrl;

          const isPdf = (file.type || '').toLowerCase() === 'application/pdf' || dataUrl.startsWith('data:application/pdf');
          if (isPdf) {
            if (previewImg) { previewImg.style.display = 'none'; previewImg.src = ''; }
            if (pdfLink) { pdfLink.style.display = 'inline-block'; pdfLink.href = dataUrl; }
          } else {
            if (pdfLink) { pdfLink.style.display = 'none'; pdfLink.href = '#'; }
            if (previewImg) { previewImg.style.display = 'block'; previewImg.src = dataUrl; }
          }
        } catch (e) {
          hidden.value = '';
          if (previewImg) { previewImg.style.display = 'none'; previewImg.src = ''; }
          if (pdfLink) { pdfLink.style.display = 'none'; pdfLink.href = '#'; }
          showToast(String(e && e.message ? e.message : e), 'error');
        }
      });
    }
function renderMediaBlock(item, titleText='') {
      const imgSrc = item.image_data || item.image_url || '';
      const videoUrl = item.video_url || '';
      const linkUrl = item.link_url || '';

      const parts = [];

      if (imgSrc) {
        parts.push(`<img src="${imgSrc}" alt="${titleText}" onerror="this.style.display='none';">`);
      }

      if (videoUrl) {
        if (isYouTubeUrl(videoUrl)) {
          const embed = toYouTubeEmbed(videoUrl);
          if (embed) {
            parts.push(`<iframe src="${embed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`);
          }
        } else {
          parts.push(`<video controls src="${videoUrl}" onerror="this.style.display='none';"></video>`);
        }
      }

      if (linkUrl) {
        parts.push(`<a class="media-link-btn" href="${linkUrl}" target="_blank" rel="noopener noreferrer">ðŸ”— <span>${currentLang === 'ms' ? 'Buka Pautan' : 'Open Link'}</span></a>`);
      }

      if (!parts.length) return '';
      return `<div class="media-block">${parts.join('')}</div>`;
    }

    
    // ===== Home Hero Slider (Announcements on Home) =====
    function escapeHtml(str='') {
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function getAnnouncementById(id) {
      return allData.find(d => d.type === 'announcement' && ((d.__backendId || d.id) === id));
    }

    function getAnnouncementTitle(ann) {
      return currentLang === 'ms' ? (ann.title_ms || '') : (ann.title_en || ann.title_ms || '');
    }

    function getAnnouncementContent(ann) {
      return currentLang === 'ms' ? (ann.content_ms || '') : (ann.content_en || ann.content_ms || '');
    }

    function makeExcerpt(text, maxLen = 140) {
      const clean = String(text || '').replace(/\s+/g, ' ').trim();
      if (clean.length <= maxLen) return clean;
      return clean.slice(0, maxLen).trim() + 'â€¦';
    }

    function setupHomeHero() {
      const slider = document.getElementById('homeHeroSlider');
      if (!slider || slider.dataset.bound === '1') return;

      slider.dataset.bound = '1';

      const prevBtn = document.getElementById('homeHeroPrev');
      const nextBtn = document.getElementById('homeHeroNext');

      if (prevBtn) prevBtn.addEventListener('click', () => homeHeroGo(-1, true));
      if (nextBtn) nextBtn.addEventListener('click', () => homeHeroGo(1, true));

      // Pause on hover (desktop)
      slider.addEventListener('mouseenter', () => homeHeroStop());
      slider.addEventListener('mouseleave', () => homeHeroStart());

      // Swipe support (mobile)
      slider.addEventListener('touchstart', (e) => {
        homeHeroTouchStartX = e.touches && e.touches[0] ? e.touches[0].clientX : null;
      }, { passive: true });

      slider.addEventListener('touchend', (e) => {
        if (homeHeroTouchStartX == null) return;
        const endX = e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : null;
        if (endX == null) return;
        const diff = endX - homeHeroTouchStartX;
        homeHeroTouchStartX = null;

        if (Math.abs(diff) < 40) return;
        if (diff < 0) homeHeroGo(1, true);
        else homeHeroGo(-1, true);
      }, { passive: true });

      // Modal close
      const modal = document.getElementById('announcementModal');
      const closeBtn = document.getElementById('closeAnnouncementModal');
      if (closeBtn) closeBtn.addEventListener('click', closeAnnouncementModal);
      if (modal) modal.addEventListener('click', (e) => {
        if (e.target === modal) closeAnnouncementModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAnnouncementModal();
      });
    }

    function updateHomeHeroSlider(announcements = []) {
      setupHomeHero();

      const slidesEl = document.getElementById('homeHeroSlides');
      const dotsEl = document.getElementById('homeHeroDots');
      if (!slidesEl || !dotsEl) return;

      const sorted = [...announcements].sort((a,b) => {
        const ad = new Date(a.created_at || a.date || 0).getTime();
        const bd = new Date(b.created_at || b.date || 0).getTime();
        return bd - ad;
      });

      homeHeroItems = sorted.slice(0, 8);

      if (homeHeroItems.length === 0) {
        slidesEl.innerHTML = `
          <div class="hero-slide active">
            <div class="hero-bg" style="background-image: radial-gradient(800px 300px at 35% 20%, rgba(255,111,163,0.25), transparent 60%), radial-gradient(700px 280px at 85% 80%, rgba(111,203,255,0.16), transparent 55%);"></div>
            <div class="hero-overlay"></div>
            <div class="hero-content">
              <div class="hero-tag">ðŸ“¢ <span>${currentLang === 'ms' ? 'Makluman' : 'Announcements'}</span></div>
              <h3 class="hero-title">${currentLang === 'ms' ? 'Tiada makluman lagi' : 'No announcements yet'}</h3>
              <p class="hero-excerpt">${currentLang === 'ms' ? 'Bila admin tambah makluman, ia akan auto muncul di sini.' : 'When admin adds announcements, they will appear here automatically.'}</p>
              <div class="hero-actions">
                <button class="hero-btn secondary" type="button" onclick="navigateToSection('announcements')">ðŸ“¢ ${currentLang === 'ms' ? 'Pergi ke Makluman' : 'Go to Announcements'}</button>
              </div>
            </div>
          </div>
        `;
        dotsEl.innerHTML = '';
        homeHeroIndex = 0;
        homeHeroStop();
        return;
      }

      slidesEl.innerHTML = homeHeroItems.map((ann, i) => {
        const id = (ann.__backendId || ann.id);
        const title = getAnnouncementTitle(ann);
        const content = getAnnouncementContent(ann);
        const excerpt = makeExcerpt(content, 160);
        const dateText = ann.date ? escapeHtml(ann.date) : '';
        const imgSrc = ann.image_data || ann.image_url || '';
        const bg = imgSrc ? `background-image: url('${imgSrc}');` : `background-image: radial-gradient(800px 300px at 35% 20%, rgba(255,111,163,0.22), transparent 60%), radial-gradient(700px 280px at 85% 80%, rgba(111,203,255,0.14), transparent 55%);`;

        return `
          <div class="hero-slide ${i===0 ? 'active' : ''}" data-hero-index="${i}">
            <div class="hero-bg" style="${bg}"></div>
            <div class="hero-overlay"></div>
            <div class="hero-content">
              <div class="hero-tag">ðŸ“¢ <span>${currentLang === 'ms' ? 'Makluman' : 'Announcements'}</span></div>
              <div class="hero-meta">
                <span>ðŸ—“ï¸ ${dateText || (currentLang === 'ms' ? 'Tarikh tidak dinyatakan' : 'No date')}</span>
              </div>
              <h3 class="hero-title">${escapeHtml(title || (currentLang === 'ms' ? 'Makluman' : 'Announcement'))}</h3>
              <p class="hero-excerpt">${escapeHtml(excerpt)}</p>
              <div class="hero-actions">
                <button class="hero-btn primary" type="button" onclick="openAnnouncementModal('${id}')">âœ¨ ${currentLang === 'ms' ? 'Baca Lagi' : 'Read More'}</button>
                <button class="hero-btn secondary" type="button" onclick="goToAnnouncement('${id}')">ðŸ“„ ${currentLang === 'ms' ? 'Detail' : 'Detail'}</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      dotsEl.innerHTML = homeHeroItems.map((_, i) => `
        <button class="hero-dot ${i===0 ? 'active' : ''}" type="button" aria-label="Slide ${i+1}" onclick="setHomeHeroSlide(${i}, true)"></button>
      `).join('');

      homeHeroIndex = 0;
      homeHeroStart();
    }

    function setHomeHeroSlide(idx, fromUser = false) {
      const slides = document.querySelectorAll('#homeHeroSlides .hero-slide');
      const dots = document.querySelectorAll('#homeHeroDots .hero-dot');
      if (!slides.length) return;

      const next = ((idx % slides.length) + slides.length) % slides.length;
      homeHeroIndex = next;

      slides.forEach((s, i) => s.classList.toggle('active', i === next));
      dots.forEach((d, i) => d.classList.toggle('active', i === next));

      if (fromUser) homeHeroRestart();
    }

    function homeHeroGo(delta, fromUser = false) {
      const slides = document.querySelectorAll('#homeHeroSlides .hero-slide');
      if (!slides.length) return;
      setHomeHeroSlide(homeHeroIndex + delta, fromUser);
    }

    function homeHeroStart() {
      homeHeroStop();
      const slides = document.querySelectorAll('#homeHeroSlides .hero-slide');
      if (!slides.length || slides.length <= 1) return;

      homeHeroTimer = setInterval(() => {
        setHomeHeroSlide(homeHeroIndex + 1, false);
      }, 5000);
    }

    function homeHeroStop() {
      if (homeHeroTimer) {
        clearInterval(homeHeroTimer);
        homeHeroTimer = null;
      }
    }

    function homeHeroRestart() {
      homeHeroStart();
    }

    function openAnnouncementModal(id) {
      const ann = getAnnouncementById(id);
      if (!ann) return;

      const modal = document.getElementById('announcementModal');
      const body = document.getElementById('announcementModalBody');
      if (!modal || !body) return;

      const title = getAnnouncementTitle(ann);
      const content = getAnnouncementContent(ann);
      const dateText = ann.date ? escapeHtml(ann.date) : '';

      body.innerHTML = `
        <h3 style="margin: 0 0 0.35rem; font-size: 1.4rem;">${escapeHtml(title)}</h3>
        <div style="color: #777; font-weight: 600; margin-bottom: 1rem;">ðŸ—“ï¸ ${dateText || (currentLang === 'ms' ? 'Tarikh tidak dinyatakan' : 'No date')}</div>
        <p style="margin: 0; line-height: 1.75; white-space: pre-line;">${escapeHtml(content)}</p>
        ${renderMediaBlock(ann, title)}
      `;

      modal.classList.add('active');
      homeHeroStop();
    }

    function closeAnnouncementModal() {
      const modal = document.getElementById('announcementModal');
      if (!modal) return;
      modal.classList.remove('active');
      homeHeroStart();
    }

    function goToAnnouncement(id) {
      navigateToSection('announcements');

      // Scroll to the specific card (after section becomes visible)
      setTimeout(() => {
        const card = document.getElementById('announcement-card-' + id);
        if (card && typeof card.scrollIntoView === 'function') {
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
          card.style.transition = 'box-shadow 0.3s ease';
          card.style.boxShadow = '0 0 0 4px rgba(255,111,163,0.25)';
          setTimeout(() => { card.style.boxShadow = ''; }, 1200);
        }
      }, 120);
    }

// ===== Sick bay medicines (v3) =====
    const MEDICINE_KEY = 'medicineInventoryV1';

    function getDefaultMedicines() {
      return [
        { name: 'Paracetamol', qty: 'â€”', note: '' },
        { name: 'Plaster / Bandage', qty: 'â€”', note: '' },
        { name: 'Gauze', qty: 'â€”', note: '' },
        { name: 'Antiseptic wipes', qty: 'â€”', note: '' },
        { name: 'Thermometer', qty: 'â€”', note: '' }
      ];
    }

    function loadMedicines() {
      try {
        const raw = localStorage.getItem(MEDICINE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed)) return parsed;
      } catch {}
      return getDefaultMedicines();
    }

    function saveMedicines(list) {
      localStorage.setItem(MEDICINE_KEY, JSON.stringify(list));
    }

    function renderMedicines() {
      const listEl = document.getElementById('medicineList');
      const adminPanel = document.getElementById('medicineAdminPanel');
      const adminList = document.getElementById('medicineAdminList');
      if (!listEl) return;

      const meds = loadMedicines();

      // Student + Admin view list
      listEl.innerHTML = meds.map(m => {
        const qty = (m.qty && String(m.qty).trim()) ? String(m.qty) : 'â€”';
        const note = (m.note && String(m.note).trim()) ? ` â€¢ ${m.note}` : '';
        return `<li><strong>${m.name}</strong> <span style="color:#666;">(${qty}${note})</span></li>`;
      }).join('');

      // Admin controls
      const showAdmin = (isLoggedIn && userRole === 'admin');
      if (adminPanel) adminPanel.style.display = showAdmin ? 'block' : 'none';

      if (showAdmin && adminList) {
        adminList.innerHTML = meds.map((m, idx) => {
          const qty = (m.qty && String(m.qty).trim()) ? String(m.qty) : 'â€”';
          const note = (m.note && String(m.note).trim()) ? m.note : '';
          return `
            <div class="medicine-item">
              <div>
                <div style="font-weight:800; color:#4a1631;">${m.name}</div>
                <small>${currentLang === 'ms' ? 'Kuantiti' : 'Qty'}: ${qty}${note ? ' â€¢ ' + note : ''}</small>
              </div>
              <button class="medicine-del" type="button" onclick="deleteMedicine(${idx})">ðŸ—‘ï¸</button>
            </div>
          `;
        }).join('');
      }
    }

    function addMedicine() {
      const nameEl = document.getElementById('medName');
      const qtyEl = document.getElementById('medQty');
      const noteEl = document.getElementById('medNote');
      if (!nameEl) return;
      const name = String(nameEl.value || '').trim();
      const qty = String(qtyEl?.value || '').trim() || 'â€”';
      const note = String(noteEl?.value || '').trim();

      if (!name) {
        alert(currentLang === 'ms' ? 'Sila isi nama ubat/item.' : 'Please enter a medicine/item name.');
        return;
      }

      const meds = loadMedicines();
      meds.unshift({ name, qty, note });
      saveMedicines(meds);

      nameEl.value = '';
      if (qtyEl) qtyEl.value = '';
      if (noteEl) noteEl.value = '';
      renderMedicines();

      function __clearPreview(imgId, fileId){
        const img = document.getElementById(imgId);
        const fi = document.getElementById(fileId);
        if (img) { img.style.display='none'; img.src=''; }
        if (fi) { fi.value=''; }
      }
      const __formsToClear = [
        {form:'announcementForm', img:'announcementImagePreview', file:'announcementImageFile'},
        {form:'programForm', img:'programImagePreview', file:'programImageFile'},
        {form:'achievementForm', img:'achievementImagePreview', file:'achievementImageFile'},
        {form:'publicSharingForm', img:'publicSharingImagePreview', file:'publicSharingImageFile'},
        {form:'sharingForm', img:'sharingImagePreview', file:'sharingImageFile'}
      ];
      __formsToClear.forEach(x=>{
        const f=document.getElementById(x.form);
        if (!f) return;
        f.addEventListener('reset', ()=>__clearPreview(x.img,x.file));
      });

    }

    function deleteMedicine(index) {
      const meds = loadMedicines();
      meds.splice(index, 1);
      saveMedicines(meds);
      renderMedicines();

      function __clearPreview(imgId, fileId){
        const img = document.getElementById(imgId);
        const fi = document.getElementById(fileId);
        if (img) { img.style.display='none'; img.src=''; }
        if (fi) { fi.value=''; }
      }
      const __formsToClear = [
        {form:'announcementForm', img:'announcementImagePreview', file:'announcementImageFile'},
        {form:'programForm', img:'programImagePreview', file:'programImageFile'},
        {form:'achievementForm', img:'achievementImagePreview', file:'achievementImageFile'},
        {form:'publicSharingForm', img:'publicSharingImagePreview', file:'publicSharingImageFile'},
        {form:'sharingForm', img:'sharingImagePreview', file:'sharingImageFile'}
      ];
      __formsToClear.forEach(x=>{
        const f=document.getElementById(x.form);
        if (!f) return;
        f.addEventListener('reset', ()=>__clearPreview(x.img,x.file));
      });

    }

    // Announcement functions (placeholder)
    async function handleAnnouncementSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        return;
      }

      
      const __imageData = await readFileAsDataURL((document.getElementById('announcementImageFile')||{}).files?.[0]);

      const announcementData = {
        id: 'announcement_' + Date.now(),
        type: 'announcement',
        title_ms: document.getElementById('announcementTitleMs').value,
        title_en: document.getElementById('announcementTitleEn').value,
        content_ms: document.getElementById('announcementContentMs').value,
        content_en: document.getElementById('announcementContentEn').value,
        date: document.getElementById('announcementDate').value,
        image_url: document.getElementById('announcementImageUrl').value || '',
        image_data: __imageData || '',
        video_url: document.getElementById('announcementVideoUrl')?.value || '',
        link_url: document.getElementById('announcementLinkUrl')?.value || '',
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(announcementData);
      
      e.target.reset();
      document.getElementById('announcementFormContainer').style.display = 'none';
    }

    function updateAnnouncements() {
      const announcementsList = document.getElementById('announcementsList');
      if (!announcementsList) return;

      const announcements = allData.filter(d => d.type === 'announcement');
      
      
      // Update HiAnime-style slider on Home
      try { updateHomeHeroSlider(announcements); } catch (e) {}

if (announcements.length === 0) {
        announcementsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“¢</div>
            <p>${currentLang === 'ms' ? 'Tiada makluman lagi.' : 'No announcements yet.'}</p>
          </div>
        `;
        return;
      }

      announcementsList.innerHTML = announcements.map(ann => {
        const title = currentLang === 'ms' ? ann.title_ms : ann.title_en;
        const content = currentLang === 'ms' ? ann.content_ms : ann.content_en;
        const uniqueId = ann.__backendId || ann.id;
        
        return `
          <div class="booking-card" id="announcement-card-${uniqueId}">
            <div class="booking-header">
              <span class="booking-ref">${title}</span>
              <span class="detail-value">${ann.date}</span>
            </div>
            <div class="booking-details">
              <p style="margin-top: 1rem; line-height: 1.6;">${content}</p>
              ${renderMediaBlock(ann, title)}
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteAnnouncement('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteAnnouncement(id) {
      const announcement = allData.find(d => (d.__backendId || d.id) === id);
      if (!announcement || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam makluman ini?' : 'Delete this announcement?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(announcement);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Program functions (placeholder)
    async function handleProgramSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        return;
      }

      
      const __imageData = await readFileAsDataURL((document.getElementById('programImageFile')||{}).files?.[0]);

      const programData = {
        id: 'program_' + Date.now(),
        type: 'program',
        name_ms: document.getElementById('programNameMs').value,
        name_en: document.getElementById('programNameEn').value,
        description_ms: document.getElementById('programDescMs').value,
        description_en: document.getElementById('programDescEn').value,
        date: document.getElementById('programDate').value,
        time: document.getElementById('programTime').value,
        venue: document.getElementById('programVenue').value,
        image_url: document.getElementById('programImageUrl').value || '',
        image_data: __imageData || '',
        video_url: document.getElementById('programVideoUrl')?.value || '',
        link_url: document.getElementById('programLinkUrl')?.value || '',
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(programData);
      
      e.target.reset();
      document.getElementById('programFormContainer').style.display = 'none';
    }

    function updatePrograms() {
      const programsList = document.getElementById('programsList');
      if (!programsList) return;

      const programs = allData.filter(d => d.type === 'program');
      
      if (programs.length === 0) {
        programsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“…</div>
            <p>${currentLang === 'ms' ? 'Tiada program lagi.' : 'No programs yet.'}</p>
          </div>
        `;
        return;
      }

      programsList.innerHTML = programs.map(prog => {
        const name = currentLang === 'ms' ? prog.name_ms : prog.name_en;
        const description = currentLang === 'ms' ? prog.description_ms : prog.description_en;
        const uniqueId = prog.__backendId || prog.id;
        
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${name}</span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Tarikh:' : 'Date:'}</span>
                <span class="detail-value">${prog.date} ${prog.time}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Tempat:' : 'Venue:'}</span>
                <span class="detail-value">${prog.venue}</span>
              </div>
              <p style="margin-top: 1rem; line-height: 1.6;">${description}</p>
              ${renderMediaBlock(prog, name)}
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteProgram('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteProgram(id) {
      const program = allData.find(d => (d.__backendId || d.id) === id);
      if (!program || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam program ini?' : 'Delete this program?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(program);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Achievement functions (placeholder)
    async function handleAchievementSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        return;
      }

      
      const __imageData = await readFileAsDataURL((document.getElementById('achievementImageFile')||{}).files?.[0]);

      const achievementData = {
        id: 'achievement_' + Date.now(),
        type: 'achievement',
        title_ms: document.getElementById('achievementTitleMs').value,
        title_en: document.getElementById('achievementTitleEn').value,
        description_ms: document.getElementById('achievementDescMs').value,
        description_en: document.getElementById('achievementDescEn').value,
        date: document.getElementById('achievementDate').value,
        category: document.getElementById('achievementCategory').value,
        image_url: document.getElementById('achievementImageUrl').value || '',
        image_data: __imageData || '',
        video_url: document.getElementById('achievementVideoUrl')?.value || '',
        link_url: document.getElementById('achievementLinkUrl')?.value || '',
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(achievementData);
      
      e.target.reset();
      document.getElementById('achievementFormContainer').style.display = 'none';
    }

    function updateAchievements() {
      const achievementsList = document.getElementById('achievementsList');
      if (!achievementsList) return;

      const achievements = allData.filter(d => d.type === 'achievement');
      
      if (achievements.length === 0) {
        achievementsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ†</div>
            <p>${currentLang === 'ms' ? 'Tiada kejayaan lagi.' : 'No achievements yet.'}</p>
          </div>
        `;
        return;
      }

      achievementsList.innerHTML = achievements.map(ach => {
        const title = currentLang === 'ms' ? ach.title_ms : ach.title_en;
        const description = currentLang === 'ms' ? ach.description_ms : ach.description_en;
        const uniqueId = ach.__backendId || ach.id;
        
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">ðŸ† ${title}</span>
              <span class="detail-value">${ach.date}</span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Kategori:' : 'Category:'}</span>
                <span class="detail-value">${ach.category}</span>
              </div>
              <p style="margin-top: 1rem; line-height: 1.6;">${description}</p>
              ${renderMediaBlock(ach, title)}
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteAchievement('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteAchievement(id) {
      const achievement = allData.find(d => (d.__backendId || d.id) === id);
      if (!achievement || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam kejayaan ini?' : 'Delete this achievement?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(achievement);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Schedule functions
    async function handleScheduleSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        return;
      }

      const scheduleData = {
        id: 'schedule_' + Date.now(),
        type: 'schedule',
        title: document.getElementById('scheduleTitle').value,
        image_url: document.getElementById('scheduleImageUrl').value,
        month: document.getElementById('scheduleMonth').value,
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(scheduleData);
      
      e.target.reset();
      document.getElementById('scheduleFormContainer').style.display = 'none';
    }

    function updateSchedules() {
      const schedulesList = document.getElementById('schedulesList');
      if (!schedulesList) return;

      const schedules = allData.filter(d => d.type === 'schedule');
      
      if (schedules.length === 0) {
        schedulesList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ‘¥</div>
            <p>${currentLang === 'ms' ? 'Tiada jadual bertugas lagi.' : 'No duty schedules yet.'}</p>
          </div>
        `;
        return;
      }

      schedulesList.innerHTML = schedules.map(sch => {
        const uniqueId = sch.__backendId || sch.id;
        
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${sch.title}</span>
              <span class="detail-value">${sch.month}</span>
            </div>
            <div class="booking-details">
              ${sch.image_url ? `<img src="${sch.image_url}" alt="${sch.title}" style="width: 100%; margin-top: 1rem; border-radius: 10px;" onerror="this.style.display='none'; this.alt='Image failed to load';">` : ''}
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteSchedule('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteSchedule(id) {
      const schedule = allData.find(d => (d.__backendId || d.id) === id);
      if (!schedule || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam jadual ini?' : 'Delete this schedule?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(schedule);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Sharing functions
    async function handlePublicSharingSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      const submitBtn = document.getElementById('submitPublicSharingBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menghantar...' : 'Submitting...');

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      
      const __imageData = await readFileAsDataURL((document.getElementById('publicSharingImageFile')||{}).files?.[0]);

      const sharingData = {
        id: 'sharing_' + Date.now(),
        type: 'sharing',
        title_ms: document.getElementById('publicSharingTitleMs').value,
        title_en: document.getElementById('publicSharingTitleEn').value,
        content_ms: document.getElementById('publicSharingContentMs').value,
        content_en: document.getElementById('publicSharingContentEn').value,
        author: document.getElementById('publicSharingAuthor').value,
        date: new Date().toISOString().split('T')[0],
        image_url: document.getElementById('publicSharingImageUrl').value || '',
        image_data: __imageData || '',
        video_url: document.getElementById('publicSharingVideoUrl')?.value || '',
        link_url: document.getElementById('publicSharingLinkUrl')?.value || '',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(sharingData);
      
      if (result.isOk) {
        e.target.reset();
        
        const successMsg = currentLang === 'ms' ? 
          'âœ… Terima kasih! Perkongsian anda telah dihantar.' : 
          'âœ… Thank you! Your sharing has been submitted.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = successMsg;
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }

    function updateSharing() {
      const sharingList = document.getElementById('sharingList');
      if (!sharingList) return;

      const sharings = allData.filter(d => d.type === 'sharing');
      
      if (sharings.length === 0) {
        sharingList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“¸</div>
            <p>${currentLang === 'ms' ? 'Tiada perkongsian lagi.' : 'No sharings yet.'}</p>
          </div>
        `;
        return;
      }

      sharingList.innerHTML = sharings.map(shr => {
        const title = currentLang === 'ms' ? shr.title_ms : shr.title_en;
        const content = currentLang === 'ms' ? shr.content_ms : shr.content_en;
        const uniqueId = shr.__backendId || shr.id;
        
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${title}</span>
              <span class="detail-value">${shr.date}</span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Oleh:' : 'By:'}</span>
                <span class="detail-value">${shr.author}</span>
              </div>
              <p style="margin-top: 1rem; line-height: 1.6;">${content}</p>
              ${renderMediaBlock(shr, title)}
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteSharing('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteSharing(id) {
      const sharing = allData.find(d => (d.__backendId || d.id) === id);
      if (!sharing || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam perkongsian ini?' : 'Delete this sharing?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(sharing);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Guestbook functions
    async function handleGuestbookSubmit(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;

      const submitBtn = document.getElementById('guestbookSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'ms' ? 'Menghantar...' : 'Submitting...');

      if (allData.length >= 999) {
        const errorMsg = currentLang === 'ms' ? 
          'Had maksimum 999 rekod telah dicapai.' : 
          'Maximum limit of 999 records reached.';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = 'âŒ ' + errorMsg;
        tempMsg.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        tempMsg.style.color = '#721c24';
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      const guestbookData = {
        id: 'guestbook_' + Date.now(),
        type: 'guestbook',
        name: document.getElementById('guestName').value,
        email: document.getElementById('guestEmail').value || '',
        phone: document.getElementById('guestPhone').value || '',
        organization: document.getElementById('guestOrganization').value,
        purpose: document.getElementById('guestPurpose').value,
        message: document.getElementById('guestMessage').value,
        rating: document.getElementById('guestRating').value,
        date: new Date().toISOString().split('T')[0],
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(guestbookData);
      
      if (result.isOk) {
        e.target.reset();
        
        const successMsg = currentLang === 'ms' ? 
          'âœ… Terima kasih atas lawatan anda!' : 
          'âœ… Thank you for your visit!';
        
        const tempMsg = document.createElement('div');
        tempMsg.className = 'success-message show';
        tempMsg.textContent = successMsg;
        tempMsg.style.position = 'fixed';
        tempMsg.style.top = '20px';
        tempMsg.style.left = '50%';
        tempMsg.style.transform = 'translateX(-50%)';
        tempMsg.style.zIndex = '10000';
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 3000);
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }

    function updateGuestbook() {
      const guestbookList = document.getElementById('guestbookList');
      if (!guestbookList) return;

      const entries = allData.filter(d => d.type === 'guestbook');
      
      if (entries.length === 0) {
        guestbookList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“–</div>
            <p>${currentLang === 'ms' ? 'Tiada entri buku pelawat lagi.' : 'No guestbook entries yet.'}</p>
          </div>
        `;
        return;
      }

      guestbookList.innerHTML = entries.map(entry => {
        const uniqueId = entry.__backendId || entry.id;
        const stars = 'â­'.repeat(parseInt(entry.rating));
        
        return `
          <div class="booking-card">
            <div class="booking-header">
              <span class="booking-ref">${entry.name}</span>
              <span class="detail-value">${entry.date}</span>
            </div>
            <div class="booking-details">
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Organisasi:' : 'Organization:'}</span>
                <span class="detail-value">${entry.organization}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Tujuan:' : 'Purpose:'}</span>
                <span class="detail-value">${entry.purpose}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">${currentLang === 'ms' ? 'Penilaian:' : 'Rating:'}</span>
                <span class="detail-value">${stars}</span>
              </div>
              ${entry.email ? `
                <div class="detail-row">
                  <span class="detail-label">${currentLang === 'ms' ? 'Emel:' : 'Email:'}</span>
                  <span class="detail-value">${entry.email}</span>
                </div>
              ` : ''}
              ${entry.phone ? `
                <div class="detail-row">
                  <span class="detail-label">${currentLang === 'ms' ? 'Telefon:' : 'Phone:'}</span>
                  <span class="detail-value">${entry.phone}</span>
                </div>
              ` : ''}
              <p style="margin-top: 1rem; line-height: 1.6; font-style: italic;">"${entry.message}"</p>
            </div>
            ${isLoggedIn ? `
              <div class="admin-actions" style="margin-top: 1rem;">
                <button class="admin-btn" onclick="deleteGuestbook('${uniqueId}')" style="background: #dc3545; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                  ðŸ—‘ï¸ ${currentLang === 'ms' ? 'Padam' : 'Delete'}
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteGuestbook(id) {
      const entry = allData.find(d => (d.__backendId || d.id) === id);
      if (!entry || !window.dataSdk) return;

      const confirmMsg = currentLang === 'ms' ? 'Padam entri ini?' : 'Delete this entry?';
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; color: #333;">${confirmMsg}</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirmYes" style="background: #dc3545; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Ya' : 'Yes'}
          </button>
          <button id="confirmNo" style="background: #6c757d; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            ${currentLang === 'ms' ? 'Tidak' : 'No'}
          </button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmYes').onclick = async () => {
        await window.dataSdk.delete(entry);
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmNo').onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(confirmDiv);
      };
    }

    // Create floating particles
    function createParticles() {
      const particlesContainer = document.querySelector('.particles-container');
      if (!particlesContainer) return;

        for (let i = 0; i < 25; i++) {                 // lebih banyak bubble sikit
    const particle = document.createElement('div');
    particle.className = 'particle';

    // posisi kiri rawak
    particle.style.left = Math.random() * 100 + '%';

    // masa animasi: 15s â€“ 30s
    particle.style.animationDuration = (Math.random() * 15 + 15) + 's';

    // delay mula
    particle.style.animationDelay = (Math.random() * 10) + 's';

    // SAIZ BUBBLE: 30px â€“ 90px
    const size = Math.random() * 60 + 30;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';

    particlesContainer.appendChild(particle);
  }

    }

    // Initialize app on load
    document.addEventListener('DOMContentLoaded', () => {
      checkLoginStatus();
      initializeApp();
      createParticles();
	  setupStudentLogin();
	   navigateToSection('home');
    
      // ===== v3: media inputs + medicine inventory init =====
      try {
        setupImagePicker('announcementImageFile','announcementImagePreview','announcementImageUrl');
        setupImagePicker('programImageFile','programImagePreview','programImageUrl');
        setupImagePicker('achievementImageFile','achievementImagePreview','achievementImageUrl');
        setupImagePicker('publicSharingImageFile','publicSharingImagePreview','publicSharingImageUrl');
        setupImagePicker('sharingImageFile','sharingImagePreview','sharingImageUrl');
      // Supporting document uploads (Clinic & Sick Bed)
      setupDocPicker('documentFile','documentPreview','documentPdfLink','documentFileData', 2);
      setupDocPicker('roomDocumentFile','roomDocumentPreview','roomDocumentPdfLink','roomDocumentFileData', 2);

      } catch(e) {}

      try {
        const addMedBtn = document.getElementById('addMedicineBtn');
        if (addMedBtn) addMedBtn.addEventListener('click', addMedicine);
        renderMedicines();
      } catch(e) {}

      try {
        function __clearPreview(imgId, fileId){
          const img = document.getElementById(imgId);
          const fi = document.getElementById(fileId);
          if (img) { img.style.display='none'; img.src=''; }
          if (fi) { fi.value=''; }
        }
        const __formsToClear = [
          {form:'announcementForm', img:'announcementImagePreview', file:'announcementImageFile'},
          {form:'programForm', img:'programImagePreview', file:'programImageFile'},
          {form:'achievementForm', img:'achievementImagePreview', file:'achievementImageFile'},
          {form:'publicSharingForm', img:'publicSharingImagePreview', file:'publicSharingImageFile'},
          {form:'sharingForm', img:'sharingImagePreview', file:'sharingImageFile'}
        ];
        __formsToClear.forEach(x=>{
          const f=document.getElementById(x.form);
          if (!f) return;
          f.addEventListener('reset', ()=>__clearPreview(x.img,x.file));
        });
      } catch(e) {}

    });
</script>
  <script>
// === Generate Floating Bubbles / Particles ===
function spawnParticles() {
  const container = document.querySelector('.particles-container');
  if (!container) return;

  // Generate 25 bubbles
  for (let i = 0; i < 25; i++) {
    const bubble = document.createElement('div');
    bubble.classList.add('particle');

    // Size bubble random
    let size = Math.random() * 50 + 20; 
    bubble.style.width = size + 'px';
    bubble.style.height = size + 'px';

    // Posisi permulaan random
    bubble.style.left = Math.random() * 100 + 'vw';
    bubble.style.top = (Math.random() * 80 + 20) + 'vh';

    // Duration animasi random
    bubble.style.animationDuration = (Math.random() * 8 + 8) + 's';

    // Delay untuk setiap bubble
    bubble.style.animationDelay = (Math.random() * 5) + 's';

    container.appendChild(bubble);

    // Auto remove bubble bila habis animation
    setTimeout(() => bubble.remove(), 15000);
  }

  // Respawn bubble setiap 5 saat
  setTimeout(spawnParticles, 5000);
}

// Start bubble animation
window.addEventListener('load', spawnParticles);
</script>

<script>
/* ===========================
   Guided Tutorial / Tour Engine (Action-required)
   - No external library
   - Locks UI via overlay + spotlight
   - User must click the highlighted area to progress
   =========================== */
(function () {
  const $ = (sel, root=document) => root.querySelector(sel);

  function getLang() {
    if (typeof currentLang !== 'undefined' && typeof currentLang === 'string') return currentLang;
    const htmlEl = document.documentElement;
    const l = (htmlEl && htmlEl.getAttribute('lang')) || 'ms';
    return l.startsWith('en') ? 'en' : 'ms';
  }

  function t(ms, en) {
    return getLang() === 'en' ? (en || ms) : (ms || en);
  }

  function isAdmin() {
    try {
      if (typeof isLoggedIn !== 'undefined' && isLoggedIn === true) {
        if (typeof userRole !== 'undefined' && userRole === 'admin') return true;
        try {
          const savedRole = localStorage.getItem('adminRole');
          if (savedRole === 'admin') return true;
        } catch {}
        return false;
      }
    } catch {}
    try {
      return localStorage.getItem('adminLoggedIn') === 'true' && localStorage.getItem('adminRole') === 'admin';
    } catch {}
    return false;
  }

  const TOUR_TOPICS = {
    student: [
      { key: 'student:makluman', title: { ms:'ðŸ“¢ Makluman', en:'ðŸ“¢ Announcements' }, sub: { ms:'Baca pengumuman sekolah.', en:'Read school announcements.' } },
      { key: 'student:clinic',    title: { ms:'ðŸ©º Tempahan Klinik', en:'ðŸ©º Clinic Booking' }, sub: { ms:'Buat temujanji klinik.', en:'Book a clinic appointment.' } },
      { key: 'student:room',      title: { ms:'ðŸ›ï¸ Tempahan Katil Sakit', en:'ðŸ›ï¸ Sick Bed Booking' }, sub: { ms:'Mohon katil sakit untuk rehat.', en:'Request a sick bed for rest.' } },
      { key: 'student:programs',  title: { ms:'ðŸ“… Program', en:'ðŸ“… Programs' }, sub: { ms:'Semak program & aktiviti.', en:'View programs & activities.' } },
      { key: 'student:achievements', title: { ms:'ðŸ† Kejayaan', en:'ðŸ† Achievements' }, sub: { ms:'Lihat pencapaian.', en:'View achievements.' } },
      { key: 'student:language',  title: { ms:'ðŸŒ Tukar Bahasa & Tema', en:'ðŸŒ Language & Theme' }, sub: { ms:'Tukar BM/EN & tema.', en:'Switch BM/EN & theme.' } },
    ],
    admin: [
      { key: 'admin:profile', title:{ ms:'ðŸ« Profil Sekolah & Chatbot', en:'ðŸ« School Profile & Chatbot' }, sub:{ ms:'Tetapan profil & link AI chatbot.', en:'Profile settings & AI chatbot link.' } },
      { key: 'admin:announcements', title:{ ms:'ðŸ“¢ Urus Makluman', en:'ðŸ“¢ Manage Announcements' }, sub:{ ms:'Tambah / kemas kini makluman.', en:'Add / update announcements.' } },
      { key: 'admin:clinic', title:{ ms:'ðŸ©º Urus Tempahan Klinik', en:'ðŸ©º Manage Clinic Bookings' }, sub:{ ms:'Semak & urus tempahan.', en:'Review & manage bookings.' } },
      { key: 'admin:room', title:{ ms:'ðŸ›ï¸ Urus Katil Sakit', en:'ðŸ›ï¸ Manage Sick Beds' }, sub:{ ms:'Semak & urus permohonan.', en:'Review & manage requests.' } },
      { key: 'admin:programs', title:{ ms:'ðŸ“… Urus Program', en:'ðŸ“… Manage Programs' }, sub:{ ms:'Tambah program sekolah.', en:'Add school programs.' } },
      { key: 'admin:achievements', title:{ ms:'ðŸ† Urus Kejayaan', en:'ðŸ† Manage Achievements' }, sub:{ ms:'Tambah rekod kejayaan.', en:'Add achievement records.' } },
      { key: 'admin:teachers', title:{ ms:'ðŸ‘¥ Guru / Pemandu', en:'ðŸ‘¥ Teachers / Drivers' }, sub:{ ms:'Urus senarai bertugas.', en:'Manage duty list.' } },
      { key: 'admin:sharing', title:{ ms:'ðŸ”— Perkongsian', en:'ðŸ”— Sharing' }, sub:{ ms:'Tambah bahan perkongsian.', en:'Add sharing materials.' } },
      { key: 'admin:guestbook', title:{ ms:'ðŸ“– Buku Pelawat', en:'ðŸ“– Guest Book' }, sub:{ ms:'Semak buku pelawat.', en:'View guest book.' } },
      { key: 'admin:language', title:{ ms:'ðŸŒ Tukar Bahasa & Tema', en:'ðŸŒ Language & Theme' }, sub:{ ms:'Tukar BM/EN & tema.', en:'Switch BM/EN & theme.' } },
    ]
  };

  const Tour = {
    active: false,
    role: null,
    topic: null,
    steps: [],
    index: 0,
    actionLock: false,
    currentRect: null,
    currentTarget: null,
    els: {},

    init() {
      this.els.tutorialBtn = $('#tutorialBtn');

      // reuse modal id/tutorialRoleModal but now it's topic picker
      this.els.topicModal = $('#tutorialRoleModal');
      this.els.closeTopicModal = $('#closeTutorialRoleModal');
      this.els.topicList = $('#tutorialTopicList');

      this.els.overlay = $('#tourOverlay');
      this.els.spotlight = $('#tourSpotlight');
      this.els.hand = $('#tourHand');
      this.els.panel = $('#tourHelperPanel');

      this.els.stepTitle = $('#tourStepTitle');
      this.els.stepText = $('#tourStepText');
      this.els.progress = $('#tourProgress');

      this.els.backBtn = $('#tourBackBtn');
      this.els.skipBtn = $('#tourSkipBtn');
      this.els.closeBtn = $('#tourCloseBtn');
      this.els.subtitle = $('#tourHelperSubtitle');

      if (this.els.tutorialBtn) {
        this.els.tutorialBtn.addEventListener('click', () => this.openTopicModal());
      }

      if (this.els.closeTopicModal) {
        this.els.closeTopicModal.addEventListener('click', () => this.closeTopicModal());
      }

      if (this.els.topicModal) {
        this.els.topicModal.addEventListener('click', (e) => {
          if (e.target === this.els.topicModal) this.closeTopicModal();
        });

        // Topic selection
        this.els.topicModal.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-tour]');
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          this.closeTopicModal();
          this.start(btn.getAttribute('data-tour'));
        });
      }

      if (this.els.backBtn) this.els.backBtn.addEventListener('click', () => this.prev());
      if (this.els.skipBtn) this.els.skipBtn.addEventListener('click', () => this.stop());
      if (this.els.closeBtn) this.els.closeBtn.addEventListener('click', () => this.stop());

      if (this.els.spotlight) {
        this.els.spotlight.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.handleActionClick();
        });
      }
      if (this.els.overlay) {
        this.els.overlay.addEventListener('click', (e) => {
          if (!this.currentRect) return;
          const x = e.clientX, y = e.clientY;
          const r = this.currentRect;
          const inside = x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
          if (!inside) return;
          e.preventDefault();
          e.stopPropagation();
          this.handleActionClick();
        });
      }

      const langToggle = $('#langToggle');
      if (langToggle) {
        langToggle.addEventListener('click', () => {
          if (this.active) setTimeout(() => this.render(), 50);
          if (this.els.topicModal && this.els.topicModal.classList.contains('active')) {
            setTimeout(() => this.renderTopicButtons(), 50);
          }
        });
      }

      window.addEventListener('resize', () => { if (this.active) this.positionToCurrent(); }, { passive: true });
      window.addEventListener('scroll',  () => { if (this.active) this.positionToCurrent(true); }, { passive: true });
    },

    openTopicModal() {
      if (!this.els.topicModal) return;
      this.renderTopicButtons();
      this.els.topicModal.classList.add('active');
      if (typeof window.updateLanguage === 'function') {
        try { window.updateLanguage(); } catch {}
      }
    },

    closeTopicModal() {
      if (!this.els.topicModal) return;
      this.els.topicModal.classList.remove('active');
    },

    renderTopicButtons() {
      if (!this.els.topicList) return;
      const adminOk = isAdmin();

      const makeGroup = (titleMs, titleEn, topics) => {
        const wrap = document.createElement('div');

        const title = document.createElement('div');
        title.className = 'tutorial-topic-group-title';
        const span = document.createElement('span');
        span.setAttribute('data-ms', titleMs);
        span.setAttribute('data-en', titleEn);
        span.textContent = t(titleMs, titleEn);
        title.appendChild(span);
        wrap.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'tutorial-topic-grid';

        topics.forEach(tp => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'submit-btn tutorial-topic-btn';
          btn.setAttribute('data-tour', tp.key);

          const main = document.createElement('span');
          main.setAttribute('data-ms', tp.title.ms);
          main.setAttribute('data-en', tp.title.en);
          main.textContent = t(tp.title.ms, tp.title.en);

          const sub = document.createElement('span');
          sub.className = 'sub';
          sub.setAttribute('data-ms', tp.sub.ms);
          sub.setAttribute('data-en', tp.sub.en);
          sub.textContent = t(tp.sub.ms, tp.sub.en);

          btn.appendChild(main);
          btn.appendChild(sub);
          grid.appendChild(btn);
        });

        wrap.appendChild(grid);
        return wrap;
      };

      this.els.topicList.innerHTML = '';
      this.els.topicList.appendChild(makeGroup('ðŸŽ’ Pelajar', 'ðŸŽ’ Student', TOUR_TOPICS.student));

      if (adminOk) {
        this.els.topicList.appendChild(makeGroup('ðŸ› ï¸ Admin', 'ðŸ› ï¸ Admin', TOUR_TOPICS.admin));
      }

      if (typeof window.updateLanguage === 'function') {
        try { window.updateLanguage(); } catch {}
      }
    },

    start(tourKey) {
      const parts = (tourKey || '').split(':');
      const role = parts[0] || 'student';
      const topic = parts[1] || 'makluman';

      if (role === 'admin' && !isAdmin()) {
        alert(t('Tutorial Admin hanya untuk akaun admin.', 'Admin tutorial is only available for admin accounts.'));
        return;
      }

      this.role = role;
      this.topic = topic;
      this.steps = this.buildSteps(role, topic);
      this.index = 0;
      this.active = true;
      this.actionLock = false;

      this.els.overlay && this.els.overlay.classList.add('active');
      this.els.spotlight && this.els.spotlight.classList.add('active');
      this.els.hand && this.els.hand.classList.add('active');
      this.els.panel && this.els.panel.classList.add('active');

      if (this.els.subtitle) this.els.subtitle.textContent = t('Pembantu Sistem', 'System Helper');

      document.body.style.overflow = 'hidden';

      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('collapsed')) sidebar.classList.remove('collapsed');

      this.render();
    },

    stop() {
      this.active = false;
      this.role = null;
      this.topic = null;
      this.steps = [];
      this.index = 0;
      this.actionLock = false;
      this.currentRect = null;
      this.currentTarget = null;


      // clear pending tour timers to prevent mismatched highlights
      try { if (this._posTimer) clearTimeout(this._posTimer); } catch {}
      try { if (this._posRetryTimer) clearTimeout(this._posRetryTimer); } catch {}
      this._posTimer = null;
      this._posRetryTimer = null;
      this._posSeq = 0;

      this.els.overlay && this.els.overlay.classList.remove('active');
      this.els.spotlight && this.els.spotlight.classList.remove('active');
      this.els.hand && this.els.hand.classList.remove('active');
      this.els.panel && this.els.panel.classList.remove('active');

      document.body.style.overflow = '';

      if (this.els.spotlight) {
        this.els.spotlight.style.width = '10px';
        this.els.spotlight.style.height = '10px';
        this.els.spotlight.style.top = '0px';
        this.els.spotlight.style.left = '0px';
      }
    },

    next() {
      if (!this.active) return;
      if (this.index >= this.steps.length - 1) { this.stop(); return; }
      this.index += 1;
      this.render();
      this.positionToCurrent();
    },

    prev() {
      if (!this.active) return;
      this.index = Math.max(0, this.index - 1);
      this.render();
      this.positionToCurrent();
    },

    handleActionClick() {
      if (!this.active || this.actionLock) return;
      const step = this.steps[this.index];
      if (!step) return;

      const el = document.querySelector(step.selector);
      if (!el) { this.next(); return; }

      this.actionLock = true;

      const action = step.action || 'click';
      try {
        if (typeof step.onAction === 'function') step.onAction(el);
        else if (action === 'click') el.click();
        else if (action === 'focus') el.focus();
      } catch {}

      const delay = typeof step.nextDelay === 'number' ? step.nextDelay : 550;
      setTimeout(() => {
        this.actionLock = false;
        this.next();
      }, delay);
    },

    buildSteps(role, topic) {
      const side = (section) => `.sidebar-item[data-section="${section}"]`;
      const clickHint = { ms: 'ðŸ‘‰ Klik kawasan yang disorot untuk teruskan.', en: 'ðŸ‘‰ Click the highlighted area to continue.' };

      const languageSteps = () => ([
        { selector:'#langToggle', title:{ms:'Tukar Bahasa', en:'Switch Language'}, text:{ms:'Tekan untuk tukar BM/EN. Semua teks akan ikut bahasa semasa.', en:'Tap to switch BM/EN. All texts follow the current language.'}, hint:clickHint, action:'click', nextDelay:550 },
        { selector:'#themeToggle', title:{ms:'Tema Gelap / Cerah', en:'Dark / Light Mode'}, text:{ms:'Tukar tema ikut keselesaan.', en:'Switch theme for comfort.'}, hint:clickHint, action:'click', nextDelay:550 },
        { selector:'#sidebarToggleBtn', title:{ms:'Kecilkan Sidebar', en:'Collapse Sidebar'}, text:{ms:'Klik untuk kecilkan / besarkan sidebar.', en:'Click to collapse / expand the sidebar.'}, hint:clickHint, action:'click', nextDelay:650 },
        { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Nak belajar benda lain? Tekan butang tutorial ini semula.', en:'Want to learn something else? Press this tutorial button again.'}, hint:clickHint, action:'none', nextDelay:350 },
      ]);

      if (role === 'student') {
        switch (topic) {
          case 'language':
            return languageSteps();

          case 'makluman':
            return [
              { selector: side('announcements'), title:{ms:'Makluman', en:'Announcements'}, text:{ms:'Masuk sini untuk baca pengumuman terbaru sekolah.', en:'Go here to read the latest school announcements.'}, hint:clickHint, action:'click', nextDelay:650 },
              { selector:'#announcementsSection .section-title', title:{ms:'Paparan Makluman', en:'Announcements Page'}, text:{ms:'Di sini anda akan nampak senarai makluman / info penting.', en:'Here you will see the list of announcements / important info.'}, hint:clickHint, action:'none', nextDelay:450 },
              { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan butang tutorial untuk pilih topik lain (contoh Tempahan Klinik).', en:'Press the tutorial button to choose another topic (e.g., Clinic Booking).'}, hint:clickHint, action:'none', nextDelay:350 },
            ];

          case 'clinic':
            return [
              { selector: side('clinic'), title:{ms:'Tempahan Klinik', en:'Clinic Booking'}, text:{ms:'Klik menu ini untuk buat temujanji klinik (jika sekolah sediakan).', en:'Click this menu to book a clinic appointment (if available).'}, hint:clickHint, action:'click', nextDelay:700 },
              { selector:'#appointmentType', title:{ms:'Jenis Temu Janji', en:'Appointment Type'}, text:{ms:'Pilih jenis temujanji.', en:'Choose appointment type.'}, hint:clickHint, action:'click', nextDelay:500 },
              { selector:'#clinicDate', title:{ms:'Tarikh', en:'Date'}, text:{ms:'Pilih tarikh temujanji.', en:'Pick an appointment date.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#clinicTime', title:{ms:'Masa', en:'Time'}, text:{ms:'Pilih masa temujanji.', en:'Pick an appointment time.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#studentName', title:{ms:'Nama Pelajar', en:'Student Name'}, text:{ms:'Isi nama pelajar.', en:'Fill in student name.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#studentCategory', title:{ms:'Kategori Pelajar', en:'Student Category'}, text:{ms:'Pilih kategori (Asrama / Pelajar Luar).', en:'Select category (Dorm / Day student).'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#className', title:{ms:'Kelas', en:'Class'}, text:{ms:'Pilih kelas.', en:'Choose class.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#symptoms', title:{ms:'Simptom', en:'Symptoms'}, text:{ms:'Tulis simptom secara ringkas.', en:'Write a brief symptom description.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#clinicBookingsList', title:{ms:'Senarai Tempahan', en:'Booking List'}, text:{ms:'Selepas hantar, status tempahan akan muncul di sini.', en:'After submission, booking status appears here.'}, hint:clickHint, action:'none', nextDelay:450 },
              { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Nak belajar Tempahan Katil Sakit pula? Tekan tutorial semula.', en:'Want to learn Sick Bed Booking next? Press tutorial again.'}, hint:clickHint, action:'none', nextDelay:350 },
            ];

          case 'room':
            return [
              { selector: side('room'), title:{ms:'Tempahan Katil Sakit', en:'Sick Bed Booking'}, text:{ms:'Klik menu ini untuk mohon katil sakit (jika perlu rehat).', en:'Click this menu to request a sick bed (if you need rest).'}, hint:clickHint, action:'click', nextDelay:700 },
              { selector:'#roomType', title:{ms:'Lokasi Katil', en:'Bed Location'}, text:{ms:'Pilih lokasi katil (asrama / bilik sakit).', en:'Select bed location (dorm / sick bay).'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#roomDate', title:{ms:'Tarikh Mula', en:'Start Date'}, text:{ms:'Pilih tarikh mula.', en:'Choose start date.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#roomStartTime', title:{ms:'Masa Mula', en:'Start Time'}, text:{ms:'Pilih masa mula.', en:'Choose start time.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#roomPurpose', title:{ms:'Sebab / Simptom', en:'Reason / Symptoms'}, text:{ms:'Nyatakan sebab atau simptom.', en:'State the reason or symptoms.'}, hint:clickHint, action:'click', nextDelay:450 },
              { selector:'#roomBookingsList', title:{ms:'Senarai Permohonan', en:'Request List'}, text:{ms:'Status permohonan akan dipaparkan di sini.', en:'Request status will show up here.'}, hint:clickHint, action:'none', nextDelay:450 },
              { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik lain.', en:'Press tutorial for other topics.'}, hint:clickHint, action:'none', nextDelay:350 },
            ];

          case 'programs':
            return [
              { selector: side('programs'), title:{ms:'Program', en:'Programs'}, text:{ms:'Klik untuk lihat program & aktiviti sekolah.', en:'Click to view school programs & activities.'}, hint:clickHint, action:'click', nextDelay:650 },
              { selector:'#programsSection .section-title', title:{ms:'Paparan Program', en:'Programs Page'}, text:{ms:'Di sini akan dipaparkan program yang diurus oleh sekolah.', en:'Programs managed by the school will appear here.'}, hint:clickHint, action:'none', nextDelay:450 },
              { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik lain.', en:'Press tutorial for other topics.'}, hint:clickHint, action:'none', nextDelay:350 },
            ];

          case 'achievements':
            return [
              { selector: side('achievements'), title:{ms:'Kejayaan', en:'Achievements'}, text:{ms:'Klik untuk lihat pencapaian dan rekod kejayaan.', en:'Click to view achievements and records.'}, hint:clickHint, action:'click', nextDelay:650 },
              { selector:'#achievementsSection .section-title', title:{ms:'Paparan Kejayaan', en:'Achievements Page'}, text:{ms:'Rekod kejayaan akan dipaparkan di sini.', en:'Achievement records will appear here.'}, hint:clickHint, action:'none', nextDelay:450 },
              { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik lain.', en:'Press tutorial for other topics.'}, hint:clickHint, action:'none', nextDelay:350 },
            ];
        }
      }

      // ADMIN topics
      switch (topic) {
        case 'language':
          return languageSteps();

        case 'profile':
          return [
            { selector: side('profile'), title:{ms:'Profil Sekolah', en:'School Profile'}, text:{ms:'Klik untuk masuk bahagian profil sekolah.', en:'Click to open the school profile section.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#chatbotUrl', title:{ms:'URL Link Chatbot', en:'Chatbot Link URL'}, text:{ms:'Masukkan URL chatbot AI sekolah. Kosongkan untuk sembunyikan butang chatbot.', en:'Enter the school AI chatbot URL. Leave empty to hide the chatbot button.'}, hint:clickHint, action:'click', nextDelay:450 },
            { selector:'#saveChatbotBtn', title:{ms:'Simpan Tetapan Chatbot', en:'Save Chatbot Settings'}, text:{ms:'Klik untuk simpan tetapan chatbot.', en:'Click to save chatbot settings.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk pilih topik admin lain.', en:'Press tutorial to choose another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'announcements':
          return [
            { selector: side('announcements'), title:{ms:'Makluman', en:'Announcements'}, text:{ms:'Klik untuk urus makluman sekolah.', en:'Click to manage school announcements.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#addAnnouncementBtn', title:{ms:'Tambah Makluman', en:'Add Announcement'}, text:{ms:'Klik untuk tambah makluman baharu.', en:'Click to add a new announcement.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#cancelAnnouncementBtn', title:{ms:'Tutup Borang', en:'Close Form'}, text:{ms:'Ini contoh borang tambah makluman. Kita tutup semula.', en:'This is the add announcement form. Letâ€™s close it.'}, hint:clickHint, action:'click', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'clinic':
          return [
            { selector: side('clinic'), title:{ms:'Tempahan Klinik', en:'Clinic Booking'}, text:{ms:'Klik untuk lihat panel tempahan klinik.', en:'Click to view clinic bookings panel.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#adminPanelClinic h3', title:{ms:'Panel Pentadbir Klinik', en:'Clinic Admin Panel'}, text:{ms:'Di sini admin boleh semak senarai tempahan dan tindakan yang perlu.', en:'Here admins can review bookings and required actions.'}, hint:clickHint, action:'none', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'room':
          return [
            { selector: side('room'), title:{ms:'Tempahan Katil Sakit', en:'Sick Bed Booking'}, text:{ms:'Klik untuk lihat panel tempahan katil sakit.', en:'Click to view sick bed bookings panel.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#adminPanelRoom h3', title:{ms:'Panel Pentadbir Katil Sakit', en:'Sick Bed Admin Panel'}, text:{ms:'Admin boleh semak permohonan katil sakit di sini.', en:'Admins can review sick bed requests here.'}, hint:clickHint, action:'none', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'programs':
          return [
            { selector: side('programs'), title:{ms:'Program', en:'Programs'}, text:{ms:'Klik untuk urus program sekolah.', en:'Click to manage school programs.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#addProgramBtn', title:{ms:'Tambah Program', en:'Add Program'}, text:{ms:'Klik untuk tambah program baharu.', en:'Click to add a new program.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#cancelProgramBtn', title:{ms:'Tutup Borang', en:'Close Form'}, text:{ms:'Ini contoh borang tambah program. Kita tutup semula.', en:'This is the add program form. Letâ€™s close it.'}, hint:clickHint, action:'click', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'achievements':
          return [
            { selector: side('achievements'), title:{ms:'Kejayaan', en:'Achievements'}, text:{ms:'Klik untuk urus rekod kejayaan.', en:'Click to manage achievement records.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#addAchievementBtn', title:{ms:'Tambah Kejayaan', en:'Add Achievement'}, text:{ms:'Klik untuk tambah rekod kejayaan baharu.', en:'Click to add a new achievement record.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#cancelAchievementBtn', title:{ms:'Tutup Borang', en:'Close Form'}, text:{ms:'Ini contoh borang tambah kejayaan. Kita tutup semula.', en:'This is the add achievement form. Letâ€™s close it.'}, hint:clickHint, action:'click', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'teachers':
          return [
            { selector: side('teachers'), title:{ms:'Guru / Pemandu', en:'Teachers / Drivers'}, text:{ms:'Klik untuk urus senarai guru/pemandu bertugas.', en:'Click to manage teachers/drivers on duty.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#teachersSection .section-title', title:{ms:'Paparan Bertugas', en:'Duty Page'}, text:{ms:'Di sini admin boleh tambah/urus maklumat bertugas (ikut fungsi sistem).', en:'Here admins can add/manage duty info (depending on system features).'}, hint:clickHint, action:'none', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'sharing':
          return [
            { selector: side('sharing'), title:{ms:'Perkongsian', en:'Sharing'}, text:{ms:'Klik untuk urus bahan perkongsian.', en:'Click to manage sharing materials.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#sharingSection .section-title', title:{ms:'Paparan Perkongsian', en:'Sharing Page'}, text:{ms:'Bahan perkongsian yang admin tambah akan dipaparkan di sini.', en:'Sharing items added by admins will appear here.'}, hint:clickHint, action:'none', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];

        case 'guestbook':
          return [
            { selector: side('guestbook'), title:{ms:'Buku Pelawat', en:'Guest Book'}, text:{ms:'Klik untuk buka buku pelawat.', en:'Click to open the guest book.'}, hint:clickHint, action:'click', nextDelay:650 },
            { selector:'#guestbookSection .section-title', title:{ms:'Paparan Buku Pelawat', en:'Guest Book Page'}, text:{ms:'Jika fungsi tersedia, rekod pelawat akan dipaparkan di sini.', en:'If available, visitor records will appear here.'}, hint:clickHint, action:'none', nextDelay:450 },
            { selector:'#tutorialBtn', title:{ms:'Pilih Topik Lain', en:'Pick Another Topic'}, text:{ms:'Tekan tutorial untuk topik admin lain.', en:'Press tutorial for another admin topic.'}, hint:clickHint, action:'none', nextDelay:350 },
          ];
      }

      // fallback
      return languageSteps();
    },

    render() {
      if (!this.active) return;
      const step = this.steps[this.index];
      if (!step) return;

      const title = t(step.title && step.title.ms, step.title && step.title.en);
      const text  = t(step.text && step.text.ms,  step.text && step.text.en);
      const hint  = step.hint ? t(step.hint.ms, step.hint.en) : t('ðŸ‘‰ Klik kawasan yang disorot untuk teruskan.', 'ðŸ‘‰ Click the highlighted area to continue.');

      if (this.els.stepTitle) this.els.stepTitle.textContent = title || '';
      if (this.els.stepText)  this.els.stepText.textContent  = (text ? (text + "\n\n" + hint) : hint);

      if (this.els.progress) {
        this.els.progress.textContent = t(
          `Langkah ${this.index + 1} / ${this.steps.length}`,
          `Step ${this.index + 1} / ${this.steps.length}`
        );
      }

      if (this.els.backBtn) {
        this.els.backBtn.textContent = t('Kembali', 'Back');
        this.els.backBtn.disabled = this.index === 0;
      }
      if (this.els.skipBtn) this.els.skipBtn.textContent = t('Langkau', 'Skip');

      setTimeout(() => this.positionToCurrent(false), 0);
    },

    positionToCurrent(isScrollTick = false) {
      if (!this.active) return;
      const step = this.steps[this.index];
      if (!step) return;

      // Prevent stale async positioning from older steps overriding the current highlight.
      this._posSeq = (this._posSeq || 0) + 1;
      const seq = this._posSeq;
      const selector = step.selector;

      try { if (this._posTimer) clearTimeout(this._posTimer); } catch {}
      try { if (this._posRetryTimer) clearTimeout(this._posRetryTimer); } catch {}
      this._posTimer = null;
      this._posRetryTimer = null;

      const stillCurrent = () => {
        if (!this.active) return false;
        if (seq !== this._posSeq) return false;
        const s = this.steps[this.index];
        if (!s) return false;
        return s.selector === selector;
      };

      const tryFind = (attempt = 0) => {
        if (!stillCurrent()) return;

        const el = document.querySelector(selector);

        // If the element isn't ready yet (e.g. panel just opened), retry a few times before skipping.
        if (!el) {
          if (!isScrollTick && attempt < 12) {
            this._posRetryTimer = setTimeout(() => tryFind(attempt + 1), 120);
          } else {
            if (!isScrollTick) this.next();
          }
          return;
        }

        this.currentTarget = el;

        if (!isScrollTick) {
          try { const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; el.scrollIntoView({ behavior: (reduce ? 'auto' : 'smooth'), block: 'center', inline: 'center' }); } catch {}
        }

        const applyRect = (rect) => {
          const pad = 10;

          const w = Math.max(40, rect.width + pad * 2);
          const h = Math.max(40, rect.height + pad * 2);

          const top = Math.max(12, rect.top - pad);
          const left = Math.max(12, rect.left - pad);

          this.currentRect = { left, top, right: left + w, bottom: top + h };

          if (this.els.spotlight) {
            this.els.spotlight.style.transition = (isScrollTick ? 'all 0.06s linear' : 'all 0.22s ease');
            this.els.spotlight.style.top = top + 'px';
            this.els.spotlight.style.left = left + 'px';
            this.els.spotlight.style.width = w + 'px';
            this.els.spotlight.style.height = h + 'px';
            this.els.spotlight.style.borderRadius = Math.min(18, Math.max(12, Math.min(w, h) * 0.25)) + 'px';
            this.els.spotlight.title = '';
          }

          if (this.els.hand) {
            const vw = window.innerWidth;
            const vh = window.innerHeight;

            let hx = left - 44;
            let hy = top + h * 0.5 - 18;

            if (hx < 8) hx = left + w + 12;

            hx = Math.min(Math.max(8, hx), vw - 40);
            hy = Math.min(Math.max(8, hy), vh - 44);

            this.els.hand.style.left = hx + 'px';
            this.els.hand.style.top = hy + 'px';

            // Direction: if hand is on the right side of target, point left ðŸ‘ˆ, else ðŸ‘‰
            this.els.hand.textContent = (hx > left) ? 'ðŸ‘ˆ' : 'ðŸ‘‰';
          }
        };

        const computeStable = (attempt = 0, last = null, stable = 0) => {
          if (!stillCurrent()) return;
          if (this.currentTarget !== el) return;

          const rect = el.getBoundingClientRect();
          const vw = window.innerWidth;
          const vh = window.innerHeight;

          const visible = rect.width > 0 && rect.height > 0 &&
                          rect.bottom > 0 && rect.top < vh &&
                          rect.right > 0 && rect.left < vw;

          let isStable = false;
          if (last) {
            const diff = Math.abs(rect.top - last.top) +
                         Math.abs(rect.left - last.left) +
                         Math.abs(rect.width - last.width) +
                         Math.abs(rect.height - last.height);
            isStable = diff < 0.8;
          }

          stable = isStable ? (stable + 1) : 0;

          // If layout/scroll isn't settled yet, retry a bit. This prevents the spotlight
          // from locking onto the wrong place when the container is still scrolling.
          if ((!visible || (!isScrollTick && stable < 2)) && attempt < 25) {
            this._posTimer = setTimeout(() => computeStable(
              attempt + 1,
              { top: rect.top, left: rect.left, width: rect.width, height: rect.height },
              stable
            ), 60);
            return;
          }

          applyRect(rect);
        };

        // Start immediate positioning; retries will handle late layout / scrolling.
        computeStable(0, null, 0);
      };

      tryFind(0);
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => Tour.init());
  } else {
    Tour.init();
  }
})();;
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a56fdcca6992203',t:'MTc2NDMwMjc3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <!-- Announcement Modal (Baca Lagi) -->
  <div class="modal-overlay" id="announcementModal">
    <div class="modal-content">
      <button class="modal-close" id="closeAnnouncementModal" type="button" aria-label="Tutup">Ã—</button>
      <div id="announcementModalBody"></div>
    </div>
  </div>


</body>
</html>